# æ„å»º Realm åº”ç”¨

æœ¬æ•™ç¨‹å°†æŒ‡å¯¼ä½ æ·±å…¥ç†è§£ Realm çš„éš”ç¦»æœºåˆ¶ï¼Œå¹¶æ„å»ºä¸€ä¸ªå¤š Realm çš„åº”ç”¨ç¤ºä¾‹ã€‚

---

## æ•™ç¨‹ç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ¬æ•™ç¨‹å®Œæˆåä½ å°†å­¦ä¼š                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  âœ… ç†è§£ Realm çš„æ ¸å¿ƒæ¦‚å¿µå’Œè®¾è®¡ç›®çš„                                  â”‚
â”‚  âœ… éªŒè¯ Realm çš„å¼ºåˆ¶éš”ç¦»æœºåˆ¶                                        â”‚
â”‚  âœ… å®ç° Realm çš„åŠ å…¥ã€ç¦»å¼€å’Œåˆ‡æ¢                                    â”‚
â”‚  âœ… æ„å»ºå¤š Realm åœºæ™¯çš„åº”ç”¨                                          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Realm æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Realm æ ¸å¿ƒæ¦‚å¿µ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ä»€ä¹ˆæ˜¯ Realmï¼Ÿ                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚  Realm æ˜¯ DeP2P çš„ä¸šåŠ¡éš”ç¦»å•å…ƒï¼Œç±»ä¼¼äº"è™šæ‹Ÿç½‘ç»œ"æˆ–"èŠå¤©å®¤"ã€‚                 â”‚
â”‚  åŒä¸€ Realm å†…çš„èŠ‚ç‚¹å¯ä»¥äº’ç›¸å‘ç°å’Œé€šä¿¡ï¼Œä¸åŒ Realm ä¹‹é—´å®Œå…¨éš”ç¦»ã€‚            â”‚
â”‚                                                                              â”‚
â”‚  ä¸ºä»€ä¹ˆéœ€è¦ Realmï¼Ÿ                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚  â€¢ ä¸šåŠ¡éš”ç¦»ï¼šä¸åŒåº”ç”¨/ä¸šåŠ¡ä½¿ç”¨ä¸åŒ Realmï¼Œé¿å…äº’ç›¸å¹²æ‰°                       â”‚
â”‚  â€¢ èŠ‚ç‚¹å‘ç°ï¼šåªå‘ç°åŒ Realm çš„èŠ‚ç‚¹ï¼Œå‡å°‘ç½‘ç»œå™ªéŸ³                             â”‚
â”‚  â€¢ è®¿é—®æ§åˆ¶ï¼šå¯ä»¥é€šè¿‡ RealmAuth å®ç°å‡†å…¥æ§åˆ¶                                 â”‚
â”‚                                                                              â”‚
â”‚  ä¸¥æ ¼å• Realm è§„åˆ™                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚  â€¢ èŠ‚ç‚¹åŒä¸€æ—¶é—´åªèƒ½å±äºä¸€ä¸ª Realm                                            â”‚
â”‚  â€¢ å¿…é¡»å…ˆ JoinRealm æ‰èƒ½ä½¿ç”¨ä¸šåŠ¡ API                                        â”‚
â”‚  â€¢ æœªåŠ å…¥ Realm è°ƒç”¨ä¸šåŠ¡ API ä¼šè¿”å› ErrNotMember                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Realm éš”ç¦»æ¨¡å‹

```mermaid
flowchart TB
    subgraph Infrastructure [å…±äº«åŸºç¡€è®¾æ–½ - Layer 1]
        DHT["DHT è·¯ç”±"]
        Relay["Relay ä¸­ç»§"]
        NAT["NAT ç©¿é€"]
    end
    
    subgraph RealmA [Realm A - æ¸¸æˆ]
        A1["ç©å®¶ 1"]
        A2["ç©å®¶ 2"]
        A3["ç©å®¶ 3"]
    end
    
    subgraph RealmB [Realm B - èŠå¤©]
        B1["ç”¨æˆ· 1"]
        B2["ç”¨æˆ· 2"]
    end
    
    subgraph RealmC [Realm C - å­˜å‚¨]
        C1["èŠ‚ç‚¹ 1"]
        C2["èŠ‚ç‚¹ 2"]
    end
    
    Infrastructure --> RealmA
    Infrastructure --> RealmB
    Infrastructure --> RealmC
    
    A1 <-->|"å¯é€šä¿¡"| A2
    A2 <-->|"å¯é€šä¿¡"| A3
    
    B1 <-->|"å¯é€šä¿¡"| B2
    
    C1 <-->|"å¯é€šä¿¡"| C2
    
    A1 -.-x|"éš”ç¦»"| B1
    B1 -.-x|"éš”ç¦»"| C1
```

---

## æ­¥éª¤ 1ï¼šéªŒè¯ Realm å¼ºåˆ¶éš”ç¦»

é¦–å…ˆï¼Œè®©æˆ‘ä»¬éªŒè¯ Realm çš„å¼ºåˆ¶éš”ç¦»æœºåˆ¶ã€‚

åˆ›å»ºæ–‡ä»¶ `realm_demo/main.go`ï¼š

```go
package main

import (
    "context"
    "fmt"
    "log"
    "time"

    "github.com/dep2p/go-dep2p"
    "github.com/dep2p/go-dep2p/pkg/interfaces/endpoint"
    "github.com/dep2p/go-dep2p/pkg/types"
)

func main() {
    fmt.Println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    fmt.Println("â•‘      DeP2P Realm å¼ºåˆ¶éš”ç¦»æ¼”ç¤º                 â•‘")
    fmt.Println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    fmt.Println()

    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()

    // ========================================
    // Step 1: åˆ›å»ºèŠ‚ç‚¹
    // ========================================
    fmt.Println("â”â”â” Step 1: åˆ›å»ºèŠ‚ç‚¹ â”â”â”")
    node, err := dep2p.StartNode(ctx,
        dep2p.WithPreset(dep2p.PresetDesktop),
    )
    if err != nil {
        log.Fatalf("å¯åŠ¨èŠ‚ç‚¹å¤±è´¥: %v", err)
    }
    defer node.Close()

    fmt.Printf("âœ… èŠ‚ç‚¹å·²åˆ›å»º\n")
    fmt.Printf("   èŠ‚ç‚¹ ID: %s\n", node.ID().ShortString())
    fmt.Println()

    // ========================================
    // Step 2: éªŒè¯æœªåŠ å…¥ Realm æ—¶çš„è¡Œä¸º
    // ========================================
    fmt.Println("â”â”â” Step 2: éªŒè¯å¼ºåˆ¶éš”ç¦» â”â”â”")
    fmt.Println("æœª JoinRealm æ—¶ï¼Œä¸šåŠ¡ API å¿…é¡»è¿”å› ErrNotMember")
    fmt.Println()

    // åˆ›å»ºä¸€ä¸ªç›®æ ‡èŠ‚ç‚¹ç”¨äºæµ‹è¯•
    targetNode, _ := dep2p.StartNode(ctx, dep2p.WithPreset(dep2p.PresetDesktop))
    defer targetNode.Close()
    targetID := targetNode.ID()

    // æµ‹è¯• Send
    fmt.Print("å°è¯• Send... ")
    err = node.Send(ctx, targetID, "/test/1.0.0", []byte("hello"))
    if err == endpoint.ErrNotMember {
        fmt.Println("âœ… æ­£ç¡®è¿”å› ErrNotMember")
    } else if err != nil {
        fmt.Printf("âš ï¸  è¿”å›å…¶ä»–é”™è¯¯: %v\n", err)
    } else {
        fmt.Println("âŒ æœªè¿”å›é”™è¯¯ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰")
    }

    // æµ‹è¯• Publish
    fmt.Print("å°è¯• Publish... ")
    err = node.Publish(ctx, "test-topic", []byte("message"))
    if err == endpoint.ErrNotMember {
        fmt.Println("âœ… æ­£ç¡®è¿”å› ErrNotMember")
    } else if err != nil {
        fmt.Printf("âš ï¸  è¿”å›å…¶ä»–é”™è¯¯: %v\n", err)
    } else {
        fmt.Println("âŒ æœªè¿”å›é”™è¯¯ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰")
    }
    fmt.Println()

    // ========================================
    // Step 3: åŠ å…¥ Realm
    // ========================================
    fmt.Println("â”â”â” Step 3: åŠ å…¥ Realm â”â”â”")
    realmID := types.RealmID("demo-realm")
    
    fmt.Printf("åŠ å…¥ Realm: %s\n", realmID)
    if err := node.Realm().JoinRealm(ctx, realmID); err != nil {
        log.Fatalf("åŠ å…¥ Realm å¤±è´¥: %v", err)
    }
    fmt.Printf("âœ… å·²åŠ å…¥ Realm: %s\n", node.Realm().CurrentRealm())
    fmt.Println()

    // ========================================
    // Step 4: éªŒè¯åŠ å…¥åçš„è¡Œä¸º
    // ========================================
    fmt.Println("â”â”â” Step 4: éªŒè¯åŠ å…¥åçš„è¡Œä¸º â”â”â”")
    
    // ç›®æ ‡èŠ‚ç‚¹ä¹Ÿéœ€è¦åŠ å…¥åŒä¸€ Realm
    targetNode.Realm().JoinRealm(ctx, realmID)
    
    fmt.Print("å°è¯• Send... ")
    err = node.Send(ctx, targetID, "/test/1.0.0", []byte("hello"))
    if err == nil {
        fmt.Println("âœ… å‘é€æˆåŠŸï¼ˆæˆ–æ­£åœ¨å°è¯•è¿æ¥ï¼‰")
    } else if err != endpoint.ErrNotMember {
        fmt.Printf("â„¹ï¸  è¿”å›: %vï¼ˆé ErrNotMemberï¼Œå¯èƒ½æ˜¯è¿æ¥é—®é¢˜ï¼‰\n", err)
    } else {
        fmt.Println("âŒ è¿”å› ErrNotMemberï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰")
    }
    fmt.Println()

    // ========================================
    // Step 5: éªŒè¯ä¸¥æ ¼å• Realm
    // ========================================
    fmt.Println("â”â”â” Step 5: éªŒè¯ä¸¥æ ¼å• Realm â”â”â”")
    fmt.Println("å°è¯•åŠ å…¥ç¬¬äºŒä¸ª Realmï¼ˆåº”è¯¥å¤±è´¥ï¼‰...")
    
    err = node.Realm().JoinRealm(ctx, types.RealmID("another-realm"))
    if err != nil {
        fmt.Printf("âœ… æ­£ç¡®æ‹’ç»: %v\n", err)
    } else {
        fmt.Println("âŒ æœªæ‹’ç»ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰")
    }
    fmt.Println()

    // ========================================
    // Step 6: åˆ‡æ¢ Realm
    // ========================================
    fmt.Println("â”â”â” Step 6: åˆ‡æ¢ Realm â”â”â”")
    fmt.Printf("å½“å‰ Realm: %s\n", node.Realm().CurrentRealm())
    
    fmt.Println("å…ˆç¦»å¼€å½“å‰ Realm...")
    if err := node.Realm().LeaveRealm(ctx); err != nil {
        fmt.Printf("ç¦»å¼€å¤±è´¥: %v\n", err)
    } else {
        fmt.Println("âœ… å·²ç¦»å¼€ Realm")
    }
    
    newRealmID := types.RealmID("new-realm")
    fmt.Printf("åŠ å…¥æ–° Realm: %s\n", newRealmID)
    if err := node.Realm().JoinRealm(ctx, newRealmID); err != nil {
        fmt.Printf("åŠ å…¥å¤±è´¥: %v\n", err)
    } else {
        fmt.Printf("âœ… å·²åŠ å…¥æ–° Realm: %s\n", node.Realm().CurrentRealm())
    }
    fmt.Println()

    // ========================================
    // å®Œæˆ
    // ========================================
    fmt.Println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    fmt.Println("ğŸ‰ Realm æ¼”ç¤ºå®Œæˆï¼")
    fmt.Println()
    fmt.Println("å…³é”®è¦ç‚¹:")
    fmt.Println("  1. æœªåŠ å…¥ Realm â†’ ä¸šåŠ¡ API è¿”å› ErrNotMember")
    fmt.Println("  2. ä¸¥æ ¼å• Realm â†’ å¿…é¡»å…ˆç¦»å¼€å†åŠ å…¥æ–°çš„")
    fmt.Println("  3. Realm éš”ç¦» â†’ ä¸åŒ Realm çš„èŠ‚ç‚¹æ— æ³•é€šä¿¡")
    fmt.Println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
}
```

---

## æ­¥éª¤ 2ï¼šå¤š Realm éš”ç¦»éªŒè¯

åˆ›å»ºæ–‡ä»¶ `multi_realm/main.go`ï¼š

```go
package main

import (
    "context"
    "fmt"
    "log"
    "sync"
    "time"

    "github.com/dep2p/go-dep2p"
    "github.com/dep2p/go-dep2p/pkg/types"
)

const testProtocol = "/realm-test/1.0.0"

func main() {
    fmt.Println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    fmt.Println("â•‘      DeP2P å¤š Realm éš”ç¦»éªŒè¯                  â•‘")
    fmt.Println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    fmt.Println()

    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()

    // ========================================
    // åˆ›å»ºä¸‰ä¸ªèŠ‚ç‚¹
    // ========================================
    fmt.Println("åˆ›å»ºä¸‰ä¸ªèŠ‚ç‚¹...")
    
    nodeA, _ := dep2p.StartNode(ctx, dep2p.WithPreset(dep2p.PresetDesktop))
    nodeB, _ := dep2p.StartNode(ctx, dep2p.WithPreset(dep2p.PresetDesktop))
    nodeC, _ := dep2p.StartNode(ctx, dep2p.WithPreset(dep2p.PresetDesktop))
    defer nodeA.Close()
    defer nodeB.Close()
    defer nodeC.Close()

    fmt.Printf("  Node A: %s\n", nodeA.ID().ShortString())
    fmt.Printf("  Node B: %s\n", nodeB.ID().ShortString())
    fmt.Printf("  Node C: %s\n", nodeC.ID().ShortString())
    fmt.Println()

    // ========================================
    // åˆ†é…åˆ°ä¸åŒ Realm
    // ========================================
    fmt.Println("åˆ†é…èŠ‚ç‚¹åˆ°ä¸åŒ Realm:")
    
    realmAlpha := types.RealmID("realm-alpha")
    realmBeta := types.RealmID("realm-beta")
    
    nodeA.Realm().JoinRealm(ctx, realmAlpha)
    nodeB.Realm().JoinRealm(ctx, realmAlpha)
    nodeC.Realm().JoinRealm(ctx, realmBeta)
    
    fmt.Printf("  Node A â†’ %s\n", realmAlpha)
    fmt.Printf("  Node B â†’ %s\n", realmAlpha)
    fmt.Printf("  Node C â†’ %s\n", realmBeta)
    fmt.Println()

    // ========================================
    // æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
    // ========================================
    var received sync.Map
    
    registerHandler := func(node dep2p.Node, name string) {
        node.Endpoint().SetProtocolHandler(testProtocol, func(stream dep2p.Stream) {
            defer stream.Close()
            buf := make([]byte, 256)
            n, _ := stream.Read(buf)
            received.Store(name, string(buf[:n]))
            fmt.Printf("  [%s] æ”¶åˆ°æ¶ˆæ¯: %s\n", name, string(buf[:n]))
        })
    }
    
    registerHandler(nodeA, "A")
    registerHandler(nodeB, "B")
    registerHandler(nodeC, "C")

    // ========================================
    // æµ‹è¯•åŒ Realm é€šä¿¡
    // ========================================
    fmt.Println("â”â”â” æµ‹è¯• 1: åŒ Realm é€šä¿¡ (A â†’ B) â”â”â”")
    fmt.Println("Node A å’Œ Node B åœ¨åŒä¸€ Realm (realm-alpha)")
    fmt.Println()

    // ç­‰å¾… mDNS å‘ç°
    time.Sleep(2 * time.Second)
    
    conn, err := nodeA.Connect(ctx, nodeB.ID())
    if err != nil {
        fmt.Printf("  è¿æ¥å¤±è´¥: %v\n", err)
    } else {
        stream, err := conn.OpenStream(ctx, testProtocol)
        if err != nil {
            fmt.Printf("  æ‰“å¼€æµå¤±è´¥: %v\n", err)
        } else {
            message := "Hello from A to B (same realm)"
            stream.Write([]byte(message))
            fmt.Printf("  [A] å‘é€æ¶ˆæ¯: %s\n", message)
            stream.Close()
        }
    }
    
    time.Sleep(500 * time.Millisecond)
    if _, ok := received.Load("B"); ok {
        fmt.Println("  âœ… åŒ Realm é€šä¿¡æˆåŠŸ")
    } else {
        fmt.Println("  âš ï¸  æ¶ˆæ¯å¯èƒ½å»¶è¿Ÿæˆ–éœ€è¦æ›´å¤šæ—¶é—´")
    }
    fmt.Println()

    // ========================================
    // æµ‹è¯•è·¨ Realm é€šä¿¡ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
    // ========================================
    fmt.Println("â”â”â” æµ‹è¯• 2: è·¨ Realm é€šä¿¡ (A â†’ C) â”â”â”")
    fmt.Println("Node A åœ¨ realm-alphaï¼ŒNode C åœ¨ realm-beta")
    fmt.Println()

    // å°è¯•è¿æ¥ä¸åŒ Realm çš„èŠ‚ç‚¹
    _, err = nodeA.Connect(ctx, nodeC.ID())
    if err != nil {
        fmt.Printf("  âœ… æ­£ç¡®ï¼šè·¨ Realm è¿æ¥è¢«é˜»æ­¢æˆ–è¶…æ—¶\n")
        fmt.Printf("     é”™è¯¯: %v\n", err)
    } else {
        fmt.Println("  âš ï¸  è¿æ¥æˆåŠŸï¼Œä½†ä¸šåŠ¡æ¶ˆæ¯åº”è¢«éš”ç¦»")
    }
    fmt.Println()

    // ========================================
    // å®Œæˆ
    // ========================================
    fmt.Println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    fmt.Println("ğŸ‰ å¤š Realm éš”ç¦»éªŒè¯å®Œæˆï¼")
    fmt.Println()
    fmt.Println("éªŒè¯ç»“æœ:")
    fmt.Println("  âœ… åŒ Realm èŠ‚ç‚¹å¯ä»¥é€šä¿¡")
    fmt.Println("  âœ… ä¸åŒ Realm èŠ‚ç‚¹è¢«éš”ç¦»")
    fmt.Println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
}
```

---

## æ­¥éª¤ 3ï¼šå®Œæ•´çš„ Realm åº”ç”¨ç¤ºä¾‹

åˆ›å»ºæ–‡ä»¶ `realm_app/main.go`ï¼š

```go
package main

import (
    "bufio"
    "context"
    "fmt"
    "log"
    "os"
    "os/signal"
    "strings"
    "syscall"

    "github.com/dep2p/go-dep2p"
    "github.com/dep2p/go-dep2p/pkg/types"
)

const chatProtocol = "/realm-chat/1.0.0"

func main() {
    fmt.Println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    fmt.Println("â•‘      DeP2P Realm åº”ç”¨ - å¤šæˆ¿é—´èŠå¤©            â•‘")
    fmt.Println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    fmt.Println()

    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()

    signalCh := make(chan os.Signal, 1)
    signal.Notify(signalCh, syscall.SIGINT, syscall.SIGTERM)
    go func() {
        <-signalCh
        fmt.Println("\nå†è§!")
        cancel()
    }()

    // åˆ›å»ºèŠ‚ç‚¹
    node, err := dep2p.StartNode(ctx, dep2p.WithPreset(dep2p.PresetDesktop))
    if err != nil {
        log.Fatalf("å¯åŠ¨å¤±è´¥: %v", err)
    }
    defer node.Close()

    fmt.Printf("èŠ‚ç‚¹ ID: %s\n", node.ID().ShortString())
    fmt.Println()

    // æ‰“å°å¸®åŠ©ä¿¡æ¯
    printHelp()

    // å¼€å§‹å‘½ä»¤å¾ªç¯
    reader := bufio.NewReader(os.Stdin)
    for {
        select {
        case <-ctx.Done():
            return
        default:
        }

        fmt.Print("> ")
        input, err := reader.ReadString('\n')
        if err != nil {
            continue
        }
        input = strings.TrimSpace(input)
        
        if input == "" {
            continue
        }

        parts := strings.Fields(input)
        cmd := parts[0]

        switch cmd {
        case "/join":
            if len(parts) < 2 {
                fmt.Println("ç”¨æ³•: /join <æˆ¿é—´å>")
                continue
            }
            roomName := parts[1]
            
            // å¦‚æœå·²åœ¨æŸä¸ªæˆ¿é—´ï¼Œå…ˆç¦»å¼€
            if node.Realm().CurrentRealm() != "" {
                fmt.Printf("ç¦»å¼€æˆ¿é—´: %s\n", node.Realm().CurrentRealm())
                node.Realm().LeaveRealm(ctx)
            }
            
            realmID := types.RealmID(roomName)
            if err := node.Realm().JoinRealm(ctx, realmID); err != nil {
                fmt.Printf("åŠ å…¥å¤±è´¥: %v\n", err)
            } else {
                fmt.Printf("âœ… å·²åŠ å…¥æˆ¿é—´: %s\n", roomName)
            }

        case "/leave":
            if node.Realm().CurrentRealm() == "" {
                fmt.Println("ä½ æ²¡æœ‰åœ¨ä»»ä½•æˆ¿é—´")
                continue
            }
            roomName := node.Realm().CurrentRealm()
            if err := node.Realm().LeaveRealm(ctx); err != nil {
                fmt.Printf("ç¦»å¼€å¤±è´¥: %v\n", err)
            } else {
                fmt.Printf("å·²ç¦»å¼€æˆ¿é—´: %s\n", roomName)
            }

        case "/room":
            current := node.Realm().CurrentRealm()
            if current == "" {
                fmt.Println("å½“å‰ä¸åœ¨ä»»ä½•æˆ¿é—´")
            } else {
                fmt.Printf("å½“å‰æˆ¿é—´: %s\n", current)
            }

        case "/help":
            printHelp()

        case "/quit", "/exit":
            return

        default:
            // å‘é€æ¶ˆæ¯åˆ°å½“å‰æˆ¿é—´
            if node.Realm().CurrentRealm() == "" {
                fmt.Println("è¯·å…ˆåŠ å…¥ä¸€ä¸ªæˆ¿é—´: /join <æˆ¿é—´å>")
                continue
            }
            
            // è¿™é‡Œå¯ä»¥å®ç°æ¶ˆæ¯å¹¿æ’­é€»è¾‘
            fmt.Printf("[%s] %s\n", node.Realm().CurrentRealm(), input)
        }
    }
}

func printHelp() {
    fmt.Println("å‘½ä»¤:")
    fmt.Println("  /join <æˆ¿é—´å>  - åŠ å…¥æˆ¿é—´ï¼ˆRealmï¼‰")
    fmt.Println("  /leave          - ç¦»å¼€å½“å‰æˆ¿é—´")
    fmt.Println("  /room           - æŸ¥çœ‹å½“å‰æˆ¿é—´")
    fmt.Println("  /help           - æ˜¾ç¤ºå¸®åŠ©")
    fmt.Println("  /quit           - é€€å‡º")
    fmt.Println()
    fmt.Println("ç›´æ¥è¾“å…¥æ¶ˆæ¯å‘é€åˆ°å½“å‰æˆ¿é—´")
    fmt.Println()
}
```

---

## é¢„æœŸè¾“å‡º

### Realm å¼ºåˆ¶éš”ç¦»æ¼”ç¤º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      DeP2P Realm å¼ºåˆ¶éš”ç¦»æ¼”ç¤º                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â” Step 1: åˆ›å»ºèŠ‚ç‚¹ â”â”â”
âœ… èŠ‚ç‚¹å·²åˆ›å»º
   èŠ‚ç‚¹ ID: 5Q2STW...

â”â”â” Step 2: éªŒè¯å¼ºåˆ¶éš”ç¦» â”â”â”
æœª JoinRealm æ—¶ï¼Œä¸šåŠ¡ API å¿…é¡»è¿”å› ErrNotMember

å°è¯• Send... âœ… æ­£ç¡®è¿”å› ErrNotMember
å°è¯• Publish... âœ… æ­£ç¡®è¿”å› ErrNotMember

â”â”â” Step 3: åŠ å…¥ Realm â”â”â”
åŠ å…¥ Realm: demo-realm
âœ… å·²åŠ å…¥ Realm: demo-realm

â”â”â” Step 4: éªŒè¯åŠ å…¥åçš„è¡Œä¸º â”â”â”
å°è¯• Send... âœ… å‘é€æˆåŠŸï¼ˆæˆ–æ­£åœ¨å°è¯•è¿æ¥ï¼‰

â”â”â” Step 5: éªŒè¯ä¸¥æ ¼å• Realm â”â”â”
å°è¯•åŠ å…¥ç¬¬äºŒä¸ª Realmï¼ˆåº”è¯¥å¤±è´¥ï¼‰...
âœ… æ­£ç¡®æ‹’ç»: already joined a realm

â”â”â” Step 6: åˆ‡æ¢ Realm â”â”â”
å½“å‰ Realm: demo-realm
å…ˆç¦»å¼€å½“å‰ Realm...
âœ… å·²ç¦»å¼€ Realm
åŠ å…¥æ–° Realm: new-realm
âœ… å·²åŠ å…¥æ–° Realm: new-realm

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ‰ Realm æ¼”ç¤ºå®Œæˆï¼

å…³é”®è¦ç‚¹:
  1. æœªåŠ å…¥ Realm â†’ ä¸šåŠ¡ API è¿”å› ErrNotMember
  2. ä¸¥æ ¼å• Realm â†’ å¿…é¡»å…ˆç¦»å¼€å†åŠ å…¥æ–°çš„
  3. Realm éš”ç¦» â†’ ä¸åŒ Realm çš„èŠ‚ç‚¹æ— æ³•é€šä¿¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Realm æœ€ä½³å®è·µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Realm æœ€ä½³å®è·µ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. å‘½åè§„èŒƒ                                                                 â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚     â€¢ ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼šmyapp-production, myapp-staging                     â”‚
â”‚     â€¢ é¿å…ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦                                                       â”‚
â”‚     â€¢ è€ƒè™‘ç‰ˆæœ¬ï¼šmyapp-v1, myapp-v2                                          â”‚
â”‚                                                                              â”‚
â”‚  2. ç”Ÿå‘½å‘¨æœŸç®¡ç†                                                             â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚     â€¢ å¯åŠ¨æ—¶ç«‹å³ JoinRealm                                                   â”‚
â”‚     â€¢ å…³é—­æ—¶ä¼˜é›… LeaveRealm                                                  â”‚
â”‚     â€¢ å¤„ç† JoinRealm å¤±è´¥çš„æƒ…å†µ                                              â”‚
â”‚                                                                              â”‚
â”‚  3. é”™è¯¯å¤„ç†                                                                 â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚     â€¢ æ£€æŸ¥ ErrNotMember                                                     â”‚
â”‚     â€¢ æ£€æŸ¥ ErrAlreadyJoined                                                 â”‚
â”‚     â€¢ é‡è¯•è¿æ¥å¤±è´¥çš„æ“ä½œ                                                     â”‚
â”‚                                                                              â”‚
â”‚  4. å¤šç¯å¢ƒéƒ¨ç½²                                                               â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                            â”‚
â”‚     â€¢ ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒ Realm                                                 â”‚
â”‚     â€¢ é…ç½®åŒ– Realm åç§°                                                      â”‚
â”‚     â€¢ é¿å…ç¯å¢ƒäº¤å‰æ±¡æŸ“                                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šErrNotMember

**ç—‡çŠ¶**ï¼šè°ƒç”¨ä¸šåŠ¡ API æ—¶è¿”å› `ErrNotMember`

**åŸå› **ï¼šèŠ‚ç‚¹æœªåŠ å…¥ Realm

**è§£å†³**ï¼š
```go
// æ£€æŸ¥å¹¶åŠ å…¥ Realm
if node.Realm().CurrentRealm() == "" {
    node.Realm().JoinRealm(ctx, realmID)
}
```

### é—®é¢˜ 2ï¼šErrAlreadyJoined

**ç—‡çŠ¶**ï¼šåŠ å…¥ Realm æ—¶è¿”å› `ErrAlreadyJoined`

**åŸå› **ï¼šå°è¯•åŠ å…¥ç¬¬äºŒä¸ª Realm

**è§£å†³**ï¼š
```go
// å…ˆç¦»å¼€å†åŠ å…¥
node.Realm().LeaveRealm(ctx)
node.Realm().JoinRealm(ctx, newRealmID)
```

### é—®é¢˜ 3ï¼šè·¨ Realm é€šä¿¡å¤±è´¥

**ç—‡çŠ¶**ï¼šèŠ‚ç‚¹è¿æ¥æˆåŠŸä½†æ— æ³•æ”¶å‘æ¶ˆæ¯

**åŸå› **ï¼šèŠ‚ç‚¹åœ¨ä¸åŒ Realm

**è§£å†³**ï¼šç¡®ä¿é€šä¿¡åŒæ–¹åœ¨åŒä¸€ Realm

---

## ä¸‹ä¸€æ­¥

- [Hello World](01-hello-world.md) - å›é¡¾åŸºç¡€æ¦‚å¿µ
- [å®‰å…¨èŠå¤©](02-secure-chat.md) - æ„å»ºèŠå¤©åº”ç”¨
- [è·¨ NAT è¿æ¥](03-cross-nat-connect.md) - è·¨ç½‘ç»œè¿æ¥
- [æ ¸å¿ƒæ¦‚å¿µ](../concepts/core-concepts.md) - æ·±å…¥ç†è§£æ¶æ„
