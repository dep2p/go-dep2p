package config

import "time"

// 本文件定义所有配置的默认值工厂函数
//
// 注意：各个子配置的 DefaultXXXConfig() 函数已在对应的文件中定义，
// 这里仅提供统一的入口和文档说明。

// DefaultConfig 提供的默认配置适用于大多数场景：
//
// 身份配置：
//   - 使用 Ed25519 密钥（安全、高效、现代化）
//   - 内存中生成临时密钥（生产环境应持久化）
//
// 传输配置：
//   - 启用 QUIC（推荐，0-RTT、多路复用、连接迁移）和 TCP（兼容性）
//   - 禁用 WebSocket（仅浏览器需要）
//   - 30 秒拨号超时
//
// 安全配置：
//   - 启用 TLS 1.3 和 Noise
//   - 首选 TLS（更广泛支持）
//
// NAT 配置：
//   - 启用所有 NAT 穿透技术（AutoNAT、UPnP、NAT-PMP、Hole Punching）
//   - AutoNAT 15 秒探测间隔
//   - 配置 Google STUN 服务器
//
// 中继配置：
//   - 启用客户端（用于连接 NAT 后的节点），禁用服务端
//   - Relay 严格限制（10KB/s，60s，2 电路）
//   - Relay 不限制
//
// 发现配置：
//   - 启用 DHT（分布式）, mDNS（局域网）, Bootstrap（引导）
//   - DHT K=20（K-桶大小）, Alpha=3（并发查询）
//   - mDNS 10 秒间隔
//
// 连接管理配置：
//   - 低水位 100，高水位 400
//   - 20 秒新连接保护期
//
// 消息传递配置：
//   - 启用 PubSub（发布订阅）, Streams（流式）, Liveness（心跳）
//   - 1MB 最大消息大小
//   - 30 秒心跳间隔
//
// Realm 配置：
//   - 启用所有 Realm 组件
//   - 最大 100 网关节点
//   - 最大 1000 成员
//
// 资源配置：
//   - 启用资源管理
//   - 系统最大 1000 连接，10000 流，1GB 内存
//   - 每个节点最大 8 连接，100 流
//
// 这些默认值基于以下假设：
//   - 桌面或服务器环境
//   - 中等规模网络（数百到数千节点）
//   - 可靠的网络连接
//   - 充足的系统资源
//
// 移动端或资源受限环境应使用 Preset 配置：
//   - PresetMobile: 移动端优化
//   - PresetMinimal: 最小资源占用
//
// 高性能服务器应使用：
//   - PresetServer: 服务器优化

// NewConfigWithDefaults 创建使用所有默认值的配置
//
// 这是 NewConfig() 的别名，提供更明确的语义。
func NewConfigWithDefaults() *Config {
	return NewConfig()
}

// NewMinimalConfig 创建最小配置
//
// 最小配置适用于：
//   - 测试和开发
//   - 资源极度受限的环境
//   - 临时或短期运行的节点
//
// 与默认配置的主要区别：
//   - 禁用大多数可选功能
//   - 更小的缓冲区和队列大小
//   - 更短的超时时间
//   - 更低的连接和流限制
func NewMinimalConfig() *Config {
	cfg := NewConfig()

	// ════════════════════════════════════════════════════════════════════════
	// 传输配置：仅启用 QUIC，节省资源
	// ════════════════════════════════════════════════════════════════════════
	cfg.Transport.EnableTCP = false           // 禁用 TCP，QUIC 足够且更高效
	cfg.Transport.EnableWebSocket = false     // 禁用 WebSocket，减少资源占用
	cfg.Transport.QUIC.MaxStreams = 100       // 最大并发流数：100（默认 1024），测试场景足够
	cfg.Transport.DialTimeout = Duration(10 * time.Second) // 拨号超时：10 秒（默认 30 秒），快速失败

	// ════════════════════════════════════════════════════════════════════════
	// NAT 配置：禁用主动映射，减少网络开销
	// ════════════════════════════════════════════════════════════════════════
	cfg.NAT.EnableUPnP = false   // 禁用 UPnP，避免路由器交互
	cfg.NAT.EnableNATPMP = false // 禁用 NAT-PMP，避免路由器交互

	// ════════════════════════════════════════════════════════════════════════
	// 中继配置：完全禁用，不参与中继网络
	// ════════════════════════════════════════════════════════════════════════
	cfg.Relay.EnableClient = false // 禁用中继客户端，不通过中继连接
	cfg.Relay.EnableServer = false // 禁用中继服务端，不为他人中继

	// ════════════════════════════════════════════════════════════════════════
	// 发现配置：仅启用局域网发现
	// ════════════════════════════════════════════════════════════════════════
	cfg.Discovery.EnableDHT = false       // 禁用 DHT，减少网络流量和内存占用
	cfg.Discovery.EnableMDNS = true       // 启用 mDNS，支持局域网测试环境发现
	cfg.Discovery.EnableBootstrap = false // 禁用引导节点，本地测试不需要

	// ════════════════════════════════════════════════════════════════════════
	// 连接管理配置：最低限制
	// ════════════════════════════════════════════════════════════════════════
	cfg.ConnMgr.LowWater = 10  // 低水位：10 个连接（默认 100），触发连接发现
	cfg.ConnMgr.HighWater = 50 // 高水位：50 个连接（默认 400），触发连接清理

	// ════════════════════════════════════════════════════════════════════════
	// 资源配置：最低限制，适合内存受限环境
	// ════════════════════════════════════════════════════════════════════════
	cfg.Resource.System.MaxConnections = 100 // 系统最大连接数：100（默认 1000）
	cfg.Resource.System.MaxStreams = 1000    // 系统最大流数：1000（默认 10000）
	cfg.Resource.System.MaxMemory = 64 << 20 // 系统最大内存：64 MB（默认 1 GB）

	return cfg
}

// NewServerConfig 创建服务器优化配置
//
// 服务器配置适用于：
//   - 生产环境服务器
//   - 引导节点
//   - 高负载场景
//
// 与默认配置的主要区别：
//   - 更大的缓冲区和队列大小
//   - 更长的超时时间
//   - 更高的连接和流限制
//   - 启用中继服务端
//
// 注意：此预设保留 mDNS 启用状态，因为服务器可能部署在内网。
// 如需部署公网引导节点，请使用 EnableInfrastructure(true) 选项，
// 它会自动禁用 mDNS。
func NewServerConfig() *Config {
	cfg := NewConfig()

	// ════════════════════════════════════════════════════════════════════════
	// 传输配置：启用所有协议，最大化兼容性
	// ════════════════════════════════════════════════════════════════════════
	cfg.Transport.EnableWebSocket = true // 启用 WebSocket，支持浏览器客户端
	cfg.Transport.QUIC.MaxStreams = 4096 // 最大并发流数：4096（默认 1024），高并发支持

	// ════════════════════════════════════════════════════════════════════════
	// 中继配置：启用服务端，帮助 NAT 后的节点
	// ════════════════════════════════════════════════════════════════════════
	cfg.Relay.EnableServer = true          // 启用中继服务端，为其他节点提供中继
	cfg.Relay.Server.MaxReservations = 512 // 最大预约数：512（默认 128），支持更多节点
	cfg.Relay.Server.MaxCircuits = 64      // 最大电路数：64（默认 16），支持更多并发中继

	// ════════════════════════════════════════════════════════════════════════
	// NAT 配置：启用 AutoNAT 服务端，帮助其他节点检测 NAT
	// ════════════════════════════════════════════════════════════════════════
	cfg.NAT.AutoNAT.EnableServer = true  // 启用 AutoNAT 服务端，帮助其他节点检测 NAT 类型
	cfg.NAT.AutoNAT.ServerMaxProbes = 50 // 每分钟最大探测数：50（默认 10），提高服务能力

	// ════════════════════════════════════════════════════════════════════════
	// 连接管理配置：高水位，支持大规模网络
	// ════════════════════════════════════════════════════════════════════════
	cfg.ConnMgr.LowWater = 500   // 低水位：500 个连接（默认 100），保持更多连接
	cfg.ConnMgr.HighWater = 2000 // 高水位：2000 个连接（默认 400），支持大规模网络

	// ════════════════════════════════════════════════════════════════════════
	// 资源配置：高配置，充分利用服务器资源
	// ════════════════════════════════════════════════════════════════════════
	cfg.Resource.System.MaxConnections = 5000 // 系统最大连接数：5000（默认 1000）
	cfg.Resource.System.MaxStreams = 100000   // 系统最大流数：100000，需要 >= MaxConnections * PeerMaxStreams
	cfg.Resource.System.MaxMemory = 4 << 30   // 系统最大内存：4 GB（默认 1 GB）
	cfg.Resource.Peer.MaxStreamsPerPeer = 20  // 每节点最大流数：20（默认 100），避免单节点占用过多

	return cfg
}

// NewMobileConfig 创建移动端优化配置
//
// 移动端配置适用于：
//   - 移动应用
//   - 电池供电设备
//   - 不稳定网络环境
//
// 与默认配置的主要区别：
//   - 更低的资源占用
//   - 更长的发现间隔（节省电量）
//   - 禁用服务端功能
func NewMobileConfig() *Config {
	cfg := NewConfig()

	// ════════════════════════════════════════════════════════════════════════
	// 传输配置：仅启用 QUIC，最佳移动网络性能
	// ════════════════════════════════════════════════════════════════════════
	cfg.Transport.EnableTCP = false       // 禁用 TCP，QUIC 在移动网络表现更好（0-RTT、连接迁移）
	cfg.Transport.EnableWebSocket = false // 禁用 WebSocket，移动端不需要

	// ════════════════════════════════════════════════════════════════════════
	// NAT 配置：禁用服务端功能，节省电量
	// ════════════════════════════════════════════════════════════════════════
	cfg.NAT.AutoNAT.EnableServer = false // 禁用 AutoNAT 服务端，移动端不应为他人服务

	// ════════════════════════════════════════════════════════════════════════
	// 中继配置：禁用服务端，节省带宽和电量
	// ════════════════════════════════════════════════════════════════════════
	cfg.Relay.EnableServer = false // 禁用中继服务端，移动端不应为他人中继

	// ════════════════════════════════════════════════════════════════════════
	// 发现配置：更长的间隔，节省电量和带宽
	// ════════════════════════════════════════════════════════════════════════
	cfg.Discovery.DHT.RefreshInterval = Duration(2 * time.Hour)   // DHT 刷新间隔：2 小时（默认 1 小时），减少后台活动
	cfg.Discovery.MDNS.Interval = Duration(30 * time.Second)      // mDNS 发现间隔：30 秒（默认 10 秒），降低频率

	// ════════════════════════════════════════════════════════════════════════
	// 连接管理配置：低限制，减少资源占用
	// ════════════════════════════════════════════════════════════════════════
	cfg.ConnMgr.LowWater = 20   // 低水位：20 个连接（默认 100），移动端不需要太多连接
	cfg.ConnMgr.HighWater = 100 // 高水位：100 个连接（默认 400），限制资源使用

	// ════════════════════════════════════════════════════════════════════════
	// 消息传递配置：更长的心跳间隔，节省电量
	// ════════════════════════════════════════════════════════════════════════
	cfg.Messaging.Liveness.HeartbeatInterval = 60 * time.Second // 心跳间隔：60 秒（默认 30 秒），减少网络活动
	cfg.Messaging.Liveness.HeartbeatTimeout = 180 * time.Second // 心跳超时：180 秒（默认 90 秒），匹配间隔

	// ════════════════════════════════════════════════════════════════════════
	// 资源配置：低限制，适合移动设备内存
	// ════════════════════════════════════════════════════════════════════════
	cfg.Resource.System.MaxConnections = 200  // 系统最大连接数：200（默认 1000），移动端资源有限
	cfg.Resource.System.MaxStreams = 2000     // 系统最大流数：2000（默认 10000），与连接数匹配
	cfg.Resource.System.MaxMemory = 256 << 20 // 系统最大内存：256 MB（默认 1 GB），移动端内存紧张

	return cfg
}
