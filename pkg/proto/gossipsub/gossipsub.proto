syntax = "proto3";

package dep2p.gossipsub;

option go_package = "github.com/dep2p/go-dep2p/pkg/proto/gossipsub";

// RPC GossipSub 协议消息
message RPC {
    // subscriptions 订阅变更列表
    repeated SubOpts subscriptions = 1;
    
    // publish 数据消息列表
    repeated Message publish = 2;
    
    // control 控制消息
    ControlMessage control = 3;
}

// SubOpts 订阅选项
message SubOpts {
    // subscribe true=订阅, false=取消订阅
    bool subscribe = 1;
    
    // topic 主题
    string topic = 2;
}

// Message 发布订阅消息
message Message {
    // from 发送者节点 ID (32字节)
    bytes from = 1;
    
    // data 消息内容
    bytes data = 2;
    
    // seqno 序列号 (8字节, 大端序)
    bytes seqno = 3;
    
    // topic 主题
    string topic = 4;
    
    // signature 签名 (可选)
    bytes signature = 5;
    
    // key 签名者公钥 (可选)
    bytes key = 6;
}

// ControlMessage 控制消息
message ControlMessage {
    // ihave 通知有消息
    repeated ControlIHave ihave = 1;
    
    // iwant 请求消息
    repeated ControlIWant iwant = 2;
    
    // graft 请求加入 mesh
    repeated ControlGraft graft = 3;
    
    // prune 移出 mesh
    repeated ControlPrune prune = 4;
}

// ControlIHave IHAVE 消息 - 通知 peer 本节点拥有的消息
message ControlIHave {
    // topic 主题
    string topic = 1;
    
    // message_ids 消息 ID 列表
    repeated bytes message_ids = 2;
}

// ControlIWant IWANT 消息 - 请求 peer 发送指定消息
message ControlIWant {
    // message_ids 请求的消息 ID 列表
    repeated bytes message_ids = 1;
}

// ControlGraft GRAFT 消息 - 请求加入 mesh
message ControlGraft {
    // topic 主题
    string topic = 1;
}

// ControlPrune PRUNE 消息 - 从 mesh 移除
message ControlPrune {
    // topic 主题
    string topic = 1;
    
    // peers 推荐的其他 peers（PX - Peer Exchange）
    repeated PeerInfo peers = 2;
    
    // backoff 退避时间（秒）
    uint64 backoff = 3;
}

// PeerInfo Peer 信息（用于 PX）
message PeerInfo {
    // peer_id 节点 ID (32字节)
    bytes peer_id = 1;
    
    // signed_peer_record 签名的 peer 记录（可选）
    bytes signed_peer_record = 2;
}

// TopicDescriptor 主题描述符
message TopicDescriptor {
    // name 主题名称
    string name = 1;
    
    // auth 认证配置
    AuthOpts auth = 2;
    
    // enc 加密配置
    EncOpts enc = 3;
}

// AuthOpts 认证选项
message AuthOpts {
    // mode 认证模式
    AuthMode mode = 1;
    
    // keys 授权的公钥列表
    repeated bytes keys = 2;
}

// AuthMode 认证模式
enum AuthMode {
    // NONE 无认证
    AUTH_MODE_NONE = 0;
    
    // KEY 基于密钥的认证
    AUTH_MODE_KEY = 1;
    
    // WOT 信任网络认证
    AUTH_MODE_WOT = 2;
}

// EncOpts 加密选项
message EncOpts {
    // mode 加密模式
    EncMode mode = 1;
    
    // key_hashes 密钥哈希列表
    repeated bytes key_hashes = 2;
}

// EncMode 加密模式
enum EncMode {
    // NONE 不加密
    ENC_MODE_NONE = 0;
    
    // SHARED_KEY 共享密钥加密
    ENC_MODE_SHARED_KEY = 1;
    
    // WOT 信任网络加密
    ENC_MODE_WOT = 2;
}

