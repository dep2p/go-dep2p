# 实施顺序与依赖图 (Implementation Order)

> **版本**: v1.2.0  
> **更新日期**: 2026-01-23  
> **定位**: 组件实施顺序与详细依赖关系

---

## 一、实施核心原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          实施核心原则                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 接口优先 (Interface First)                                               │
│     ─────────────────────────                                               │
│     • 依赖倒置：依赖于抽象，不依赖于实现                                       │
│     • 先定义 pkg/interfaces/，再实现 internal/                               │
│     • 接口 = 契约 = 文档                                                     │
│                                                                             │
│  2. 架构驱动 (Architecture Driven)                                           │
│     ─────────────────────────────                                           │
│     • 编码前审查 L6_domains 设计文档                                          │
│     • 编码后复盘设计与实现的一致性                                            │
│     • 发现偏差立即修正                                                       │
│                                                                             │
│  3. 依赖顺序 (Dependency Order)                                              │
│     ─────────────────────────────                                           │
│     • 自底向上：先实现无依赖模块                                              │
│     • 依赖图驱动实施顺序                                                     │
│     • 每层完成后再进入下一层                                                  │
│                                                                             │
│  4. 高内聚低耦合 (High Cohesion, Low Coupling)                               │
│     ───────────────────────────────────────────                             │
│     • 模块内部高内聚：职责单一                                                │
│     • 模块之间低耦合：通过接口交互                                            │
│     • Fx 依赖注入：运行时组装                                                │
│                                                                             │
│  5. 可追溯 (Traceable)                                                       │
│     ─────────────────                                                       │
│     • 每个组件有完整的实施记录                                                │
│     • 设计 → 接口 → 编码 → 测试 → 复盘                                       │
│     • 任务状态实时更新                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、完整依赖图

### 2.1 分层依赖图（自底向上）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          组件依赖图（自底向上）                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Level 0: 基础类型（无依赖）                                                  │
│  ═══════════════════════════                                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                                     │
│  │pkg/types │ │pkg/crypto│ │pkg/proto │                                     │
│  └──────────┘ └──────────┘ └──────────┘                                     │
│                                                                             │
│  Level 1: Core Layer 基础（无/少依赖）                                        │
│  ═══════════════════════════════════════                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │ identity │ │ eventbus │ │resourcemgr│ │  muxer   │                       │
│  │    ○     │ │    ○     │ │    ○     │ │    ○     │                        │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘                        │
│       │                                                                     │
│       ↓                                                                     │
│  Level 2: Core Layer 中层                                                   │
│  ═══════════════════════════                                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                                     │
│  │peerstore │ │transport │ │ security │                                     │
│  │identity  │ │identity  │ │identity  │                                     │
│  └──────────┘ └──────────┘ └──────────┘                                     │
│       │            │            │                                           │
│       │            └─────┬──────┘                                           │
│       │                  ↓                                                  │
│       │           ┌──────────┐                                              │
│       │           │ upgrader │                                              │
│       │           │sec+muxer │                                              │
│       │           └──────────┘                                              │
│       │                  │                                                  │
│       ↓                  ↓                                                  │
│  Level 3: Core Layer 高层                                                   │
│  ═══════════════════════════                                                │
│  ┌──────────┐                                                               │
│  │ connmgr  │◄──────────────────────────────────────┐                       │
│  │peerstore │                                       │                       │
│  │eventbus  │                                       │                       │
│  └──────────┘                                       │                       │
│       │                                             │                       │
│       ↓                                             │                       │
│  ┌──────────────────────────────────────────────────┴───┐                   │
│  │                        swarm                         │                   │
│  │  transport + upgrader + connmgr + peerstore + eventbus                   │
│  └──────────────────────────────────────────────────────┘                   │
│                            │                                                │
│                            ↓                                                │
│  ┌──────────────────────────────────────────────────────┐                   │
│  │                        host                          │                   │
│  │  swarm + peerstore + eventbus + resourcemgr + metrics                    │
│  │  + protocol (system protocols)                                           │
│  └──────────────────────────────────────────────────────┘                   │
│       │                                                                     │
│       │   ┌─────────────────────────────────────────────────────────┐       │
│       │   │              nat (外部地址发现 + 打洞)                   │       │
│       │   │  swarm                                                  │       │
│       │   │  ★ holepunch 依赖 relay 信令通道                        │       │
│       │   └─────────────────────────────────────────────────────────┘       │
│       │                       │                                             │
│       │   ┌─────────────────────────────────────────────────────────┐       │
│       │   │              relay (三大职责 v2.0)                       │       │
│       │   │  swarm                                                  │       │
│       │   │  ★ 与 nat 并行，但 holepunch 需要 relay 连接            │       │
│       │   └─────────────────────────────────────────────────────────┘       │
│       │                                                                     │
│       ↓                                                                     │
│  Level 4: Discovery Layer                                                   │
│  ═══════════════════════════                                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │bootstrap │ │   mdns   │ │   dht    │ │rendezvous│ │   dns    │          │
│  │  host    │ │  host    │ │host+peer │ │  host    │ │host+peer │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│       │            │            │            │            │                 │
│       └────────────┴────────────┴────────────┴────────────┘                 │
│                                 │                                           │
│                                 ↓                                           │
│                    ┌────────────────────────┐                               │
│                    │    coordinator         │                               │
│                    │  聚合所有发现方式       │                               │
│                    └────────────────────────┘                               │
│                                 │                                           │
│                                 ↓                                           │
│  Level 5: Realm Layer                                                       │
│  ═══════════════════════                                                    │
│  ┌──────────────────────────────────────────────────────┐                   │
│  │                        realm                         │                   │
│  │  host + discovery + auth + member + routing + gateway                    │
│  └──────────────────────────────────────────────────────┘                   │
│                                 │                                           │
│                                 ↓                                           │
│  Level 6: Protocol Layer                                                    │
│  ═══════════════════════════                                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │messaging │ │  pubsub  │ │ streams  │ │ liveness │                        │
│  │host+realm│ │host+realm│ │host+realm│ │host+realm│                        │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘                        │
│                                 │                                           │
│                                 ↓                                           │
│  Level 7: API Layer                                                         │
│  ═══════════════════════                                                    │
│  ┌──────────────────────────────────────────────────────┐                   │
│  │                        node                          │                   │
│  │  聚合所有模块，提供统一 API                            │                   │
│  └──────────────────────────────────────────────────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

图例：○ = 无依赖
```

### 2.2 实施阶段划分

| 阶段 | Level | 组件 | 依赖 |
|------|-------|------|------|
| **Phase 0** | Level 0 | `pkg/types`, `pkg/crypto`, `pkg/proto`, `pkg/interfaces` | 无 |
| **Phase 1** | Level 1 | `identity`, `eventbus`, `resourcemgr`, `muxer`, `metrics` | 无 |
| **Phase 2** | Level 2 | `peerstore`, `transport`, `security`, `upgrader` | Phase 1 |
| **Phase 3** | Level 3 | `connmgr`, `swarm`, `host`, `nat`, `relay`, `reachability` | Phase 2 |
| **Phase 4** | Level 4 | `bootstrap`, `mdns`, `dht`, `rendezvous`, `dns`, `coordinator` | Phase 3 |

> **★ 注意**：
> - `nat` 与 `relay` 是并行能力，但 `holepunch` 依赖 `relay` 连接作为信令通道
> - `reachability` 负责验证候选地址是否可达，仅可达地址才能发布到 DHT
| **Phase 5** | Level 5 | `realm` (auth, member, routing, gateway) | Phase 3, 4 |
| **Phase 6** | Level 6 | `messaging`, `pubsub`, `streams`, `liveness` | Phase 5 |
| **Phase 7** | Level 7 | `node` | 全部 |

---

## 三、单组件实施流程

### 3.1 八步实施法

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       单组件实施流程（8 步法）                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Step 1: 设计审查 (Design Review)                                    │    │
│  │ ────────────────────────────────                                    │    │
│  │ • 阅读 L6_domains/<component>/README.md                             │    │
│  │ • 阅读 requirements/ 和 design/ 子目录文档                          │    │
│  │ • 确认设计文档与架构 v1.1.0 一致                                     │    │
│  │ • 输出：设计确认 或 设计修正                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Step 2: 接口定义 (Interface Definition)                             │    │
│  │ ────────────────────────────────────────                            │    │
│  │ • 完善/确认 pkg/interfaces/<component>.go                           │    │
│  │ • 确保与 L4_interfaces/public_interfaces.md 一致                    │    │
│  │ • 定义所有公共方法签名                                               │    │
│  │ • 输出：接口定义完成                                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Step 3: 测试先行 (Test First)                                       │    │
│  │ ────────────────────────────────                                    │    │
│  │ • 创建 internal/<layer>/<component>/<component>_test.go             │    │
│  │ • 编写接口契约测试（基于接口行为）                                    │    │
│  │ • 编写边界条件测试                                                   │    │
│  │ • 输出：测试骨架（预期失败）                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Step 4: 核心实现 (Core Implementation)                              │    │
│  │ ────────────────────────────────────────                            │    │
│  │ • 实现 internal/<layer>/<component>/<component>.go                  │    │
│  │ • 实现 Fx 模块 module.go                                            │    │
│  │ • 实现辅助文件（如有）                                               │    │
│  │ • 输出：代码实现                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Step 5: 测试通过 (Test Pass)                                        │    │
│  │ ────────────────────────────────                                    │    │
│  │ • 运行单元测试                                                       │    │
│  │ • 确保所有测试通过                                                   │    │
│  │ • 测试覆盖率 > 80%                                                   │    │
│  │ • 输出：测试报告                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Step 6: 集成验证 (Integration Verify)                               │    │
│  │ ────────────────────────────────────────                            │    │
│  │ • 与已实现的依赖模块集成测试                                         │    │
│  │ • Fx 依赖注入验证                                                    │    │
│  │ • Lifecycle 启动/停止验证                                            │    │
│  │ • 输出：集成测试报告                                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Step 7: 设计复盘 (Design Retrospective)                             │    │
│  │ ────────────────────────────────────────                            │    │
│  │ • 对比实现与设计文档                                                 │    │
│  │ • 检查是否偏离架构                                                   │    │
│  │ • 更新 L6_domains 文档（如有差异）                                   │    │
│  │ • 输出：复盘记录                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Step 8: 文档更新 (Documentation Update)                             │    │
│  │ ────────────────────────────────────────                            │    │
│  │ • 更新 L6_domains/<component>/coding/guidelines.md                  │    │
│  │ • 更新 L6_domains/<component>/testing/strategy.md                   │    │
│  │ • 确保 GoDoc 注释完整                                                │    │
│  │ • 输出：文档完成                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、编码检查点

### 4.1 架构一致性检查

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       编码检查点 (Checkpoints)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 检查点 1: 架构一致性                                                 │    │
│  │ ─────────────────────                                               │    │
│  │ □ 代码位置是否符合目录结构？                                         │    │
│  │ □ 依赖关系是否符合依赖图？                                           │    │
│  │ □ 是否引入了不应有的依赖？                                           │    │
│  │ □ 协议前缀是否正确（/dep2p/sys/* 或 /dep2p/app/*）？                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 检查点 2: 接口一致性                                                 │    │
│  │ ─────────────────────                                               │    │
│  │ □ 实现是否满足 pkg/interfaces/ 定义？                                │    │
│  │ □ 方法签名是否完全一致？                                             │    │
│  │ □ 返回类型是否使用公共类型？                                         │    │
│  │ □ 错误处理是否符合规范？                                             │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 检查点 3: Fx 模块规范                                                │    │
│  │ ─────────────────────                                               │    │
│  │ □ 模块名是否符合命名规范（fx.Module("xxx")）？                       │    │
│  │ □ 是否正确使用 fx.Provide/fx.Invoke？                                │    │
│  │ □ 是否正确注册 Lifecycle 钩子？                                      │    │
│  │ □ 依赖注入是否通过构造函数参数？                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 检查点 4: 代码规范                                                   │    │
│  │ ─────────────────                                                   │    │
│  │ □ 是否有 doc.go 包文档？                                             │    │
│  │ □ 公共方法是否有 GoDoc 注释？                                        │    │
│  │ □ 错误是否使用 errors 包定义？                                       │    │
│  │ □ 日志是否使用 log/slog？                                            │    │
│  │ □ 是否通过 go vet / golangci-lint？                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 检查点 5: 测试规范                                                   │    │
│  │ ─────────────────                                                   │    │
│  │ □ 测试覆盖率是否 > 80%？                                             │    │
│  │ □ 是否有边界条件测试？                                               │    │
│  │ □ 是否有并发安全测试（如适用）？                                     │    │
│  │ □ 是否有 Mock 测试依赖？                                             │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、与其他文档的关系

| 本文档内容 | 相关文档 | 关系 |
|-----------|----------|------|
| 依赖图 | [dependency_rules.md](dependency_rules.md) | 补充，提供实施视角 |
| 实施流程 | [L4_interfaces/fx_lifecycle.md](../L4_interfaces/fx_lifecycle.md) | 补充，提供流程视角 |
| 核心原则 | [module_design.md](module_design.md) | 补充，提供原则指导 |

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [layer_model.md](layer_model.md) | 五层软件架构 |
| [dependency_rules.md](dependency_rules.md) | 依赖规则详解 |
| [module_design.md](module_design.md) | 模块划分 |
| [target_structure.md](target_structure.md) | 目标目录结构 |
| [../L4_interfaces/fx_lifecycle.md](../L4_interfaces/fx_lifecycle.md) | Fx + Lifecycle 模式 |

---

**最后更新**：2026-01-13
