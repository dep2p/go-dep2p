# Core Host 模块

> **版本**: v1.2.0  
> **更新日期**: 2026-01-23  
> **定位**: 网络主机（Core Layer）

---

## 模块概述

core_host 是 DeP2P 的核心网络组件，作为 Core Layer 的聚合点，整合 Swarm、协议路由、NAT、Relay 等子系统，为上层提供统一的网络服务接口。

| 属性 | 值 |
|------|-----|
| **架构层** | Core Layer |
| **代码位置** | `internal/core/host/` |
| **Fx 模块** | `fx.Module("host")` |
| **状态** | ✅ 已实现 |
| **依赖** | swarm, protocol/system, nat, relay |

---

## 核心职责

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         core_host 职责                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 聚合 Core Layer 子系统                                                   │
│     • 整合 Swarm（连接管理）                                                │
│     • 整合系统协议（Identify/Ping/AutoNAT/HolePunch/Relay）                 │
│     • 整合 NAT 穿透                                                         │
│     • 整合 Relay 服务                                                       │
│                                                                             │
│  2. 协议路由                                                                 │
│     • 注册协议处理器                                                        │
│     • 路由入站流到对应处理器                                                │
│     • 协议协商（multistream-select）                                        │
│                                                                             │
│  3. 连接服务                                                                 │
│     • 提供拨号连接服务                                                      │
│     • 提供流创建服务                                                        │
│     • 连接状态查询                                                          │
│                                                                             │
│  4. 地址管理                                                                 │
│     • 管理监听地址                                                          │
│     • 管理已知节点地址                                                      │
│     • 观测地址收集                                                          │
│                                                                             │
│  ★ 5. Connect 语义保证                                                       │
│     • "连接成功 = 可通信"                                                   │
│     • 中继对用户透明                                                        │
│     • 失败尽早暴露                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ Connect 语义保证

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    "连接成功 = 可通信"                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ⚠️ "连接成功"在不同层级有不同含义，需要明确：                               │
│                                                                             │
│  层级 1: 传输层连接（Transport）                                             │
│  ════════════════════════════════                                           │
│  • 含义：QUIC 握手完成，双向字节流建立                                       │
│  • 此时：网络可达，但身份未验证                                              │
│  • ❌ 不应视为"可通信"                                                       │
│                                                                             │
│  层级 2: 协议层连接（Protocol）                                              │
│  ════════════════════════════════                                           │
│  • 含义：身份验证完成（TLS 握手 + NodeID 验证）                              │
│  • 此时：知道对方是谁，但可能不在同一 Realm                                  │
│  • ⚠️ 系统协议可通信，但 Realm 协议可能受限                                 │
│                                                                             │
│  层级 3: 应用层连接（Application / Realm）                                   │
│  ════════════════════════════════════════════                               │
│  • 含义：Realm 成员验证完成（PSK 验证通过）                                  │
│  • 此时：双方在同一 Realm，有权互相通信                                      │
│  • ✅ 这才是"连接成功=可通信"的真正含义                                     │
│                                                                             │
│  Host.Connect API 保证：                                                     │
│  ──────────────────────                                                     │
│  • Host.Connect(targetID) 完成所有层级的检查                                │
│  • 用户调用 Connect 成功后，应该能直接发消息                                 │
│  • 中间层级的失败应该快速上报，而非延迟到发消息时                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 中继透明原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    中继透明原则                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户视角：                                                                  │
│  ──────────                                                                 │
│  • 用户调用: Connect(targetNodeID)                                          │
│  • 用户不知道底层走的是直连还是中继                                         │
│  • 中继对用户完全透明                                                       │
│                                                                             │
│  系统视角：                                                                  │
│  ──────────                                                                 │
│  • 自动检测网络环境                                                         │
│  • 自动选择最优连接路径（直连 → 打洞 → 中继）                              │
│  • 自动建立中继电路（如需要）                                               │
│                                                                             │
│  用户不应该关心：                                                            │
│  • "这是直连还是中继？"                                                     │
│  • "打洞成功了吗？"                                                         │
│  • "为什么连接成功了但发不了消息？"                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 失败尽早暴露原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    失败尽早暴露                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ❌ 错误设计：连接时成功，发消息时才失败                                     │
│                                                                             │
│  用户困惑场景：                                                              │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │  传输层连接成功 → Realm 验证失败  →  无法发送 Realm 消息    │           │
│  │        ↑                  ↑                                 │           │
│  │    用户以为成功       用户困惑                               │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ✅ 正确设计：连接时就完成所有必要检查                                       │
│                                                                             │
│  Connect API 应该：                                                          │
│  • 完成传输层连接                                                           │
│  • 完成协议层验证（身份）                                                   │
│  • 完成应用层验证（Realm 成员资格，如适用）                                 │
│  • 要么完全成功，要么立即失败并返回明确错误                                 │
│                                                                             │
│  错误类型区分：                                                              │
│  • ErrNoRoute — 无法找到目标地址                                            │
│  • ErrConnectionRefused — 传输层连接失败                                    │
│  • ErrAuthenticationFailed — 身份验证失败                                   │
│  • ErrNotRealmMember — 不是 Realm 成员                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 架构设计

### Host 聚合结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Host                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        ID + Addrs                                   │    │
│  │              (节点标识 + 监听地址)                                  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│  ┌────────────────┬────────────────┼────────────────┬────────────────┐    │
│  │                │                │                │                │    │
│  ▼                ▼                ▼                ▼                ▼    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│  │  Swarm   │ │ Protocol │ │   NAT    │ │  Relay   │ │ PeerStore│        │
│  │          │ │  Router  │ │          │ │          │ │          │        │
│  │ 连接池   │ │ 协议路由 │ │ 穿透     │ │ 中继     │ │ 节点存储 │        │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘        │
│       │            │            │            │            │               │
│       │            │            │            │            │               │
│  ┌────┴────────────┴────────────┴────────────┴────────────┴────┐         │
│  │                      EventBus (事件通知)                      │         │
│  └──────────────────────────────────────────────────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 公共接口

```go
// pkg/interfaces/host.go

// Host 网络主机接口
type Host interface {
    // 身份
    ID() types.PeerID
    Addrs() []types.Multiaddr
    
    // 连接
    Connect(ctx context.Context, info types.PeerInfo) error
    
    // 流
    NewStream(ctx context.Context, peer types.PeerID, protos ...types.ProtocolID) (Stream, error)
    
    // 协议
    SetStreamHandler(proto types.ProtocolID, handler StreamHandler)
    SetStreamHandlerMatch(proto types.ProtocolID, match func(types.ProtocolID) bool, handler StreamHandler)
    RemoveStreamHandler(proto types.ProtocolID)
    
    // 多路复用能力
    Mux() Mux
    
    // 子系统访问
    Network() Network     // Swarm
    PeerStore() PeerStore
    EventBus() EventBus
    ConnManager() ConnManager
    ResourceManager() ResourceManager
    
    // 生命周期
    Close() error
}
```

---

## 依赖关系

### 组合依赖（Host 聚合）

| 依赖 | 模块 | 说明 |
|------|------|------|
| Swarm | core_swarm | 连接和流管理 |
| Protocol Router | core_protocol | 协议注册和路由 |
| NAT | core_nat | NAT 穿透 |
| Relay | core_relay | 中继服务 |
| PeerStore | core_peerstore | 节点信息存储 |
| EventBus | core_eventbus | 事件通知 |
| ConnManager | core_connmgr | 连接生命周期 |
| ResourceManager | core_resourcemgr | 资源限制 |

### 被依赖

| 依赖方 | 层级 | 说明 |
|--------|------|------|
| Discovery | Discovery Layer | 节点发现需要 Host |
| Realm | Realm Layer | Realm 管理需要 Host |
| Protocol/* | Protocol Layer | 应用协议需要 Host |

---

## 参考实现

### go-libp2p Host

```
github.com/libp2p/go-libp2p/p2p/host/basic/
├── basic_host.go     # 主实现
└── config.go         # 配置

关键设计：
• Host 作为门面，整合所有子系统
• 通过接口抽象各子系统
• 支持模块化替换
```

### iroh Endpoint

```
iroh/src/endpoint/
├── endpoint.rs       # 主实现
├── connection.rs     # 连接管理
└── hooks.rs          # 钩子系统

关键设计：
• Endpoint 聚合连接管理和发现
• 内置 QUIC 支持
• 自动连接管理
```

---

## 目录结构

```
core_host/
├── README.md           # 本文件
├── requirements/       # 需求追溯
├── design/             # 架构设计
├── coding/             # 编码指南
└── testing/            # 测试策略
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [core_swarm](../core_swarm/) | 连接群管理 |
| [core_protocol](../core_protocol/) | 协议路由 |
| [core_peerstore](../core_peerstore/) | 节点存储 |
| [core_eventbus](../core_eventbus/) | 事件总线 |
| [L2: 五层架构](../../L2_structural/layer_model.md) | 架构定义 |

---

**最后更新**：2026-01-23
