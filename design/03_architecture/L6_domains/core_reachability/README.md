# Reachability 模块设计

> **版本**: v1.3.0  
> **更新日期**: 2026-01-23  
> **定位**: 可达性协调（Core Layer）

## 概述

reachability 模块负责协调节点的可达性检测，确定节点是否可被外部直接访问。

**★ 核心约束**：Reachability 输出 = DHT/Relay AddressBook 输入

只有经过本模块验证的"可达地址"才能发布到 DHT 或 Relay 地址簿。

## 核心功能

1. **可达性检测** - 通过 dialback 验证可达性
2. **状态管理** - 跟踪可达性状态变化
3. **见证协调** - 管理见证节点
4. **★ 直连地址更新状态机**（v1.2.0 新增）
   - 地址发现 → 验证 → 发布的完整流程
   - 可配置的重试和超时策略
   - 状态历史跟踪
5. **★ 地址发布网关**（v1.3.0 强调）
   - 候选地址必须经过 dialback 验证
   - 验证通过的地址才允许进入 DHT/Relay 地址簿

## 地址来源（直连地址更新）

- **NetReport/STUN**: 外部地址与 NAT 类型
- **Identify**: ListenAddrs / ObservedAddr 交换
- **Peerstore**: 最近成功连接的地址
- **MemberSync**: join2/sync2 携带的成员地址
- **★ Relay 地址簿**: Relay 维护的成员地址信息（第一层作用）

## 代码位置

```
internal/core/reachability/
├── doc.go               # 包文档
├── module.go            # Fx 模块定义
├── coordinator.go       # 可达性协调器
├── coordinator_test.go
├── dialback.go          # dialback 协议
├── dialback_test.go
├── store.go             # 状态存储
├── store_test.go
├── direct_state.go      # ★ 直连地址更新状态机
├── direct_state_test.go # 状态机测试
└── addrmgmt/            # 地址管理子模块
    ├── handler.go       # 地址记录处理
    └── scheduler.go     # 地址刷新调度
```

## ★ 候选地址 vs 可达地址（关键区分）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Reachability 作为地址发布网关                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入（候选地址）：                                                          │
│  ─────────────────                                                          │
│  • STUN 探测结果                                                            │
│  • UPnP 映射地址                                                            │
│  • Observed Address（对端告知）                                             │
│  • ❌ 这些地址未经验证，不能直接发布                                        │
│                                                                             │
│  处理（dialback 验证）：                                                     │
│  ──────────────────────                                                     │
│  • 请求外部节点（见证节点）尝试连接回本节点                                 │
│  • 验证候选地址是否真正可达                                                 │
│                                                                             │
│  输出（可达地址）：                                                          │
│  ─────────────────                                                          │
│  • 验证通过的地址                                                           │
│  • ✅ 可以发布到 DHT                                                        │
│  • ✅ 可以注册到 Relay 地址簿                                               │
│                                                                             │
│  ★ 约束：Reachability 输出 = DHT/AddressBook 输入                           │
│  • DHT 发布只接受 Reachability 验证过的地址                                 │
│  • Relay 地址簿只接受 Reachability 验证过的地址                             │
│  • 直接发布候选地址会导致"不可达地址泛滥"                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## ★ Publishing 目标

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Publishing 阶段目标                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  当可达性验证通过后，Publishing 阶段将地址写入：                             │
│                                                                             │
│  1. DHT Peer Record                                                         │
│     ─────────────────                                                       │
│     • 发布到 Kademlia DHT                                                   │
│     • 让其他节点可以通过 FindPeer 找到本节点                                │
│     • TTL：24 小时（需定期刷新）                                            │
│                                                                             │
│  2. Relay 地址簿                                                            │
│     ────────────────                                                        │
│     • 向配置的 Relay 注册地址（AddressRegister）                            │
│     • 让 Relay 可以回答地址查询                                             │
│     • 其他成员可通过 Relay 获取本节点地址                                   │
│                                                                             │
│  ★ 不可达时的策略：                                                         │
│     • 不发布直连地址到 DHT                                                  │
│     • 发布 Relay 地址作为替代（/p2p/QmRelay.../p2p-circuit/p2p/QmMe）      │
│     • 确保其他节点总能通过某种方式连接本节点                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 直连地址更新状态机

```
┌────────────────────────────────────────────────────────────────┐
│                 DirectAddrUpdateStateMachine                    │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  状态流转：                                                     │
│                                                                │
│  ┌──────┐   ┌─────────────┐   ┌────────────┐   ┌───────────┐  │
│  │ Idle │──▶│ Discovering │──▶│ Validating │──▶│ Publishing│  │
│  └──────┘   └─────────────┘   └────────────┘   └───────────┘  │
│                   │                 │                │         │
│                   │ (候选地址)       │ (dialback)    │ (写入)  │
│                   ▼                 ▼                ▼         │
│              ┌────────┐        ┌────────┐      ┌──────────┐   │
│              │ Failed │◀───────│ Failed │◀─────│ Complete │   │
│              └────────┘        └────────┘      └──────────┘   │
│                                                                │
│  阶段说明：                                                    │
│  • Discovering: 收集候选地址（STUN/UPnP/Observed）             │
│  • Validating:  验证可达性（dialback/AutoNAT）                 │
│  • Publishing:  发布到 DHT + Relay 地址簿                      │
│  • Complete:    发布成功，地址对外可用                         │
│                                                                │
│  特性：                                                        │
│  • 可配置的发现/验证/发布超时                                   │
│  • 自动重试机制                                                 │
│  • 状态历史记录                                                 │
│  • 回调函数注入                                                 │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 公共接口

```
pkg/interfaces/reachability.go
```

## 依赖

- NAT 模块
- Transport 模块
- EventBus 模块
- Discovery 模块

---

**最后更新**：2026-01-23
