# pkg_multiaddr 需求说明

> **版本**: v1.1.0  
> **更新日期**: 2026-01-13

---

## 功能需求

### FR-1: 协议定义

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-1.1 | 支持 IP4/IP6 协议 | P0 | ✅ 已实现 |
| FR-1.2 | 支持 TCP/UDP 协议 | P0 | ✅ 已实现 |
| FR-1.3 | 支持 QUIC/QUIC-V1 协议 | P0 | ✅ 已实现 |
| FR-1.4 | 支持 P2P 协议 | P0 | ✅ 已实现 |
| FR-1.5 | 支持 DNS/DNS4/DNS6/DNSADDR 协议 | P1 | ✅ 已实现 |
| FR-1.6 | 支持 WS/WSS 协议 | P1 | ✅ 已实现 |
| FR-1.7 | 支持 TLS/NOISE 协议 | P2 | ✅ 已实现 |
| FR-1.8 | 支持 Onion/Garlic 协议 | P2 | ✅ 已实现 |

### FR-2: 地址解析

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-2.1 | 从字符串解析多地址 | P0 | ✅ 已实现 |
| FR-2.2 | 从二进制解析多地址 | P0 | ✅ 已实现 |
| FR-2.3 | 验证地址格式 | P0 | ✅ 已实现 |
| FR-2.4 | 错误提示清晰 | P1 | ✅ 已实现 |

### FR-3: 地址编码

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-3.1 | 字符串序列化 | P0 | ✅ 已实现 |
| FR-3.2 | 二进制序列化 | P0 | ✅ 已实现 |
| FR-3.3 | JSON 序列化 | P1 | ✅ 已实现 |
| FR-3.4 | 与 go-multiaddr 二进制兼容 | P0 | ✅ 已实现 |

### FR-4: 地址操作

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-4.1 | 封装（Encapsulate） | P0 | ✅ 已实现 |
| FR-4.2 | 解封装（Decapsulate） | P0 | ✅ 已实现 |
| FR-4.3 | 协议值提取 | P0 | ✅ 已实现 |
| FR-4.4 | 协议列表获取 | P1 | ✅ 已实现 |
| FR-4.5 | 地址相等比较 | P1 | ✅ 已实现 |

### FR-5: 网络转换

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-5.1 | 转换为 TCP 地址 | P0 | ✅ 已实现 |
| FR-5.2 | 转换为 UDP 地址 | P0 | ✅ 已实现 |
| FR-5.3 | 从 TCP 地址创建 | P0 | ✅ 已实现 |
| FR-5.4 | 从 UDP 地址创建 | P0 | ✅ 已实现 |
| FR-5.5 | 从 net.Addr 创建 | P1 | ✅ 已实现 |

### FR-6: P2P 地址处理

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-6.1 | 分离传输地址和 PeerID | P0 | ✅ 已实现 |
| FR-6.2 | 合并传输地址和 PeerID | P0 | ✅ 已实现 |
| FR-6.3 | 提取 PeerID | P1 | ✅ 已实现 |
| FR-6.4 | 添加/替换 PeerID | P1 | ✅ 已实现 |
| FR-6.5 | 移除 PeerID | P1 | ✅ 已实现 |

### FR-7: 工具函数

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-7.1 | 地址过滤 | P1 | ✅ 已实现 |
| FR-7.2 | 地址去重 | P1 | ✅ 已实现 |
| FR-7.3 | 协议检查 | P1 | ✅ 已实现 |

---

## 非功能需求

### NFR-1: 兼容性

| ID | 需求 | 说明 | 状态 |
|----|------|------|------|
| NFR-1.1 | multiformats 对齐 | 协议代码完全一致 | ✅ 已实现 |
| NFR-1.2 | go-multiaddr 二进制兼容 | 二进制格式一致 | ✅ 已实现 |
| NFR-1.3 | libp2p 生态兼容 | 地址格式兼容 | ✅ 已实现 |

### NFR-2: 性能

| ID | 需求 | 目标 | 实际 | 状态 |
|----|------|------|------|------|
| NFR-2.1 | 地址解析性能 | < 1μs | ~496 ns | ✅ |
| NFR-2.2 | 字符串转换性能 | < 500ns | ~329 ns | ✅ |
| NFR-2.3 | 字节访问性能 | < 10ns | ~2.5 ns | ✅ |
| NFR-2.4 | 协议查找性能 | < 50ns | ~12-19 ns | ✅ |

### NFR-3: 可测试性

| ID | 需求 | 目标 | 实际 | 状态 |
|----|------|------|------|------|
| NFR-3.1 | 测试覆盖率 | > 80% | 82.2% | ✅ |
| NFR-3.2 | 边界条件测试 | 完整 | 完整 | ✅ |
| NFR-3.3 | 往返测试 | 所有协议 | 核心协议 | ✅ |
| NFR-3.4 | 基准测试 | 所有操作 | 所有操作 | ✅ |

### NFR-4: 可维护性

| ID | 需求 | 说明 | 状态 |
|----|------|------|------|
| NFR-4.1 | 代码注释 | GoDoc 完整 | ✅ 已实现 |
| NFR-4.2 | 错误处理 | 清晰的错误消息 | ✅ 已实现 |
| NFR-4.3 | 模块化设计 | 职责分离 | ✅ 已实现 |
| NFR-4.4 | 文档完整 | README + L6_domains | ✅ 已实现 |

---

## 约束规范

| 规范 | 文档 | 对齐状态 |
|------|------|----------|
| Multiaddr 格式 | [QUIC 传输规范](../../../../02_constraints/protocol/L2_transport/quic.md) | ✅ 完全对齐 |
| 协议代码 | [multiformats/multicodec](https://github.com/multiformats/multicodec) | ✅ 完全对齐 |

---

## 依赖需求

| 依赖 | 类型 | 说明 |
|------|------|------|
| Go 标准库 | 标准 | net, encoding/*, strings 等 |

**无外部依赖** ✅

---

## 使用场景

### UC-1: 节点启动时配置监听地址

```
1. 用户配置监听地址字符串
2. 系统解析为 Multiaddr
3. 提取 IP 和端口
4. 绑定网络监听器
```

### UC-2: 连接远程节点

```
1. 获取远程节点的 Multiaddr
2. 检查传输协议（TCP/QUIC/WS）
3. 转换为标准网络地址
4. 建立连接
```

### UC-3: 发现节点地址

```
1. DHT 返回 Multiaddr 列表
2. 过滤可达地址
3. 去重
4. 按优先级排序
5. 尝试连接
```

### UC-4: 处理 P2P 地址

```
1. 接收完整 P2P 地址
2. 分离传输地址和 PeerID
3. 验证 PeerID
4. 使用传输地址连接
```

---

## 验收标准

| 类别 | 标准 | 状态 |
|------|------|------|
| 功能完整性 | 所有 P0/P1 需求实现 | ✅ |
| 测试覆盖率 | > 80% | ✅ 82.2% |
| 性能基准 | 解析 < 1μs | ✅ ~496ns |
| 协议对齐 | 与 multiformats 一致 | ✅ |
| 文档完整性 | GoDoc + README | ✅ |
| 规范对齐 | 与约束规范一致 | ✅ |
| 集成测试 | pkg/types 兼容 | ✅ |

---

**最后更新**：2026-01-13
