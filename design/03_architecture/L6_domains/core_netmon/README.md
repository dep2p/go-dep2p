# NetMon 模块设计

> **版本**: v1.1.0  
> **更新日期**: 2026-01-23  
> **定位**: 网络状态监控（Core Layer）

---

## 概述

netmon 模块提供网络状态监控功能，跟踪整体网络连接状态和可用性，为 Recovery 模块提供决策依据。

---

## 核心功能

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        core_netmon 职责                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 网络状态跟踪                                                             │
│     • 系统级事件监听（平台原生）                                            │
│     • 主动探测（Prober）                                                    │
│     • 连接健康状态管理                                                      │
│                                                                             │
│  2. 状态变化通知                                                             │
│     • 发布网络状态事件                                                      │
│     • 状态变化去抖                                                          │
│     • 通知订阅者                                                            │
│                                                                             │
│  3. 策略协调                                                                 │
│     • 与 Recovery 模块协调                                                  │
│     • 为地址更新提供触发信号                                                │
│     • 为可达性检测提供触发信号                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 网络状态机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    网络状态机                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  状态：                                                                      │
│  ──────                                                                     │
│  • Healthy: 网络正常                                                        │
│  • Degraded: 网络质量下降（丢包率上升等）                                   │
│  • Down: 网络不可用                                                         │
│  • Recovering: 正在恢复中                                                   │
│                                                                             │
│  状态流转：                                                                  │
│                                                                             │
│  Healthy → [质量下降] → Degraded → [完全断开] → Down                       │
│     ↑                      │                     │                          │
│     │                      │ [恢复]              │ [开始恢复]               │
│     │                      ↓                     ↓                          │
│     └──────────────── Healthy ←───────────── Recovering                    │
│                                                                             │
│  每个状态转换都需要满足去抖条件（StateChangeDebounce）                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 连接保活

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    连接保活策略                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  传输层保活（必需）                                                          │
│  ══════════════════                                                         │
│  • 定期发送 PING 帧，维持 NAT 映射                                          │
│  • 配置: KeepAlivePeriod < IdleTimeout                                      │
│  • 否则连接会在空闲后断开                                                    │
│                                                                             │
│  应用层心跳（可选）                                                          │
│  ══════════════════                                                         │
│  • 定期 Ping 检测节点健康                                                    │
│  • 用于：节点健康评估、RTT 测量                                              │
│                                                                             │
│  ★ 传输层保活是必需的，否则 NAT 映射会超时                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 网络变化处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    网络变化处理                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Major Change（网络接口切换，如 4G→WiFi）                                   │
│  ════════════════════════════════════════                                   │
│  1. 重新绑定 Socket — 关闭旧连接，绑定新接口                                │
│  2. 重新 STUN — 查询新的外部地址                                            │
│  3. 重置连接状态                                                             │
│  4. 更新 DHT — 发布新地址                                                    │
│  5. 通知 Relay — 更新地址簿                                                  │
│                                                                             │
│  Minor Change（IP 地址微调）                                                │
│  ════════════════════════════                                               │
│  • 仅重新 STUN，更新地址                                                    │
│                                                                             │
│  触发条件：                                                                  │
│  • 系统网络事件（平台原生监听）                                              │
│  • 探测发现地址变化                                                          │
│  • 连接失败模式识别                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `ProbeInterval` | 30s | 主动探测间隔 |
| `ErrorThreshold` | 3 | 连续错误阈值（触发状态变化） |
| `StateChangeDebounce` | 5s | 状态变化去抖时间 |
| `KeepAlivePeriod` | 15s | 传输层保活间隔（必须 < NAT 映射超时） |

### 参数建议值

| 参数 | 建议值 | 说明 |
|------|--------|------|
| KeepAlivePeriod | 15s | 必须 < NAT 映射超时（通常 30-120s） |
| ProbeInterval | 30s | 平衡及时性与开销 |
| StateChangeDebounce | 5s | 避免抖动导致频繁状态变化 |

---

## 代码位置

```
internal/core/netmon/
├── doc.go          # 包文档
├── monitor.go      # 状态监控器（Prober + SystemWatcher）
├── monitor_test.go # 监控器测试
├── state.go        # 状态定义与状态机
├── config.go       # 配置参数
├── events.go       # 事件定义
└── module.go       # Fx 模块定义
```

---

## 公共接口

```pseudocode
interface NetworkMonitor {
    // GetState 获取当前网络状态
    GetState() -> NetworkState
    
    // Subscribe 订阅状态变化事件
    Subscribe() -> Channel<NetworkStateEvent>
    
    // ForceProbe 强制执行一次探测
    ForceProbe() -> Result<(), Error>
}

enum NetworkState {
    Healthy,
    Degraded,
    Down,
    Recovering
}
```

---

## 依赖

| 模块 | 作用 |
|------|------|
| Network | 网络连接信息 |
| EventBus | 事件发布 |
| core_recovery | 恢复协调 |
| core_nat | 地址更新触发 |

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [core_recovery](../core_recovery/) | 网络恢复 |
| [core_nat](../core_nat/) | NAT 穿透 |

---

**最后更新**：2026-01-23
