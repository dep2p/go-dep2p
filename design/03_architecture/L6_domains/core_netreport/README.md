# NetReport 模块设计

> **版本**: v1.1.0  
> **更新日期**: 2026-01-23  
> **定位**: Core Layer - 网络诊断报告

## 概述

netreport 模块提供网络诊断功能，生成详细的网络环境报告。

**★ 重要说明**：本模块输出的是**诊断信息和候选地址**，不是可发布地址。

## 核心功能

1. **连通性检测** - IPv4/IPv6 连通性
2. **NAT 类型检测** - 对称/非对称 NAT
3. **中继延迟测量** - 测量中继节点延迟
4. **端口映射检测** - UPnP/NAT-PMP/PCP

## ★ 输出性质说明（关键）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NetReport 输出性质（★ 必读）                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  本模块输出的是：                                                            │
│  ════════════════                                                           │
│  ✅ 诊断信息（NAT 类型、连通性、延迟）                                       │
│  ✅ 候选地址（STUN 探测结果、UPnP 映射地址）                                │
│                                                                             │
│  本模块输出的不是：                                                          │
│  ══════════════════                                                         │
│  ❌ 可发布地址（不能直接发布到 DHT/Relay 地址簿）                           │
│  ❌ 可达地址（未经 Reachability/AutoNAT 验证）                              │
│                                                                             │
│  正确使用流程：                                                              │
│  ──────────────                                                             │
│  NetReport 输出 → Reachability 验证 → DHT/Relay 地址簿发布                 │
│        ↓                  ↓                    ↓                            │
│    候选地址           验证可达性           可发布地址                        │
│                                                                             │
│  ⚠️ 禁止行为：                                                              │
│  • 直接将 STUN 探测结果发布到 DHT                                           │
│  • 将 UPnP 映射地址当作可达地址对外公告                                     │
│  • 不验证直接使用候选地址进行连接尝试（打洞场景除外）                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 代码位置

```
internal/core/netreport/
├── doc.go         # 包文档
├── client.go      # 诊断客户端
├── client_test.go # 客户端测试
├── config.go      # 配置定义
├── report.go      # 报告结构
└── stun.go        # STUN 探测
```

## 使用场景

- 网络故障诊断
- 连接策略优化
- NAT 穿透决策
- ★ 候选地址收集（输入给 Reachability 模块）

## 依赖

- Transport 模块（STUN 探测）
- core_reachability 模块（候选地址消费方）

## 相关文档

| 文档 | 说明 |
|------|------|
| [core_reachability](../core_reachability/) | 地址可达性验证（消费本模块输出） |
| [core_nat](../core_nat/) | NAT 穿透（使用诊断信息） |

---

**最后更新**：2026-01-23
