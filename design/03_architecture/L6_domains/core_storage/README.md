# core_storage - å­˜å‚¨æœåŠ¡

> **ç‰ˆæœ¬**: v1.1.0  
> **æ›´æ–°æ—¥æœŸ**: 2026-01-17  
> **ä»£ç ä½ç½®**: `internal/core/storage/`  
> **å…¬å…±æ¥å£**: `pkg/interfaces/storage.go`

---

## æ¦‚è¿°

Storage æ¨¡å—ä¸º DeP2P æä¾›ç»Ÿä¸€çš„æŒä¹…åŒ–å­˜å‚¨åŸºç¡€è®¾æ–½ï¼ŒåŸºäº BadgerDB å®ç°ã€‚

**é‡è¦æ›´æ–°ï¼ˆv1.1.0ï¼‰**: ä» v1.1.0 å¼€å§‹ï¼Œæ‰€æœ‰ç»„ä»¶ç»Ÿä¸€ä½¿ç”¨ BadgerDB æŒä¹…åŒ–å­˜å‚¨ï¼Œ
ä¸å†æä¾›å†…å­˜æ¨¡å¼é€‰é¡¹ã€‚æµ‹è¯•ä»£ç åº”ä½¿ç”¨ `t.TempDir()` åˆ›å»ºä¸´æ—¶ç›®å½•ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å­˜å‚¨æœåŠ¡å®šä½                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  èŒè´£ï¼š                                                                      â”‚
â”‚  â€¢ æä¾›ç»Ÿä¸€çš„ KV å­˜å‚¨å¼•æ“ï¼ˆBadgerDBï¼‰                                        â”‚
â”‚  â€¢ æ”¯æŒæ‰¹é‡æ“ä½œã€è¿­ä»£å™¨ã€äº‹åŠ¡                                                 â”‚
â”‚  â€¢ é€šè¿‡å‰ç¼€éš”ç¦»ä¸åŒæ•°æ®åŸŸ                                                     â”‚
â”‚  â€¢ å¼ºåˆ¶æŒä¹…åŒ–å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®å®‰å…¨                                               â”‚
â”‚                                                                             â”‚
â”‚  ä½¿ç”¨è€…ï¼š                                                                     â”‚
â”‚  â€¢ Peerstoreï¼ˆèŠ‚ç‚¹åœ°å€/å¯†é’¥/åè®®ï¼‰                                           â”‚
â”‚  â€¢ DHTï¼ˆå€¼å­˜å‚¨/Provider è®°å½•/è·¯ç”±è¡¨ï¼‰                                        â”‚
â”‚  â€¢ AddressBookï¼ˆRealm æˆå‘˜åœ°å€ï¼‰                                             â”‚
â”‚  â€¢ Rendezvousï¼ˆå‘½åç©ºé—´æ³¨å†Œï¼‰                                                â”‚
â”‚  â€¢ MemberStoreï¼ˆRealm æˆå‘˜ä¿¡æ¯ï¼‰                                             â”‚
â”‚                                                                             â”‚
â”‚  æ¶æ„å±‚ï¼šCore Layerï¼ˆæ ¸å¿ƒå±‚ï¼‰                                                â”‚
â”‚                                                                             â”‚
â”‚  ç”¨æˆ·æ„ŸçŸ¥ï¼šâ˜…â˜†â˜†â˜†â˜† å†…éƒ¨é€æ˜                                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç›®å½•ç»“æ„

```
internal/core/storage/
â”œâ”€â”€ doc.go                       # æ¨¡å—æ–‡æ¡£
â”œâ”€â”€ module.go                    # Fx æ¨¡å—å®šä¹‰
â”œâ”€â”€ config.go                    # å­˜å‚¨é…ç½®
â”œâ”€â”€ errors.go                    # é”™è¯¯å®šä¹‰
â”‚
â”œâ”€â”€ engine/                      # å­˜å‚¨å¼•æ“æŠ½è±¡
â”‚   â”œâ”€â”€ engine.go                # InternalEngine/Batch/Iterator/Transaction å†…éƒ¨æ¥å£
â”‚   â”œâ”€â”€ config.go                # å¼•æ“é…ç½®
â”‚   â”œâ”€â”€ errors.go                # å¼•æ“é”™è¯¯
â”‚   â””â”€â”€ badger/                  # BadgerDB å®ç°
â”‚       â”œâ”€â”€ db.go                # ä¸»å¼•æ“å®ç°
â”‚       â”œâ”€â”€ batch.go             # æ‰¹é‡æ“ä½œ
â”‚       â”œâ”€â”€ iter.go              # è¿­ä»£å™¨
â”‚       â”œâ”€â”€ txn.go               # äº‹åŠ¡
â”‚       â””â”€â”€ db_test.go           # å•å…ƒæµ‹è¯•
â”‚
â””â”€â”€ kv/                          # KV æŠ½è±¡å±‚ï¼ˆå¸¦å‰ç¼€éš”ç¦»ï¼‰
    â”œâ”€â”€ store.go                 # KVStore å®ç°
    â””â”€â”€ store_test.go            # å•å…ƒæµ‹è¯•
```

---

## æ¥å£è®¾è®¡

### å…¬å…±æ¥å£ï¼ˆpkg/interfaces/storage.goï¼‰

```go
// Engine å­˜å‚¨å¼•æ“åŸºç¡€æ¥å£
// å…è®¸ç”¨æˆ·æä¾›è‡ªå®šä¹‰å­˜å‚¨åç«¯ï¼ˆå¯é€‰ï¼‰
type Engine interface {
    // åŸºç¡€æ“ä½œ
    Get(key []byte) ([]byte, error)
    Put(key, value []byte) error
    Delete(key []byte) error
    Has(key []byte) (bool, error)
    
    // ç”Ÿå‘½å‘¨æœŸ
    Close() error
}

// EngineStats å¼•æ“ç»Ÿè®¡ä¿¡æ¯
type EngineStats struct {
    KeyCount    int64  `json:"key_count"`
    DiskSize    int64  `json:"disk_size"`
    CacheHits   int64  `json:"cache_hits"`
    CacheMisses int64  `json:"cache_misses"`
}
```

### å†…éƒ¨æ‰©å±•æ¥å£ï¼ˆinternal/core/storage/engine/engine.goï¼‰

```go
// InternalEngine å†…éƒ¨æ‰©å±•æ¥å£
type InternalEngine interface {
    interfaces.Engine  // åµŒå…¥å…¬å…±æ¥å£
    
    // æ‰¹é‡æ“ä½œ
    NewBatch() Batch
    Write(batch Batch) error
    
    // è¿­ä»£å™¨
    NewIterator(opts *IteratorOptions) Iterator
    NewPrefixIterator(prefix []byte) Iterator
    
    // äº‹åŠ¡
    NewTransaction(writable bool) Transaction
    
    // ç»´æŠ¤
    Start() error
    Compact() error
    Sync() error
    Stats() *Stats
}

// Batch æ‰¹é‡å†™å…¥æ¥å£
type Batch interface {
    Put(key, value []byte)
    Delete(key []byte)
    Write() error
    Reset()
    Size() int
}

// Iterator è¿­ä»£å™¨æ¥å£
type Iterator interface {
    First() bool
    Next() bool
    Valid() bool
    Key() []byte
    Value() []byte
    Close()
    Error() error
}

// Transaction äº‹åŠ¡æ¥å£
type Transaction interface {
    Get(key []byte) ([]byte, error)
    Set(key, value []byte) error
    Delete(key []byte) error
    Commit() error
    Discard()
}
```

---

## é”®ç©ºé—´è®¾è®¡

é€šè¿‡å‰ç¼€éš”ç¦»ä¸åŒæ•°æ®åŸŸï¼š

| å‰ç¼€ | æ•°æ®ç±»å‹ | é”®æ ¼å¼ | è¯´æ˜ |
|------|----------|--------|------|
| `p/a/` | Peerstore åœ°å€ | `p/a/{peerID}/{addrIdx}` | èŠ‚ç‚¹åœ°å€åˆ—è¡¨ |
| `p/k/` | Peerstore å¯†é’¥ | `p/k/{peerID}` | èŠ‚ç‚¹å…¬é’¥ |
| `p/p/` | Peerstore åè®® | `p/p/{peerID}` | æ”¯æŒçš„åè®® |
| `p/m/` | Peerstore å…ƒæ•°æ® | `p/m/{peerID}/{key}` | èŠ‚ç‚¹å…ƒæ•°æ® |
| `d/v/` | DHT å€¼ | `d/v/{key}` | DHT å­˜å‚¨çš„å€¼ |
| `d/p/` | DHT Provider | `d/p/{key}/{peerID}` | å†…å®¹æä¾›è€… |
| `d/r/` | DHT è·¯ç”±è¡¨ | `d/r/{bucketIdx}/{peerID}` | K æ¡¶è·¯ç”±è¡¨ |
| `a/` | AddressBook | `a/{realmID}/{nodeID}` | Realm æˆå‘˜åœ°å€ |
| `r/` | Rendezvous | `r/{namespace}/{peerID}` | Rendezvous æ³¨å†Œ |
| `m/` | Member | `m/{realmID}/{peerID}` | Realm æˆå‘˜ä¿¡æ¯ |

---

## é…ç½®

ä» v1.1.0 å¼€å§‹ï¼Œå­˜å‚¨é…ç½®ç®€åŒ–ä¸ºä»…éœ€æŒ‡å®šæ•°æ®ç›®å½•ã€‚

```go
// StorageConfig å­˜å‚¨é…ç½®ï¼ˆé¡¶å±‚ config.Config.Storageï¼‰
type StorageConfig struct {
    // DataDir æ•°æ®ç›®å½•ï¼ˆå¿…éœ€ï¼‰
    DataDir string `json:"data_dir" yaml:"data_dir"`
}

// Config å­˜å‚¨æ¨¡å—å†…éƒ¨é…ç½®
type Config struct {
    // Path å­˜å‚¨è·¯å¾„ï¼ˆå¿…éœ€ï¼‰
    Path string
    
    // SyncWrites æ˜¯å¦åŒæ­¥å†™å…¥
    SyncWrites bool
    
    // GCEnabled æ˜¯å¦å¯ç”¨åƒåœ¾å›æ”¶
    GCEnabled bool
    
    // GCInterval åƒåœ¾å›æ”¶é—´éš”
    GCInterval time.Duration
    
    // GCDiscardRatio åƒåœ¾å›æ”¶ä¸¢å¼ƒæ¯”ä¾‹
    GCDiscardRatio float64
    
    // BlockCacheSize å—ç¼“å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    BlockCacheSize int64
    
    // Compression å‹ç¼©çº§åˆ«
    Compression int
}
```

---

## Fx æ¨¡å—é›†æˆ

```go
// module.go
var Module = fx.Module("storage",
    fx.Provide(ProvideStorage),
    fx.Invoke(registerLifecycle),
)

// ProvideStorage æä¾›å­˜å‚¨å¼•æ“å’Œé…ç½®
func ProvideStorage(p Params) (Result, error) {
    cfg := ConfigFromUnified(p.UnifiedCfg)
    
    if err := cfg.Validate(); err != nil {
        return Result{}, err
    }
    
    eng, err := NewEngine(cfg)
    if err != nil {
        return Result{}, err
    }
    
    return Result{
        Engine: eng,
        Config: cfg,
    }, nil
}

// NewKVStore åˆ›å»ºå¸¦å‰ç¼€çš„ KVStore
func NewKVStore(eng engine.InternalEngine, prefix []byte) *kv.Store {
    return kv.New(eng, prefix)
}
```

---

## ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å­˜å‚¨æ¨¡å—ä¾èµ–å…³ç³»                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  æ— ä¾èµ–ï¼ˆæœ€åº•å±‚ï¼‰                                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                           â”‚
â”‚                                                                             â”‚
â”‚  storage æ¨¡å—ä¸ä¾èµ–å…¶ä»– DeP2P æ¨¡å—                                           â”‚
â”‚  ä»…ä¾èµ–å¤–éƒ¨åº“ï¼šgithub.com/dgraph-io/badger/v4                               â”‚
â”‚                                                                             â”‚
â”‚  è¢«ä¾èµ–ï¼š                                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                  â”‚
â”‚  â€¢ peerstore (å¯é€‰)      â†’ èŠ‚ç‚¹åœ°å€/å¯†é’¥æŒä¹…åŒ–                               â”‚
â”‚  â€¢ dht (å¯é€‰)            â†’ DHT å€¼/Provider æŒä¹…åŒ–                            â”‚
â”‚  â€¢ addressbook (å¯é€‰)    â†’ Realm æˆå‘˜åœ°å€æŒä¹…åŒ–                              â”‚
â”‚  â€¢ rendezvous (å¯é€‰)     â†’ æ³¨å†Œè®°å½•æŒä¹…åŒ–                                    â”‚
â”‚  â€¢ memberstore (å¯é€‰)    â†’ Realm æˆå‘˜ä¿¡æ¯æŒä¹…åŒ–                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®ç°çŠ¶æ€

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|:----:|------|
| å…¬å…±æ¥å£ `pkg/interfaces/storage.go` | ğŸ“‹ | è§„åˆ’ä¸­ |
| å†…éƒ¨æ¥å£ `engine/engine.go` | ğŸ“‹ | è§„åˆ’ä¸­ |
| BadgerDB å®ç° `engine/badger/` | ğŸ“‹ | è§„åˆ’ä¸­ |
| KV æŠ½è±¡å±‚ `kv/store.go` | ğŸ“‹ | è§„åˆ’ä¸­ |
| Fx æ¨¡å— `module.go` | ğŸ“‹ | è§„åˆ’ä¸­ |

---

## è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å­˜å‚¨æ¨¡å—è®¾è®¡åŸåˆ™                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. å¼ºåˆ¶æŒä¹…åŒ– (v1.1.0+)                                                    â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚     â€¢ æ‰€æœ‰ç»„ä»¶ç»Ÿä¸€ä½¿ç”¨ BadgerDB æŒä¹…åŒ–å­˜å‚¨                                    â”‚
â”‚     â€¢ æµ‹è¯•ä»£ç ä½¿ç”¨ t.TempDir() åˆ›å»ºä¸´æ—¶ç›®å½•                                  â”‚
â”‚     â€¢ ç¡®ä¿æµ‹è¯•ä¸ç”Ÿäº§è¡Œä¸ºä¸€è‡´                                                 â”‚
â”‚                                                                             â”‚
â”‚  2. å•å®ä¾‹å…±äº« (Single Instance)                                            â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚     â€¢ æ‰€æœ‰ç»„ä»¶å…±äº«ä¸€ä¸ª BadgerDB å®ä¾‹                                         â”‚
â”‚     â€¢ é€šè¿‡å‰ç¼€éš”ç¦»ä¸åŒæ•°æ®åŸŸ                                                 â”‚
â”‚     â€¢ ç»Ÿä¸€ GCã€å‹ç¼©ã€å¤‡ä»½ç­–ç•¥                                                â”‚
â”‚                                                                             â”‚
â”‚  3. æ¥å£æŠ½è±¡ (Interface Abstraction)                                        â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚     â€¢ å…¬å…±æ¥å£æœ€å°åŒ–ï¼ˆä»… Engine åŸºç¡€æ“ä½œï¼‰                                   â”‚
â”‚     â€¢ å†…éƒ¨æ¥å£å®Œæ•´ï¼ˆBatchã€Iteratorã€Transactionï¼‰                           â”‚
â”‚     â€¢ å¯æ›¿æ¢å®ç°ï¼ˆBadgerDB å¯æ¢ä¸ºå…¶ä»–åç«¯ï¼‰                                  â”‚
â”‚                                                                             â”‚
â”‚  4. å¢é‡è¿ç§» (Incremental Migration)                                        â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚     â€¢ å…ˆå®ç°å­˜å‚¨å¼•æ“                                                         â”‚
â”‚     â€¢ é€ä¸ªç»„ä»¶è¿ç§»                                                          â”‚
â”‚     â€¢ æ¯æ­¥éªŒè¯æ— å›å½’                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [layer_model.md](../../L2_structural/layer_model.md) | äº”å±‚è½¯ä»¶æ¶æ„ |
| [public_interfaces.md](../../L4_interfaces/public_interfaces.md) | å…¬å…±æ¥å£è®¾è®¡ |
| [component_interface_map.md](../../L4_interfaces/component_interface_map.md) | ç»„ä»¶æ¥å£æ˜ å°„ |

---

**æœ€åæ›´æ–°**ï¼š2026-01-16
