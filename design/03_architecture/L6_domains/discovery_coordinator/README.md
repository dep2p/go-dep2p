# Discovery Coordinator 模块

> **版本**: v1.3.0  
> **更新日期**: 2026-01-23  
> **定位**: 发现协调器（Discovery Layer）

---

## 模块概述

discovery_coordinator 是发现服务的**协调器**，负责统一调度各种发现组件。

| 属性 | 值 |
|------|-----|
| **架构层** | Discovery Layer |
| **代码位置** | `internal/discovery/` |
| **Fx 模块** | `fx.Module("discovery")` |
| **状态** | ✅ 已实现 |
| **依赖** | core_host, dht, mdns, bootstrap, rendezvous, dns, ★ core_reachability |

---

## 核心职责

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    discovery_coordinator 协调器职责                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 发现策略调度                                                             │
│     • 选择合适的发现组件                                                     │
│     • 管理发现优先级                                                        │
│     • 合并发现结果                                                          │
│                                                                             │
│  2. 组件注册管理                                                             │
│     • 注册发现组件                                                          │
│     • 组件生命周期管理                                                       │
│                                                                             │
│  3. 统一发现接口                                                             │
│     • FindPeers() 对外接口                                                  │
│     • Advertise() 广播接口                                                  │
│                                                                             │
│  4. ★ PeerFinder（v1.2.0 新增）                                             │
│     • 多级缓存节点查找（内存缓存 → Peerstore → 已连接 → 网络发现）           │
│     • 可配置的缓存 TTL 和大小                                               │
│     • 支持多种发现源                                                        │
│                                                                             │
│  5. ★ AddressAnnouncer（v1.2.0 新增）                                       │
│     • 定期地址刷新公告                                                       │
│     • 多命名空间支持                                                        │
│     • 可配置的刷新间隔                                                       │
│                                                                             │
│  6. ★ 地址发布前置过滤（v1.3.0 新增）                                        │
│     • 发布前依赖 Reachability 过滤/验证地址                                  │
│     • 只发布可达地址（候选地址需先验证）                                     │
│     • 不可达时发布 Relay 地址（需显式配置 Relay）                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Discovery 域架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Discovery 域架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  internal/discovery/                                                         │
│  ─────────────────────────────────────────                                  │
│                                                                             │
│  ┌───────────────────────┐                                                  │
│  │     coordinator/      │  ←── 发现协调器（统一调度）                        │
│  │                       │                                                  │
│  │  • FindPeers()        │                                                  │
│  │  • Advertise()        │                                                  │
│  │  • ★ PeerFinder       │  ←── 多级缓存查找                                │
│  │  • ★ AddressAnnouncer │  ←── 地址刷新公告                                │
│  └─────────┬─────────────┘                                                  │
│            │                                                                │
│            ├──────────┬──────────┬──────────┬──────────┬──────────┐        │
│            ↓          ↓          ↓          ↓          ↓          ↓        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│  │  dht/    │ │bootstrap/│ │  mdns/   │ │rendezvous│ │   dns/   │         │
│  │(Kademlia)│ │(引导节点)│ │(局域网)  │ │(命名空间)│ │(DNS-SD)  │         │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘         │
│                                                                             │
│  Core ↔ Discovery 双向协作                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 目录导航

| 文档 | 说明 |
|------|------|
| [requirements/requirements.md](requirements/requirements.md) | 需求追溯 |
| [design/overview.md](design/overview.md) | 整体设计 |
| [design/internals.md](design/internals.md) | 内部设计 |
| [coding/guidelines.md](coding/guidelines.md) | 编码指南 |
| [testing/strategy.md](testing/strategy.md) | 测试策略 |

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [L3: 发现流程](../../L3_behavioral/discovery_flow.md) | 行为设计 |
| [协议规范: Discovery](../../../../02_constraints/protocol/L3_network/) | 协议 |

---

**最后更新**：2026-01-19
