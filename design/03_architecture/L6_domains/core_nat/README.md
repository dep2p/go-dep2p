# Core NAT 模块

> **版本**: v1.2.0  
> **更新日期**: 2026-01-23  
> **定位**: NAT 穿透（Core Layer）

---

## 模块概述

core_nat 提供 NAT 穿透能力，包括 UPnP、NAT-PMP、STUN 和 Hole Punching。

| 属性 | 值 |
|------|-----|
| **架构层** | Core Layer |
| **代码位置** | `internal/core/nat/` |
| **Fx 模块** | `fx.Module("nat")` |
| **状态** | ✅ 已实现 |
| **依赖** | core_swarm, core_relay（信令通道） |

---

## 核心职责

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        core_nat 职责                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. NAT 类型检测                                                            │
│     • AutoNAT 协议检测                                                      │
│     • 判断可达性（Public/Private/Unknown）                                  │
│     • NAT 类型识别                                                          │
│                                                                             │
│  2. 端口映射                                                                │
│     • UPnP 端口映射                                                         │
│     • NAT-PMP 映射                                                          │
│     • 映射续期                                                              │
│                                                                             │
│  3. STUN                                                                    │
│     • 获取外部地址                                                          │
│     • 保持映射活跃                                                          │
│                                                                             │
│  4. Hole Punching                                                           │
│     • UDP 打洞                                                              │
│     • QUIC 打洞                                                             │
│     • 协调协议（/dep2p/sys/holepunch/1.0.0）                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## NAT 穿透策略

```
连接建立流程（惰性中继策略）：

  1. 尝试直连目标节点
       │
       ├── 成功 → 使用直连
       │
       └── 失败 → 2. 检查 NAT 类型组合
                     │
                     ├── 双方 Symmetric NAT → 跳过打洞，直接使用 Relay
                     │
                     └── 其他组合 → 3. 尝试 NAT 打洞（需信令通道）
                                        │
                                        ├── 成功 → 使用直连（★ 保留 Relay 连接作为备份）
                                        │
                                        └── 失败 → 使用 Relay 转发
```

---

## NAT 类型与打洞成功率

| NAT 类型 | 外部地址稳定性 | 打洞成功率 | 说明 |
|---------|---------------|-----------|------|
| Full Cone | 相对稳定 | 很高 | 映射后任意外部主机可访问 |
| Restricted Cone | 相对稳定 | 高 | 需要先发送包到对方 IP |
| Port Restricted | 相对稳定 | 中等 | 需要先发送包到对方 IP:Port |
| Symmetric | 不稳定 | 很低 | 每个目标分配不同端口，★ 建议跳过打洞直接使用 Relay |

### 打洞决策矩阵

```
┌──────────────────────────────────────────────────────────────────────┐
│  发起方 ╲ 目标方    Full Cone   Restricted   Port Restr   Symmetric  │
├──────────────────────────────────────────────────────────────────────┤
│  Full Cone          直连优先    打洞优先     打洞优先     打洞尝试   │
│  Restricted         打洞优先    打洞尝试     打洞尝试     Relay      │
│  Port Restricted    打洞优先    打洞尝试     打洞尝试     Relay      │
│  Symmetric          打洞尝试    Relay        Relay        Relay      │
└──────────────────────────────────────────────────────────────────────┘

★ 双方都是 Symmetric NAT 时，直接使用 Relay，不浪费时间打洞
```

---

## ★ NAT 类型检测的价值

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NAT 类型检测：值得实现                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  价值：                                                                      │
│  ═══════                                                                    │
│  1. 优化打洞决策                                                            │
│     • 识别 Symmetric NAT → 跳过打洞，节省 5-10 秒等待时间                   │
│     • 识别 Cone NAT → 积极尝试打洞，提高直连成功率                          │
│                                                                             │
│  2. 辅助连接超时设置                                                         │
│     • Symmetric NAT：较短超时，快速回退到 Relay                             │
│     • Cone NAT：较长超时，等待打洞成功                                      │
│                                                                             │
│  3. 诊断与监控                                                               │
│     • 了解网络环境，辅助运维                                                │
│     • 收集 NAT 类型分布数据，指导优化                                       │
│                                                                             │
│  实现成本：                                                                  │
│  ═══════════                                                                │
│  • 需要 2+ 个 STUN 服务器（检测端口映射规则）                               │
│  • 检测时间：2-5 秒                                                         │
│  • 可选实现：不影响核心功能，但显著提升用户体验                              │
│                                                                             │
│  推荐结论：★ 值得实现                                                       │
│  ═══════════════════════                                                    │
│  • NAT 类型检测是一次性成本（启动时检测）                                   │
│  • 但收益持续（每次连接都受益）                                             │
│  • 特别是 Symmetric NAT 场景，可避免无谓的打洞等待                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 目录结构

```
internal/core/nat/
├── doc.go
├── module.go           # Fx 模块
├── manager.go          # NAT 管理器
├── upnp/               # UPnP 实现
│   └── upnp.go
├── natpmp/             # NAT-PMP 实现
│   └── natpmp.go
├── stun/               # STUN 实现
│   └── stun.go
├── holepunch/          # ★ 打洞实现（与 L2 target_structure.md 一致）
│   ├── holepunch.go    # 打洞协调器
│   ├── signaling.go    # 信令通道抽象
│   └── protocol.go     # 打洞协议消息
└── autonat/            # AutoNAT 可达性检测
    └── autonat.go
```

---

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `EnableAutoNAT` | true | 启用 NAT 类型检测 |
| `EnableUPnP` | true | 启用 UPnP |
| `EnableNATPMP` | true | 启用 NAT-PMP |
| `EnableHolePunch` | true | 启用打洞 |
| `STUNServers` | 默认列表 | STUN 服务器（建议 2+ 个用于 NAT 类型检测） |
| `HolePunchTimeout` | 30s | 打洞超时（取决于网络环境） |
| `IPv6NATMode` | simplified | IPv6 环境下的 NAT 穿透模式 |

### IPv6NATMode 配置

| 模式 | 说明 |
|------|------|
| `full` | 完整 NAT 检测流程（保守） |
| `simplified` | 跳过 NAT 类型检测，保留可达性检测（★ 推荐，IPv6 通常无 NAT） |
| `disabled` | 完全跳过 NAT 穿透（仅在确认纯 IPv6 无防火墙环境） |

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    IPv6 环境策略                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  IPv6 的特点：                                                               │
│  • 通常无 NAT（全球可达地址）                                                │
│  • 但可能存在防火墙阻断入站连接                                              │
│  • 某些 ISP 仍使用 NAT64/DS-Lite                                            │
│                                                                             │
│  对比流程：                                                                  │
│  IPv4: STUN → NAT类型 → 直连/打洞 → Relay                                   │
│  IPv6: 直连 → 可达性检测 → Relay（简化流程）                                 │
│                                                                             │
│  推荐默认值：simplified                                                      │
│  • 跳过 STUN NAT 类型检测（节省时间）                                        │
│  • 保留 AutoNAT 可达性检测（检测防火墙）                                     │
│  • 保留 Relay 作为 fallback（保障通达）                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 与 Relay 的协作

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    打洞协调需要信令通道                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  核心需求：双方需要一个可通信的信令通道来交换打洞信息                         │
│                                                                             │
│  信令通道来源（ADR-0010）：                                                  │
│  • ★ 显式配置的 Relay 连接（主要来源）                                      │
│  • 已有的其他连接（备选）                                                    │
│  • 不支持自动发现 Relay 作为信令通道                                         │
│                                                                             │
│  为什么 Relay 连接是主要选择？                                               │
│  1. 双方都在 NAT 后且没有已建立的连接                                        │
│  2. Relay 连接是首先能建立的连接                                             │
│  3. 复用 Relay 连接作为信令通道，不需要额外基础设施                          │
│                                                                             │
│  依赖模块：core_relay 提供 Signaling 能力                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 可达性验证链路（关键）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    候选地址 → 可达地址 → 发布链路                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ★ STUN/观察地址返回的是"候选地址"，不能直接发布到 DHT                       │
│                                                                             │
│  链路流程：                                                                  │
│  ═══════════                                                                │
│                                                                             │
│  core_nat (STUN/Observed)                                                   │
│       │                                                                     │
│       │ 产出：候选地址（可能不可达）                                         │
│       ↓                                                                     │
│  core_reachability (AutoNAT/dialback)                                       │
│       │                                                                     │
│       │ 验证：外部能否连入？                                                 │
│       ↓                                                                     │
│  [验证通过?]                                                                │
│       │                                                                     │
│       ├── 是 → discovery_dht 发布直连地址                                   │
│       │                                                                     │
│       └── 否 → discovery_dht 发布 Relay 地址（需已配置 Relay）              │
│                                                                             │
│  ★ 关键约束：DHT 只发布经过 Reachability 验证的地址                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [core_relay](../core_relay/) | 中继服务 + 打洞信令通道 |
| [core_swarm](../core_swarm/) | 连接群管理 |
| [core_reachability](../core_reachability/) | 可达性检测 |
| [L2: 五层架构](../../L2_structural/layer_model.md) | 架构定义 |

---

**最后更新**：2026-01-23
