# core_nat æ•´ä½“è®¾è®¡

> æ¨¡å—æ¶æ„ä¸ç»„ä»¶è®¾è®¡

---

## æ¨¡å—æ¶æ„

```mermaid
flowchart TB
    subgraph Public["å…¬å…±æ¥å£"]
        NATService["nat.Service"]
        HolePuncher["nat.HolePuncher"]
    end
    
    subgraph Internal["å†…éƒ¨å®ç°"]
        Detector["NATDetector"]
        NetReport["NetReportClient"]
        UPnP["UPnPMapper"]
        STUN["STUNClient"]
        Puncher["UDPPuncher"]
    end
    
    NATService --> Detector
    NATService --> NetReport
    NATService --> UPnP
    NATService --> STUN
    HolePuncher --> Puncher
    Puncher --> STUN
```

---

## æ ¸å¿ƒç»„ä»¶

### Service æ¥å£

```pseudocode
interface Service {
    // GetExternalAddr è·å–å¤–éƒ¨åœ°å€ï¼ˆâ˜… å€™é€‰åœ°å€ï¼Œéœ€éªŒè¯ï¼‰
    GetExternalAddr() -> Result<Multiaddr, Error>
    
    // MapPort æ˜ å°„ç«¯å£
    MapPort(ctx: Context, proto: string, port: int) -> Result<int, Error>
    
    // UnmapPort å–æ¶ˆæ˜ å°„
    UnmapPort(proto: string, port: int) -> Result<(), Error>
    
    // Reachability è¿”å›å¯è¾¾æ€§
    Reachability() -> Reachability
}
```

### â˜… å€™é€‰åœ°å€ vs å¯å‘å¸ƒåœ°å€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å€™é€‰åœ°å€ vs å¯å‘å¸ƒåœ°å€ï¼ˆå…³é”®åŒºåˆ†ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  GetExternalAddr() è¿”å›çš„æ˜¯ã€å€™é€‰åœ°å€ã€‘ï¼š                                    â”‚
â”‚  â€¢ æ¥æºï¼šSTUN æ¢æµ‹ã€UPnP æ˜ å°„ã€è§‚å¯Ÿåœ°å€                                     â”‚
â”‚  â€¢ çŠ¶æ€ï¼šæœªéªŒè¯ï¼Œå¯èƒ½ä¸å¯è¾¾                                                  â”‚
â”‚  â€¢ ç”¨é€”ï¼šä½œä¸ºæ‰“æ´å€™é€‰ã€Reachability éªŒè¯è¾“å…¥                                â”‚
â”‚                                                                             â”‚
â”‚  å¯å‘å¸ƒåœ°å€éœ€è¦ç»è¿‡ã€Reachability éªŒè¯ã€‘ï¼š                                   â”‚
â”‚  â€¢ éªŒè¯ï¼šé€šè¿‡ dialback æˆ– AutoNAT ç¡®è®¤å¯è¾¾æ€§                                â”‚
â”‚  â€¢ çŠ¶æ€ï¼šCandidate â†’ Validating â†’ Reachable â†’ Published                    â”‚
â”‚  â€¢ ç”¨é€”ï¼šå‘å¸ƒåˆ° DHTã€é€šçŸ¥ Relay åœ°å€ç°¿                                      â”‚
â”‚                                                                             â”‚
â”‚  â˜… å…³é”®çº¦æŸï¼š                                                               â”‚
â”‚  â€¢ ä¸è¦ç›´æ¥å‘å¸ƒ GetExternalAddr() çš„ç»“æœ                                    â”‚
â”‚  â€¢ å¿…é¡»ç»è¿‡ Reachability æ¨¡å—éªŒè¯                                           â”‚
â”‚  â€¢ è§‚å¯Ÿåœ°å€ï¼ˆå¤šæ¥æºï¼‰éœ€è¦ä¸€è‡´æ€§æ£€æŸ¥                                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### HolePuncher æ¥å£

```pseudocode
interface HolePuncher {
    // DirectConnect å°è¯•ç›´è¿
    DirectConnect(ctx: Context, peer: NodeID, addrs: []Multiaddr) -> Result<(), Error>
    
    // HolePunch é€šè¿‡ä¿¡ä»¤é€šé“åè°ƒæ‰“æ´
    HolePunch(ctx: Context, peer: NodeID, signaling: SignalingChannel) -> Result<Connection, Error>
    
    // CanHolePunch åˆ¤æ–­æ˜¯å¦å€¼å¾—å°è¯•æ‰“æ´
    CanHolePunch(localNAT: NATType, remoteNAT: NATType) -> bool
}
```

### NetReport è¯Šæ–­ï¼ˆå†…éƒ¨ä¾èµ–ï¼‰

- æä¾› IPv4/IPv6 è¿é€šæ€§ã€NAT ç±»å‹ã€STUN æ¢æµ‹ç»“æœ
- ä¸º Reachability å’Œåœ°å€å‘å¸ƒæä¾›ä¾æ®
- STUN æ¢æµ‹æ”¯æŒå¤šæœåŠ¡å™¨ä¸å…œåº•é‡è¯•

---

## â˜… UDP vs TCP æ‰“æ´å·®å¼‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UDP vs TCP æ‰“æ´å·®å¼‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âš ï¸ DeP2P ä½¿ç”¨ QUICï¼ˆåŸºäº UDPï¼‰ï¼Œä¸»è¦è®¨è®º UDP æ‰“æ´                           â”‚
â”‚                                                                             â”‚
â”‚  UDP æ‰“æ´ï¼š                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•                                                                 â”‚
â”‚  â€¢ æˆåŠŸç‡è¾ƒé«˜ï¼ˆæ— è¿æ¥çŠ¶æ€ï¼‰                                                  â”‚
â”‚  â€¢ åŒæ–¹åŒæ—¶å‘åŒ…å³å¯"æ‰“æ´"                                                   â”‚
â”‚  â€¢ NAT åªéœ€çœ‹åˆ°å‡ºç«™åŒ…å³å»ºç«‹æ˜ å°„                                              â”‚
â”‚  â€¢ é€‚åˆ P2P åœºæ™¯ï¼ˆQUICã€WebRTC ICEï¼‰                                        â”‚
â”‚                                                                             â”‚
â”‚  TCP æ‰“æ´ï¼š                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•                                                                 â”‚
â”‚  â€¢ æˆåŠŸç‡è¾ƒä½ï¼ˆéœ€è¦ç²¾ç¡®æ—¶åºï¼‰                                                â”‚
â”‚  â€¢ éœ€è¦ TCP Simultaneous Openï¼ˆåŒæ—¶æ‰“å¼€ï¼‰                                   â”‚
â”‚  â€¢ å®ç°å¤æ‚ï¼šéœ€è¦ç»‘å®šç›¸åŒæœ¬åœ°ç«¯å£ã€å¤„ç† RST ç­‰                               â”‚
â”‚  â€¢ æŸäº› NAT ä¸æ”¯æŒ TCP æ‰“æ´                                                  â”‚
â”‚                                                                             â”‚
â”‚  å¯¹æ¯”ï¼š                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       ç‰¹æ€§            UDP æ‰“æ´           TCP æ‰“æ´                    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚   æˆåŠŸç‡             è¾ƒé«˜               è¾ƒä½                         â”‚   â”‚
â”‚  â”‚   å®ç°å¤æ‚åº¦         ä½                 é«˜                           â”‚   â”‚
â”‚  â”‚   æ—¶åºè¦æ±‚           å®½æ¾               ä¸¥æ ¼ï¼ˆéœ€åŒæ—¶å‘ SYNï¼‰         â”‚   â”‚
â”‚  â”‚   NAT å…¼å®¹æ€§         å¥½                 å·®ï¼ˆéƒ¨åˆ† NAT ä¸æ”¯æŒï¼‰        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â˜… DeP2P é€‰æ‹© QUIC-onlyï¼ˆåŸºäº UDPï¼‰ï¼Œä¸»è¦è€ƒè™‘ UDP æ‰“æ´çš„é«˜æˆåŠŸç‡            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â˜… æ‰“æ´åœ°å€çš„é€‚ç”¨æ¡ä»¶ä¸é™åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ‰“æ´åœ°å€çš„é€‚ç”¨æ¡ä»¶ä¸é™åˆ¶                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âš ï¸ è§‚å¯Ÿåœ°å€ä¸ä¸€å®šé€‚åˆæ‰“æ´ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š                               â”‚
â”‚                                                                             â”‚
â”‚  é€‚ç”¨æ¡ä»¶ï¼š                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                 â”‚
â”‚  âœ… NAT ç±»å‹ä¸º Cone NATï¼ˆFull/Restricted/Port Restrictedï¼‰                  â”‚
â”‚  âœ… è§‚å¯Ÿåœ°å€ä¸æ‰“æ´ä½¿ç”¨ç›¸åŒåè®®ï¼ˆUDP/UDP æˆ– TCP/TCPï¼‰                        â”‚
â”‚  âœ… è§‚å¯Ÿåœ°å€åœ¨æ‰“æ´çª—å£å†…ä»ç„¶æœ‰æ•ˆ                                            â”‚
â”‚                                                                             â”‚
â”‚  ä¸é€‚ç”¨æƒ…å†µï¼š                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  âŒ Symmetric NATï¼šæ¯ä¸ªè¿æ¥åˆ†é…ä¸åŒç«¯å£ï¼Œè§‚å¯Ÿåœ°å€å¯¹å…¶ä»–ç›®æ ‡æ— æ•ˆ              â”‚
â”‚  âŒ åè®®ä¸åŒ¹é…ï¼šTCP è¿æ¥è·å–çš„åœ°å€ä¸èƒ½ç”¨äº UDP æ‰“æ´                         â”‚
â”‚  âŒ åœ°å€å·²è¿‡æœŸï¼šNAT æ˜ å°„è¶…æ—¶ååœ°å€å¤±æ•ˆ                                       â”‚
â”‚  âŒ ç«¯å£å¤ç”¨åœºæ™¯ï¼šå¤šä¸ªåº”ç”¨å…±äº«ç«¯å£æ—¶å¯èƒ½å†²çª                                 â”‚
â”‚                                                                             â”‚
â”‚  æœ€ä½³å®è·µï¼š                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                 â”‚
â”‚  â€¢ æ‰“æ´å‰é‡æ–°è·å–æœ€æ–°çš„å¤–éƒ¨åœ°å€                                              â”‚
â”‚  â€¢ ç»“åˆ NAT ç±»å‹æ£€æµ‹åˆ¤æ–­æ‰“æ´å¯è¡Œæ€§                                          â”‚
â”‚  â€¢ Symmetric NAT åº”è·³è¿‡æ‰“æ´ç›´æ¥ä½¿ç”¨ Relay                                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â˜… æ‰“æ´å†³ç­–ç®—æ³•

```pseudocode
function canHolePunch(localNAT: NATType, remoteNAT: NATType) -> bool {
    // åŒæ–¹éƒ½æ˜¯ Symmetric NAT â†’ ç›´æ¥æ”¾å¼ƒï¼Œä½¿ç”¨ Relay
    if localNAT == Symmetric && remoteNAT == Symmetric {
        return false
    }
    
    // ä»»ä¸€æ–¹æ˜¯ Symmetricï¼ŒæˆåŠŸç‡è¾ƒä½ï¼Œä½†ä»å¯å°è¯•
    if localNAT == Symmetric || remoteNAT == Symmetric {
        // å¯¹æ–¹ä¸æ˜¯ Symmetric æ—¶ä»æœ‰æœºä¼š
        return remoteNAT != Symmetric || localNAT != Symmetric
    }
    
    // å…¶ä»– Cone NAT ç»„åˆï¼Œå€¼å¾—å°è¯•
    return true
}

function selectConnectionStrategy(localNAT: NATType, remoteNAT: NATType) -> Strategy {
    // ä¼˜å…ˆçº§ 1: ç›´è¿ï¼ˆå¯¹æ–¹å…¬ç½‘å¯è¾¾ï¼‰
    if remoteReachability == Public {
        return Strategy.Direct
    }
    
    // ä¼˜å…ˆçº§ 2: æ‰“æ´ï¼ˆNAT ç±»å‹å…è®¸ï¼‰
    if canHolePunch(localNAT, remoteNAT) {
        return Strategy.HolePunch
    }
    
    // ä¼˜å…ˆçº§ 3: Relay ä¿åº•
    return Strategy.Relay
}
```

---

## NAT ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          NAT ç±»å‹                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Full Cone                                                                  â”‚
â”‚  â€¢ æ˜ å°„åä»»æ„å¤–éƒ¨ä¸»æœºå¯è®¿é—®                                                  â”‚
â”‚  â€¢ æœ€å®¹æ˜“ç©¿é€                                                               â”‚
â”‚                                                                             â”‚
â”‚  Restricted Cone                                                            â”‚
â”‚  â€¢ åªæœ‰é€šä¿¡è¿‡çš„ IP å¯è®¿é—®                                                   â”‚
â”‚  â€¢ éœ€è¦å…ˆå‘é€åŒ…                                                             â”‚
â”‚                                                                             â”‚
â”‚  Port Restricted Cone                                                       â”‚
â”‚  â€¢ åªæœ‰é€šä¿¡è¿‡çš„ IP:Port å¯è®¿é—®                                              â”‚
â”‚  â€¢ éœ€è¦å…ˆå‘é€åŒ…åˆ°æ­£ç¡®ç«¯å£                                                   â”‚
â”‚                                                                             â”‚
â”‚  Symmetric                                                                  â”‚
â”‚  â€¢ æ¯ä¸ªç›®æ ‡ä¸åŒæ˜ å°„                                                         â”‚
â”‚  â€¢ æœ€éš¾ç©¿é€ï¼Œé€šå¸¸éœ€è¦ä¸­ç»§                                                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¯è¾¾æ€§çŠ¶æ€

```
type Reachability int

const (
    ReachabilityUnknown  Reachability = iota
    ReachabilityPublic   // å…¬ç½‘å¯è¾¾
    ReachabilityPrivate  // NAT å
)
```

---

## Fx æ¨¡å—å®šä¹‰

```
var Module = fx.Module("nat",
    fx.Provide(
        NewService,
        NewHolePuncher,
    ),
)
```

---

## ç½‘ç»œå˜åŒ–å¤„ç†

### Major Change å¤„ç†æµç¨‹ï¼ˆv1.0 å®ç°çŠ¶æ€ï¼‰

```mermaid
flowchart TB
    Detect["æ£€æµ‹åˆ°ç½‘ç»œå˜åŒ–"]
    
    Detect --> Rebind["1. Socket Rebind âœ…"]
    Rebind --> DNS["2. DNS é‡ç½® ğŸ”"]
    DNS --> STUN["3. Re-STUN ğŸ”"]
    STUN --> Reset["4. é‡ç½®ç«¯ç‚¹çŠ¶æ€ ğŸ”"]
    Reset --> Update["5. æ›´æ–° DHT åœ°å€ ğŸ”"]
    Update --> Notify["6. é€šçŸ¥ Realm æˆå‘˜ ğŸ”"]
    
    style Rebind fill:#90EE90
    style DNS fill:#FFE4B5
    style STUN fill:#FFE4B5
    style Reset fill:#FFE4B5
    style Update fill:#FFE4B5
    style Notify fill:#FFE4B5
```

### å®ç°è¦†ç›–æƒ…å†µ

| æ­¥éª¤ | å®ç°ä½ç½® | çŠ¶æ€ | è¯´æ˜ |
|------|----------|------|------|
| 1. Socket Rebind | `internal/core/transport/quic/rebind.go` | âœ… å·²å®ç° | å…³é—­æ—§ socketï¼Œåˆ›å»ºæ–° socketï¼Œæ›´æ–°åœ°å€ç¼“å­˜ |
| 2. DNS é‡ç½® | - | ğŸ” å¾…å®šä½ | éœ€ç¡®è®¤ DNS resolver é‡ç½®é€»è¾‘ |
| 3. Re-STUN | `internal/core/nat/netreport/client.go` | ğŸ” éœ€ç¡®è®¤ | NetReport æ˜¯å¦è‡ªåŠ¨è§¦å‘é‡æ–°æ¢æµ‹ |
| 4. é‡ç½®ç«¯ç‚¹çŠ¶æ€ | - | ğŸ” å¾…å®šä½ | éœ€ç¡®è®¤ Swarm/Transport çŠ¶æ€é‡ç½® |
| 5. æ›´æ–° DHT åœ°å€ | - | ğŸ” å¾…å®šä½ | éœ€ç¡®è®¤ DHT åœ°å€æ›´æ–°æœºåˆ¶ |
| 6. é€šçŸ¥ Realm æˆå‘˜ | `internal/realm/protocol/capability.go` | âœ… å·²å®ç° | `ReBroadcast()` æ–¹æ³•é‡æ–°å¹¿æ’­èƒ½åŠ› |

### ç½‘ç»œç›‘æ§ç»„ä»¶

```
ç»„ä»¶ç»“æ„ï¼š

  internal/core/recovery/netmon/
  â”œâ”€â”€ monitor.go           # ç½‘ç»œç›‘æ§å™¨ï¼ˆProber + SystemWatcherï¼‰
  â”œâ”€â”€ config.go            # é…ç½®å‚æ•°ï¼ˆæŠ–åŠ¨å®¹å¿ã€é€€é¿ç­–ç•¥ï¼‰
  â””â”€â”€ status.go            # è¿æ¥å¥åº·çŠ¶æ€ç®¡ç†
  
  å®ç°ç‰¹æ€§ï¼š
  â€¢ ç³»ç»Ÿçº§äº‹ä»¶ç›‘å¬ï¼ˆå¹³å°åŸç”Ÿï¼‰
  â€¢ ä¸»åŠ¨æ¢æµ‹ï¼ˆProberï¼‰
  â€¢ çŠ¶æ€æœºï¼šHealthy â†’ Degraded â†’ Down â†’ Recovering
  â€¢ æŠ–åŠ¨å®¹å¿å‚æ•°ï¼š
    - ErrorThreshold: é”™è¯¯é˜ˆå€¼
    - ProbeInterval: æ¢æµ‹é—´éš”
    - StateChangeDebounce: çŠ¶æ€å˜åŒ–å»æŠ–
```

### é…ç½®å‚æ•°å¯¹ç…§

| è§„èŒƒå‚æ•° | å®ç°å‚æ•° | ä½ç½® | è¯´æ˜ |
|---------|---------|------|------|
| ToleranceWindow | StateChangeDebounce | `netmon/config.go` | å®¹é”™çª—å£/çŠ¶æ€å»æŠ– |
| StateHoldTime | - | - | çŠ¶æ€ä¿æŒæ—¶é—´ï¼ˆæœªæ˜ç¡®å®ç°ï¼‰ |
| InitialReconnectDelay | InitialBackoff | `netmon/config.go` | åˆå§‹é‡è¿/é€€é¿å»¶è¿Ÿ |
| MaxReconnectDelay | MaxBackoff | `netmon/config.go` | æœ€å¤§é‡è¿/é€€é¿å»¶è¿Ÿ |
| MaxReconnectAttempts | MaxRecoveryAttempts | `netmon/config.go` | æœ€å¤§é‡è¿/æ¢å¤æ¬¡æ•° |
| BackoffMultiplier | BackoffFactor | `netmon/config.go` | é€€é¿ä¹˜æ•°/å› å­ |

âš ï¸ **v1.0 çŠ¶æ€**ï¼šæ ¸å¿ƒç½‘ç»œç›‘æ§å·²å®ç°ï¼ŒMajor Change 6 æ­¥æµç¨‹éƒ¨åˆ†è¦†ç›–ï¼Œéƒ¨åˆ†æ­¥éª¤éœ€è¿›ä¸€æ­¥ç¡®è®¤å’Œé›†æˆã€‚

---

**æœ€åæ›´æ–°**ï¼š2026-01-23
