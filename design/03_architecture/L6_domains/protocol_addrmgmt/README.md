# AddrMgmt 模块设计

> **版本**: v1.2.0  
> **更新日期**: 2026-01-23  
> **定位**: Protocol Layer - 地址管理协议

## 概述

addrmgmt 模块实现地址管理协议，负责地址记录签名、刷新通知和邻居查询。

**★ 职责定位**：addrmgmt 是"地址刷新通知协议"，不是"权威目录"（DHT 才是权威目录）。

## 核心功能

1. **地址签名** - 对地址记录签名
2. **刷新通知** - 广播地址更新
3. **邻居查询** - 查询邻居地址
4. **过期清理** - 清理过期地址

## ★ 职责边界说明（关键）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    addrmgmt vs Relay 地址簿（职责区分）                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  addrmgmt 职责（地址刷新通知）：                                             │
│  ════════════════════════════                                               │
│  • 当节点地址变化时，通知已连接的邻居                                       │
│  • 点对点协议：向特定节点推送地址更新                                       │
│  • 不提供"地址发现"能力：不能通过它找到未知节点的地址                       │
│  • 依赖已有连接：只能通知已连接的节点                                       │
│                                                                             │
│  Relay 地址簿职责（缓存加速层，非权威目录）：                                │
│  ═══════════════════════════════                                            │
│  • 维护 Realm/系统 范围内所有成员的地址信息                                 │
│  • 提供"地址发现"能力：可以查询未连接节点的地址                             │
│  • 中心化存储：Relay 节点聚合所有成员地址                                   │
│  • 支持"仅 ID 连接"的地址解析                                               │
│                                                                             │
│  协作关系：                                                                  │
│  ──────────                                                                 │
│  1. 节点地址变化 → addrmgmt 通知邻居 + 更新到 Relay 地址簿                 │
│  2. 连接新节点时 → Relay 地址簿查询（addrmgmt 不参与）                      │
│  3. 邻居地址缓存 → addrmgmt 协助保持邻居地址最新                            │
│                                                                             │
│  ⚠️ 避免职责重叠：                                                          │
│  • addrmgmt 不尝试替代 Relay 地址簿的发现功能                               │
│  • Relay 地址簿不依赖 addrmgmt 进行地址收集                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## ★ 地址级别标记（v1.2.0 新增）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    addrmgmt 地址刷新中的地址级别                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  消息中的地址必须标记级别：                                                  │
│  ═══════════════════════════                                                │
│                                                                             │
│  AddressRefreshNotify 消息扩展：                                            │
│  ─────────────────────────────                                              │
│  每个地址需附带 AddressState 标签：                                         │
│                                                                             │
│  • Candidate (候选)：未验证地址，接收方存入 Peerstore 时 TTL=3min           │
│  • Verified (已验证)：经过 Reachability 验证，TTL=30min                     │
│  • Connected (已连接)：已实际使用的地址，TTL=30min                          │
│                                                                             │
│  接收方处理规则：                                                            │
│  ────────────────                                                           │
│  1. 根据发送方标记的级别设置 TTL                                            │
│  2. ❌ 不信任发送方声称的 Verified，除非有签名证明                          │
│  3. 实际使用：以本地验证结果为准                                            │
│                                                                             │
│  签名验证：                                                                  │
│  ──────────                                                                 │
│  • 整个 AddressRefreshNotify 消息需签名                                     │
│  • 签名验证发送方身份（NodeID 匹配）                                        │
│  • ⚠️ 签名只验证"这是他声称的地址"，不验证"地址可达"                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 协议 ID

```
/dep2p/sys/addr-mgmt/1.0.0
```

## 代码位置

```
internal/protocol/addrmgmt/
├── doc.go           # 包文档
├── handler.go       # 协议处理器
├── handler_test.go
├── scheduler.go     # 刷新调度器
└── scheduler_test.go
```

## 消息格式

```
AddressRefreshNotify (v1.2.0):
  [NodeID: 32 bytes]
  [RealmID length: 2 bytes]
  [RealmID: variable]
  [Sequence: 8 bytes]           # 单调递增序列号
  [Timestamp: 8 bytes]          # Unix 纳秒时间戳
  [AddressCount: 2 bytes]
  [Addresses: variable]         # 见下方结构
  [Signature: variable]         # Ed25519 签名

AddressEntry (v1.2.0 扩展):
  [AddrLength: 2 bytes]
  [Multiaddr: variable]
  [State: 1 byte]               # ★ 新增：0=Candidate, 1=Verified, 2=Connected
  [TTLHint: 4 bytes]            # ★ 新增：建议 TTL（秒），接收方可选遵守
```

## 依赖

- Identity 模块（签名）
- Peerstore 模块（地址存储）
- core_reachability 模块（地址验证状态）

## 相关文档

| 文档 | 说明 |
|------|------|
| [core_peerstore](../core_peerstore/) | 地址存储与 TTL 管理 |
| [core_reachability](../core_reachability/) | 地址可达性验证 |
| [core_relay](../core_relay/) | Relay 地址簿（缓存加速层，非权威） |

---

**最后更新**：2026-01-23
