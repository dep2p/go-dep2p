# core_relay 需求

> 需求追溯与规格说明

---

## 功能需求

### FR-REL-001: 统一 Relay 服务

| 属性 | 说明 |
|------|------|
| 描述 | 系统应提供统一的 Relay 服务 |
| 优先级 | P0 |
| 验收标准 | 单一 Relay 概念，无控制面/数据面分层 |
| 来源 | ADR-0010（显式配置）|

### FR-REL-002: Relay 三大职责 (v2.0)

| 属性 | 说明 |
|------|------|
| 描述 | Relay 应同时支持三大职责（v2.0：DHT 是权威目录，Relay 是缓存/信令/保底） |
| 优先级 | P0 |
| 验收标准 | 1) 缓存加速层（地址簿，非权威）2) 打洞协调信令 3) 数据保底（转发）|

### FR-REL-003: 地址簿服务（第一层）

| 属性 | 说明 |
|------|------|
| 描述 | Relay 应维护成员地址簿 |
| 优先级 | P0 |
| 验收标准 | 支持地址注册、查询、更新 |

### FR-REL-004: 信令通道（第二层）

| 属性 | 说明 |
|------|------|
| 描述 | Relay 应提供打洞协调信令通道 |
| 优先级 | P0 |
| 验收标准 | 转发 CONNECT_REQ/CONNECT_RSP 消息 |

### FR-REL-005: 数据转发（第三层）

| 属性 | 说明 |
|------|------|
| 描述 | 直连/打洞失败后，Relay 应转发数据 |
| 优先级 | P0 |
| 验收标准 | 确保成员总是可达 |

### FR-REL-006: 连接优先级 (INV-003)

| 属性 | 说明 |
|------|------|
| 描述 | 连接应按优先级尝试：直连 → 打洞 → Relay |
| 优先级 | P0 |
| 验收标准 | Relay 是兜底，不是常态 |

### FR-REL-007: ★ 打洞后保留 Relay

| 属性 | 说明 |
|------|------|
| 描述 | 打洞成功后应保留 Relay 连接作为备份 |
| 优先级 | P0 |
| 验收标准 | Relay 连接不因打洞成功而断开 |

### FR-REL-008: 中继选择（多 Relay 场景）

| 属性 | 说明 |
|------|------|
| 描述 | 多 Relay 场景下应遵循"发布哪个用哪个"原则 |
| 优先级 | P1 |
| 验收标准 | 优先使用目标节点发布的 Relay |

### FR-REL-009: 故障转移

| 属性 | 说明 |
|------|------|
| 描述 | Relay 失败时应自动切换（如有备选）|
| 优先级 | P1 |
| 验收标准 | 无感知切换，指数退避重试 |

---

## 非功能需求

### NFR-REL-001: 预留管理

| 属性 | 说明 |
|------|------|
| 描述 | Relay 应支持预留 TTL 和续期 |
| 验收标准 | TTL=1h, 续期=30min, 续期窗口=5min, 最大失败=3 |

### NFR-REL-002: 资源限制

| 属性 | 说明 |
|------|------|
| 描述 | Relay 默认不限流，由提供者配置 |
| 验收标准 | 带宽/每节点并发电路数 (MaxCircuitsPerPeer)/总电路数 (MaxCircuits) 可配置 |

### NFR-REL-003: 重试策略

| 属性 | 说明 |
|------|------|
| 描述 | 地址更新失败应使用指数退避重试 |
| 验收标准 | 初始=1s, 因子=2, 最大=30s, 最大次数=5, 抖动=±20% |

---

**最后更新**：2026-01-23
