# Core Relay 模块

> **版本**: v2.0.0  
> **更新日期**: 2026-01-23  
> **定位**: 统一中继服务（Core Layer）

---

## 模块概述

core_relay 提供**统一 Relay 服务**，实现 NAT 后节点的连接。

> **★ 重要变更**：不再区分控制面/数据面中继，统一为单一 Relay 概念。

| 属性 | 值 |
|------|-----|
| **架构层** | Core Layer |
| **代码位置** | `internal/core/relay/` |
| **协议** | `/dep2p/relay/1.0.0/{hop,stop}` (Circuit v2) |
| **Fx 模块** | `fx.Module("relay")` |
| **状态** | ✅ 已实现 |
| **依赖** | core_swarm, core_host（注：core_nat 依赖 core_relay 的信令通道，非反向） |

---

## 设计原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        core_relay 设计原则                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ★ 核心理念：中继是系统能力，对用户业务透明                                 │
│                                                                             │
│  • P2P 优先：直连是核心，中继是辅助                                         │
│  • 惰性连接：按需使用，直连失败才走中继                                     │
│  • 业务透明：用户业务无需关心中继，系统自动处理                             │
│  • 显式配置：Relay 地址需要配置（ADR-0010）                                 │
│  • ★ 统一设计：不区分控制面/数据面中继，只有一个 Relay 概念                 │
│  • ★ 三大职责 v2.0：缓存加速层 + 打洞协调信令 + 数据通信保底                │
│  • ★ 打洞后保留：打洞成功后保留 Relay 连接作为备份                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 显式配置原则（ADR-0010）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Relay 显式配置原则                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ★ 核心理念：Relay 地址必须明确知道，无自动发现                             │
│                                                                             │
│  配置方式：                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  // 启用 Relay 服务端能力（成为 Relay 提供者）                       │   │
│  │  node.EnableRelay(ctx)                                              │   │
│  │                                                                     │   │
│  │  // 配置要使用的 Relay 地址（作为客户端）                            │   │
│  │  node.SetRelayAddr("/ip4/relay.dep2p.io/tcp/4001/p2p/...")          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  提供者类型：                                                                │
│  • 项目方部署的公共 Relay                                                   │
│  • 社区成员自愿提供的 Relay                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ Relay 三大职责 v2.0（核心设计）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Relay 三大职责 v2.0（★ 核心概念）                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ★ v2.0 核心原则：DHT 是权威目录，Relay 是缓存/信令/保底                    │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  职责一：缓存加速层（非权威目录）                                            │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  • Relay 维护所有连接成员的地址信息（地址簿）                               │
│  • 成员加入后自动向 Relay 注册地址                                          │
│  • 成员可通过 Relay 查询其他成员的地址                                      │
│  • 获取地址后，优先尝试直连                                                 │
│                                                                             │
│  Alice ──"Bob 地址？"──▶ Relay ──"2.2.2.2:4001"──▶ Alice ──直连──▶ Bob    │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  第二层：信令通道（Signaling Channel）                                       │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  • Relay 连接同时作为打洞协调的信令通道                                     │
│  • 打洞需要双方交换候选地址，信令通道是必要前提                             │
│  • 这就是为什么"先 Relay 连接，再尝试打洞"                                  │
│                                                                             │
│  Alice ──[打洞请求]──▶ Relay ──[转发]──▶ Bob                               │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  第三层：数据通信保底（Data Relay Fallback）                                 │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  • 只有直连和打洞都失败时才使用 Relay 转发数据                              │
│  • 确保成员总是可达（真正的保底）                                           │
│                                                                             │
│  Alice ─────────[Relay 转发]───────── Bob                                   │
│                                                                             │
│  ★ 设计目标：70-80% 直连成功，Relay 不成为瓶颈                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心职责

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        core_relay 职责                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 统一 Relay 服务                                                         │
│     • 服务经过认证的成员                                                    │
│     • 支持所有 DeP2P 协议（/dep2p/*）                                       │
│     • 提供者: 项目方或社区成员                                              │
│     • 配置: node.EnableRelay() 启用服务端，node.SetRelayAddr() 配置客户端  │
│                                                                             │
│  2. 中继客户端                                                               │
│     • 使用显式配置的 Relay 地址                                             │
│     • 透明建立中继电路                                                      │
│     • 预留管理（TTL=1h，续租=30min）                                        │
│                                                                             │
│  3. 中继服务端                                                               │
│     • 预留处理                                                              │
│     • 资源限制（流量、时间、连接数）                                        │
│     • PSK 认证验证                                                          │
│                                                                             │
│  4. 地址簿服务                                                               │
│     • 维护成员地址信息                                                      │
│     • 支持地址注册、查询、更新                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 公共接口

### Node 级别接口

```pseudocode
interface Node:
    // Relay 服务端能力
    EnableRelay(ctx: Context) -> error     // 启用 Relay 服务端能力
    DisableRelay(ctx: Context) -> error    // 禁用 Relay 服务端能力
    IsRelayEnabled() -> bool               // 查询是否已启用
    
    // Relay 客户端配置
    SetRelayAddr(addr: Multiaddr) -> error // 设置要使用的 Relay 地址
    RemoveRelayAddr() -> error             // 移除 Relay 地址
    RelayAddr() -> (Multiaddr, bool)       // 获取当前配置的地址

// RelayStats 统计信息
type RelayStats:
    Enabled: bool              // 是否启用
    ActiveCircuits: int        // 活跃电路数
    TotalRelayed: uint64       // 累计转发字节
    ReservationCount: int      // 当前预留数
    AddressBookSize: int       // 地址簿大小
```

---

## 目录结构

```
internal/core/relay/
├── doc.go
├── module.go              # Fx 模块
├── manager.go             # 中继管理
├── client/                # 中继客户端
│   ├── autorelay.go      # 自动中继
│   └── upgrader.go       # 连接升级
├── server/                # 中继服务端
│   └── server.go
└── addressbook/           # ★ 地址簿
    ├── addressbook.go    # MemberAddressBook 聚合根
    ├── entry.go          # MemberEntry 实体
    ├── protocol.go       # 地址发布/查询协议
    └── store.go          # 持久化存储接口
```

---

## ★ 地址簿模块（AddressBook）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    地址簿模块设计                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  数据模型：                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ MemberAddressBook (聚合根)                                           │   │
│  │   ├── entries        map[NodeID]MemberEntry                          │   │
│  │   └── store          AddressBookStore                                │   │
│  │                                                                       │   │
│  │ MemberEntry (实体)                                                    │   │
│  │   ├── NodeID         types.NodeID                                    │   │
│  │   ├── DirectAddrs    []Multiaddr     # 直连地址                      │   │
│  │   ├── NATType        NATType         # NAT 类型                      │   │
│  │   ├── Capabilities   []string        # 节点能力                      │   │
│  │   ├── Online         bool            # 在线状态                      │   │
│  │   ├── LastSeen       time.Time       # 最后在线                      │   │
│  │   └── LastUpdate     time.Time       # 最后更新                      │   │
│  │                                                                       │   │
│  │ NATType (值对象)                                                      │   │
│  │   None | FullCone | Restricted | PortRestricted | Symmetric          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  协议消息：                                                                  │
│  • AddressRegister   - 成员注册地址                                         │
│  • AddressQuery      - 查询成员地址                                         │
│  • AddressResponse   - 返回地址结果                                         │
│  • AddressUpdate     - 地址变更通知                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 内置默认值

Relay 能力启用后的参数：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    统一 Relay 内置默认值                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  资源限制（默认不限制）：                                                    │
│  ├── MaxBandwidth      = 0（不限制）    # 由提供者物理带宽决定              │
│  ├── MaxDuration       = 60 秒          # 单电路最大持续时间                │
│  └── MaxReservations   = 100            # 最大预留数                        │
│                                                                             │
│  预留参数（★ 核心）：                                                       │
│  ├── ReservationTTL    = 1 小时         # 预留有效期                        │
│  ├── RenewalInterval   = 30 分钟        # 续租间隔                          │
│  ├── RenewalWindow     = 5 分钟         # 续租窗口                          │
│  └── MaxRenewalFailures = 3             # 最大续租失败次数                  │
│                                                                             │
│  地址簿参数：                                                                │
│  ├── AddressBookSize   = 10,000         # 最大成员数                        │
│  ├── EntryTTL          = 24 小时        # 条目过期时间                      │
│  └── CleanupInterval   = 1 小时         # 清理间隔                          │
│                                                                             │
│  连接参数：                                                                  │
│  ├── KeepConnection    = true           # 打洞后保留 Relay 连接             │
│  └── IdleTimeout       = 30 秒          # 空闲超时                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 配置参数（用户可配置）

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `EnableClient` | true | 启用中继客户端（自动使用 Relay） |
| `EnableServer` | false | 启用中继服务端（成为 Relay） |
| `MaxReservations` | 100 | 服务端最大预留数（可调整） |
| `ReservationTTL` | 1h | 预留有效期（可调整） |
| `KeepConnection` | true | 打洞成功后保留 Relay 连接 |

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [ADR-0010: Relay 显式配置](../../../01_context/decisions/ADR-0010-relay-explicit-config.md) | 配置原则决策 |
| [core_nat](../core_nat/) | NAT 穿透 |
| [core_swarm](../core_swarm/) | 连接群管理 |
| [L5: Relay 模型](../../L5_models/relay/relay_model.md) | 统一 Relay 领域模型 |
| [L1: 核心概念](../../L1_overview/core_concepts.md) | NAT 三层能力 |

---

**最后更新**：2026-01-23
