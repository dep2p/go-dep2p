# pkg_proto 需求说明

> **版本**: v1.1.0  
> **更新日期**: 2026-01-13

---

## 功能需求

### FR-1: 协议消息定义

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-1.1 | 定义公共消息（Timestamp, Error, Version） | P0 | ✅ 已实现 |
| FR-1.2 | 定义密钥消息（PublicKey, PrivateKey, Signature） | P0 | ✅ 已实现 |
| FR-1.3 | 定义节点消息（PeerRecord, AddrInfo） | P0 | ✅ 已实现 |
| FR-1.4 | 定义系统协议消息（identify, autonat, relay, dht） | P0 | ✅ 已实现 |
| FR-1.5 | 定义 Realm 协议消息（realm 认证） | P0 | ✅ 已实现 |
| FR-1.6 | 定义应用协议消息（messaging, gossipsub） | P1 | ✅ 已实现 |

### FR-2: 代码生成

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-2.1 | 生成 Go 代码（.pb.go） | P0 | ✅ 已实现 |
| FR-2.2 | 支持 go generate | P0 | ✅ 已实现 |
| FR-2.3 | 正确的 go_package 路径 | P0 | ✅ 已实现 |

### FR-3: 版本兼容性

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-3.1 | 使用 proto3 语法 | P0 | ✅ 已实现 |
| FR-3.2 | 字段编号不冲突 | P0 | ✅ 已实现 |
| FR-3.3 | 向后兼容（旧版本可解析新消息） | P0 | ✅ 已实现 |
| FR-3.4 | 向前兼容（新版本忽略未知字段） | P0 | ✅ 已实现 |

---

## 非功能需求

### NFR-1: 兼容性

| ID | 需求 | 说明 | 状态 |
|----|------|------|------|
| NFR-1.1 | go-libp2p 协议对齐 | 系统协议与 libp2p 兼容 | ✅ 已实现 |
| NFR-1.2 | 跨语言序列化 | Protobuf 标准格式 | ✅ 已实现 |

### NFR-2: 可测试性

| ID | 需求 | 目标 | 实际 | 状态 |
|----|------|------|------|------|
| NFR-2.1 | 测试覆盖率 | > 30% | ~33% | ✅ |
| NFR-2.2 | 往返测试 | 所有消息类型 | 所有类型 | ✅ |

**说明**：Protobuf 生成代码的覆盖率目标设为 30%（vs 手写代码的 80%），因为大部分是自动生成的 getter/setter。

### NFR-3: 可维护性

| ID | 需求 | 说明 | 状态 |
|----|------|------|------|
| NFR-3.1 | proto 文件注释 | 每个消息有说明 | ✅ 已实现 |
| NFR-3.2 | 字段注释 | 关键字段有注释 | ✅ 已实现 |
| NFR-3.3 | 文档完整 | README + L6_domains | ✅ 已实现 |

---

## 协议消息统计

| 类别 | proto 文件数 | pb.go 文件数 | 主要消息数 |
|------|-------------|-------------|-----------|
| 公共 | 1 | 1 | 5 |
| 密钥 | 1 | 1 | 4 |
| 节点 | 1 | 1 | 5 |
| 系统协议 | 5 | 5 | 15+ |
| Realm 协议 | 1 | 1 | 6 |
| 应用协议 | 2 | 2 | 10+ |
| **总计** | **13** | **13** | **45+** |

---

## 验收标准

| 类别 | 标准 | 状态 |
|------|------|------|
| proto 文件完整性 | 13 个 proto 文件 | ✅ |
| 代码生成 | 13 个 pb.go 文件 | ✅ |
| 测试覆盖率 | > 30% | ✅ 33% |
| 所有测试通过 | 100% 通过率 | ✅ |
| proto3 语法 | 所有文件 | ✅ |
| 文档完整性 | L6_domains + README | ✅ |

---

**最后更新**：2026-01-13
