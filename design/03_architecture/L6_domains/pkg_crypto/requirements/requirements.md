# pkg_crypto 需求说明

> **版本**: v1.1.0  
> **更新日期**: 2026-01-13

---

## 功能需求

### FR-1: 密钥生成

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-1.1 | 支持 Ed25519 密钥生成 | P0 | ✅ 已实现 |
| FR-1.2 | 支持 Secp256k1 密钥生成 | P1 | ✅ 已实现 |
| FR-1.3 | 支持 ECDSA (P-256) 密钥生成 | P2 | ✅ 已实现 |
| FR-1.4 | 支持 RSA 密钥生成 | P2 | ✅ 已实现 |
| FR-1.5 | 使用加密安全随机源（CSPRNG） | P0 | ✅ 已实现 |

### FR-2: 签名和验证

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-2.1 | 支持 Ed25519 签名/验证 | P0 | ✅ 已实现 |
| FR-2.2 | 支持 Secp256k1 签名/验证 | P1 | ✅ 已实现 |
| FR-2.3 | 支持 ECDSA 签名/验证 | P2 | ✅ 已实现 |
| FR-2.4 | 支持 RSA 签名/验证 | P2 | ✅ 已实现 |
| FR-2.5 | 签名记录（SignedRecord） | P1 | ✅ 已实现 |
| FR-2.6 | 签名信封（SignedEnvelope） | P1 | ✅ 已实现 |

### FR-3: 密钥序列化

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-3.1 | 公钥序列化/反序列化 | P0 | ✅ 已实现 |
| FR-3.2 | 私钥序列化/反序列化 | P0 | ✅ 已实现 |
| FR-3.3 | 签名序列化/反序列化 | P0 | ✅ 已实现 |
| FR-3.4 | 密钥对序列化/反序列化 | P1 | ✅ 已实现 |
| FR-3.5 | 与 Protobuf 格式兼容 | P0 | ✅ 已实现 |

### FR-4: PeerID 派生

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-4.1 | 从公钥派生 PeerID | P0 | ✅ 已实现 |
| FR-4.2 | 从私钥派生 PeerID | P1 | ✅ 已实现 |
| FR-4.3 | 公钥哈希计算 | P1 | ✅ 已实现 |
| FR-4.4 | PeerID 验证 | P1 | ✅ 已实现 |

### FR-5: 密钥存储

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| FR-5.1 | 文件系统密钥存储 | P0 | ✅ 已实现 |
| FR-5.2 | 内存密钥存储（测试用） | P1 | ✅ 已实现 |
| FR-5.3 | 密钥加密存储 | P0 | ✅ 已实现 |
| FR-5.4 | 密钥列表/查询 | P1 | ✅ 已实现 |
| FR-5.5 | 密钥删除 | P1 | ✅ 已实现 |

---

## 非功能需求

### NFR-1: 安全性

| ID | 需求 | 说明 | 状态 |
|----|------|------|------|
| NFR-1.1 | 常量时间比较 | 防止时序攻击 | ✅ 已实现 |
| NFR-1.2 | 加密存储 | AES-GCM + Argon2id | ✅ 已实现 |
| NFR-1.3 | 安全内存清零 | 敏感数据清除 | ✅ 已实现 |
| NFR-1.4 | 文件权限控制 | 私钥文件 0600 | ✅ 已实现 |
| NFR-1.5 | 无外部密码学库 | 减少依赖风险 | ✅ 已实现（Secp256k1 纯 Go） |

### NFR-2: 性能

| ID | 需求 | 目标 | 状态 |
|----|------|------|------|
| NFR-2.1 | Ed25519 签名性能 | < 0.1ms | ✅ 满足 |
| NFR-2.2 | Ed25519 验证性能 | < 0.2ms | ✅ 满足 |
| NFR-2.3 | 密钥生成性能 | < 10ms (Ed25519) | ✅ 满足 |
| NFR-2.4 | 内存占用 | 最小化 | ✅ 满足 |

### NFR-3: 可测试性

| ID | 需求 | 目标 | 状态 |
|----|------|------|------|
| NFR-3.1 | 测试覆盖率 | > 80% | ✅ 83.0% |
| NFR-3.2 | 边界条件测试 | 完整 | ✅ 已实现 |
| NFR-3.3 | 确定性测试 | 支持固定随机源 | ✅ 已实现 |
| NFR-3.4 | 基准测试 | 所有密钥类型 | ✅ 已实现 |

### NFR-4: 兼容性

| ID | 需求 | 说明 | 状态 |
|----|------|------|------|
| NFR-4.1 | Protobuf 兼容 | 与 pkg/proto/key 对齐 | ✅ 已实现 |
| NFR-4.2 | KeyType 值对齐 | 与 proto 枚举一致 | ✅ 已实现 |
| NFR-4.3 | 多格式支持 | 支持原始/PKCS#1/PKCS#8 | ✅ 已实现 |
| NFR-4.4 | libp2p 兼容 | 密钥格式兼容 | ✅ 已实现 |

### NFR-5: 可维护性

| ID | 需求 | 说明 | 状态 |
|----|------|------|------|
| NFR-5.1 | 代码注释 | GoDoc 完整 | ✅ 已实现 |
| NFR-5.2 | 错误处理 | 集中定义 | ✅ 已实现 |
| NFR-5.3 | 模块化设计 | 按密钥类型拆分 | ✅ 已实现 |
| NFR-5.4 | 文档完整 | README + L6_domains | ✅ 已实现 |

---

## 约束规范

| 规范 | 文档 | 对齐状态 |
|------|------|----------|
| 密钥格式规范 | [key_format.md](../../../../02_constraints/protocol/L1_identity/key_format.md) | ✅ 完全对齐 |
| 签名规范 | [signature.md](../../../../02_constraints/protocol/L1_identity/signature.md) | ✅ 完全对齐 |
| Protobuf 定义 | [pkg/proto/key/key.proto](../../../../../pkg/proto/key/key.proto) | ✅ 完全对齐 |

---

## 依赖需求

| 依赖 | 类型 | 说明 |
|------|------|------|
| pkg/types | 内部 | PeerID 等类型 |
| Go 标准库 | 标准 | crypto/* 包 |
| golang.org/x/crypto/argon2 | 外部 | 密钥派生 |

**重要**：无其他外部密码学库依赖，Secp256k1 使用纯 Go 实现。

---

## 使用场景

### UC-1: 节点启动时加载密钥

```
1. 用户启动节点
2. 系统从 keystore 加载私钥
3. 派生 PeerID
4. 初始化 identity 模块
```

### UC-2: 连接时验证身份

```
1. 节点 A 连接节点 B
2. B 发送公钥
3. A 验证 B 的签名
4. 确认 PeerID 一致
5. 建立安全连接
```

### UC-3: 首次运行生成密钥

```
1. 用户首次启动节点
2. 系统检测密钥不存在
3. 生成 Ed25519 密钥对
4. 加密存储到文件系统
5. 派生并显示 PeerID
```

---

## 验收标准

| 类别 | 标准 | 状态 |
|------|------|------|
| 功能完整性 | 所有 P0/P1 需求实现 | ✅ |
| 测试覆盖率 | > 80% | ✅ 83.0% |
| 性能基准 | Ed25519 签名 < 0.1ms | ✅ |
| 安全审查 | 常量时间比较实现 | ✅ |
| 文档完整性 | GoDoc + README | ✅ |
| 规范对齐 | 与约束规范一致 | ✅ |

---

**最后更新**：2026-01-13
