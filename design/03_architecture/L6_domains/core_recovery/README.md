# Recovery 模块设计

> **版本**: v1.1.0  
> **更新日期**: 2026-01-23  
> **定位**: 网络恢复（Core Layer）

---

## 概述

recovery 模块负责网络故障恢复，在网络中断后自动恢复连接。核心思想：**网络抖动是常态，短暂断连不应立即放弃**。

---

## 核心功能

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        core_recovery 职责                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 断线检测                                                                 │
│     • 连接状态监控                                                          │
│     • 网络抖动容忍                                                          │
│     • 状态变化去抖                                                          │
│                                                                             │
│  2. 自动重连                                                                 │
│     • 指数退避重试                                                          │
│     • 最大重试次数限制                                                      │
│     • 重连成功后状态恢复                                                    │
│                                                                             │
│  3. 策略管理                                                                 │
│     • 配置重连参数                                                          │
│     • 配置抖动容忍窗口                                                      │
│     • 配置状态保持时间                                                      │
│                                                                             │
│  4. 状态同步                                                                 │
│     • 恢复后重新同步成员列表                                                │
│     • 恢复后重新发布地址                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 网络抖动容忍

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    网络抖动容忍                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  核心思想：网络抖动是常态，短暂断连不应立即放弃                               │
│                                                                             │
│  容忍窗口（ToleranceWindow）：                                               │
│  • 断连后的等待窗口（默认 5 秒）                                            │
│  • 在此期间不触发重连                                                        │
│  • 如果连接自动恢复，状态保持不变                                            │
│                                                                             │
│  状态保持时间（StateHoldTime）：                                             │
│  • 断连后保持节点状态的时间（默认 30 秒）                                    │
│  • 超过此时间才真正移除节点                                                  │
│  • 避免频繁的节点加入/移除事件                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 连接状态机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    连接状态机                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  状态流转：                                                                  │
│  ──────────                                                                 │
│                                                                             │
│  Connected → [断连] → Held → [恢复] → Connected                             │
│                         │                                                   │
│                         ↓ [超时]                                            │
│                     Reconnecting → [成功] → Connected                       │
│                         │                                                   │
│                         ↓ [失败/超限]                                       │
│                      Removed                                                │
│                                                                             │
│  状态说明：                                                                  │
│  • Connected: 正常连接状态                                                  │
│  • Held: 断连后保持状态，等待自动恢复                                       │
│  • Reconnecting: 正在重连                                                   │
│  • Removed: 已移除，不再尝试                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ★ 重连策略（指数退避）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    指数退避重试策略                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  指数退避参数：                                                              │
│  ══════════════                                                             │
│  • 初始间隔（InitialInterval）：1 秒                                        │
│  • 退避因子（Multiplier）：2                                                │
│  • 最大间隔（MaxInterval）：30 秒                                           │
│  • 最大重试次数（MaxRetries）：5 次                                         │
│  • 抖动因子（Jitter）：±20%                                                 │
│                                                                             │
│  重试序列示例：                                                              │
│  ────────────────                                                           │
│  第 1 次：1s   × (1 ± 0.2) = 0.8s ~ 1.2s                                   │
│  第 2 次：2s   × (1 ± 0.2) = 1.6s ~ 2.4s                                   │
│  第 3 次：4s   × (1 ± 0.2) = 3.2s ~ 4.8s                                   │
│  第 4 次：8s   × (1 ± 0.2) = 6.4s ~ 9.6s                                   │
│  第 5 次：16s  × (1 ± 0.2) = 12.8s ~ 19.2s                                 │
│  （最大 30s 封顶）                                                          │
│                                                                             │
│  失败后处理：                                                                │
│  • 达到最大重试次数后，标记为 Removed                                       │
│  • 记录错误日志，供诊断使用                                                 │
│  • 可选择切换到 Relay 路径重试                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `ToleranceWindow` | 5s | 断连后的容忍窗口，期间不触发重连 |
| `StateHoldTime` | 30s | 断连后保持节点状态的时间 |
| `InitialInterval` | 1s | 重连初始间隔 |
| `MaxInterval` | 30s | 重连最大间隔 |
| `MaxRetries` | 5 | 最大重连尝试次数 |
| `BackoffMultiplier` | 2 | 退避乘数 |
| `Jitter` | 0.2 | 抖动因子（±20%） |

---

## 代码位置

```
internal/core/recovery/
├── doc.go          # 包文档
├── manager.go      # 恢复管理器
├── manager_test.go
├── strategy.go     # 恢复策略（指数退避）
├── state.go        # 连接状态机
├── events.go       # 恢复事件
└── module.go       # Fx 模块定义
```

---

## 公共接口

```pseudocode
interface RecoveryManager {
    // OnDisconnected 处理断连事件
    OnDisconnected(peer: NodeID)
    
    // OnReconnected 处理重连成功
    OnReconnected(peer: NodeID)
    
    // GetState 获取节点恢复状态
    GetState(peer: NodeID) -> RecoveryState
    
    // SetConfig 设置恢复配置
    SetConfig(config: RecoveryConfig)
}

enum RecoveryState {
    Connected,
    Held,
    Reconnecting,
    Removed
}
```

---

## 依赖

| 模块 | 作用 |
|------|------|
| NetMon | 网络状态监控 |
| ConnMgr | 连接生命周期管理 |
| EventBus | 事件通知 |
| core_swarm | 重连拨号 |

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [core_netmon](../core_netmon/) | 网络状态监控 |
| [core_connmgr](../core_connmgr/) | 连接管理 |

---

**最后更新**：2026-01-23
