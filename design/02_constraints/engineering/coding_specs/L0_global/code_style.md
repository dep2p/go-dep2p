# 代码风格规范

> 定义 DeP2P 项目的代码格式化和风格要求

---

## 格式化规则

### 基本要求

| 规则 | 工具 | 强制级别 |
|------|------|----------|
| 代码格式化 | gofmt | 必须 |
| 导入排序 | goimports | 必须 |
| 行长度 | 120 字符 | 建议 |
| 缩进 | Tab | 必须 |

### 格式化流程

```
源代码 → gofmt → goimports → 提交
```

---

## 导入规范

### 分组规则

导入必须分为三组，每组之间空行分隔：

```
┌─────────────────────────────────────────┐
│              导入分组                    │
├─────────────────────────────────────────┤
│                                         │
│  第一组：标准库                          │
│      context, fmt, sync, time           │
│                                         │
│  第二组：第三方库                        │
│      外部依赖包                          │
│                                         │
│  第三组：本项目                          │
│      internal/, pkg/                    │
│                                         │
└─────────────────────────────────────────┘
```

### 禁止规则

| 禁止项 | 原因 |
|--------|------|
| 点导入 (import .) | 降低可读性，命名冲突 |
| 相对导入 | 不符合 Go 规范 |
| 无意义别名 | 增加理解成本 |

---

## 命名规范

### 变量命名

| 作用域 | 风格 | 示例 |
|--------|------|------|
| 局部变量 | 短名 | i, err, ctx |
| 包级变量 | 驼峰 | defaultTimeout |
| 导出变量 | 大驼峰 | DefaultTimeout |

### 常量命名

| 类型 | 风格 | 示例 |
|------|------|------|
| 私有常量 | 驼峰 | maxRetries |
| 导出常量 | 大驼峰 | MaxRetries |
| 枚举值 | 类型前缀 | StatusConnected |

### 函数命名

| 类型 | 规则 | 示例 |
|------|------|------|
| 构造函数 | New + 类型名 | NewManager |
| 获取器 | 名词 | Connection |
| 设置器 | Set + 属性 | SetTimeout |
| 布尔返回 | Is/Has/Can | IsConnected |

---

## 注释规范

### 文档注释

```
包注释：
  Package xxx 提供 yyy 功能。
  
  详细描述...

导出类型/函数注释：
  TypeName 是/表示/用于...
  
  FuncName 执行/返回/创建...
```

### 注释原则

| 原则 | 说明 |
|------|------|
| 说明"为什么" | 而非"是什么" |
| 保持同步 | 代码变更时更新注释 |
| 避免冗余 | 不解释显而易见的代码 |

---

## 结构体规范

### 字段顺序

```
┌─────────────────────────────────────────┐
│            结构体字段顺序                │
├─────────────────────────────────────────┤
│                                         │
│  1. 嵌入字段（如有）                     │
│  2. 导出字段                            │
│  3. 私有字段                            │
│  4. 同步原语（mutex 等）                 │
│                                         │
└─────────────────────────────────────────┘
```

### 字段对齐

- 相关字段分组
- 组之间空行分隔
- 字段注释右对齐

---

## 函数规范

### 函数长度

| 指标 | 建议值 | 说明 |
|------|--------|------|
| 函数行数 | < 50 行 | 超过考虑拆分 |
| 参数个数 | < 5 个 | 超过使用结构体 |
| 返回值个数 | < 3 个 | 超过使用结构体 |

### 函数签名

```
签名规则：
  1. context.Context 作为第一个参数
  2. error 作为最后一个返回值
  3. 接收者名称简短一致
```

---

## 文件组织

### 文件结构

```
┌─────────────────────────────────────────┐
│              文件结构                    │
├─────────────────────────────────────────┤
│                                         │
│  1. 包声明                              │
│  2. 导入                                │
│  3. 常量                                │
│  4. 变量                                │
│  5. 类型定义                            │
│  6. 构造函数                            │
│  7. 方法                                │
│  8. 辅助函数                            │
│                                         │
└─────────────────────────────────────────┘
```

### 文件大小

| 指标 | 建议值 | 说明 |
|------|--------|------|
| 文件行数 | < 500 行 | 超过考虑拆分 |
| 单文件类型数 | 1-3 个 | 相关类型可同文件 |

---

## 验证清单

| 检查项 | 验证方式 |
|--------|----------|
| 格式化正确 | gofmt -d |
| 导入排序正确 | goimports |
| 无 lint 警告 | golangci-lint |
| 命名符合规范 | 代码审查 |

---

## 相关文档

- [命名规范](../../standards/naming_conventions.md)
- [错误处理](error_handling.md)

---

**最后更新**：2026-01-11
