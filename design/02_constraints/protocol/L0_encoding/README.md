# L0 编码层规范

> 定义 DeP2P 协议的底层编码规则

---

## 概述

编码层是 DeP2P 协议栈的基础，定义了数据的序列化、字节表示和版本控制规范。

```mermaid
flowchart TB
    subgraph L0[L0 编码层]
        Serialization[序列化格式]
        ByteOrder[字节序]
        Versioning[版本控制]
    end
    
    Serialization --> ByteOrder
    ByteOrder --> Versioning
```

---

## 规范列表

| 规范 | 文档 | 说明 |
|------|------|------|
| 序列化 | [serialization.md](serialization.md) | Protobuf + CBOR |
| 字节序 | [byte_order.md](byte_order.md) | 大端序 + varint |
| 版本控制 | [versioning.md](versioning.md) | 语义化版本 |

---

## 设计原则

```
┌─────────────────────────────────────────────────────────────┐
│                    编码层设计原则                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  互操作性                                                   │
│  ────────                                                   │
│  使用标准格式，支持多语言实现                                 │
│                                                             │
│  紧凑性                                                     │
│  ──────                                                     │
│  高效编码，减少网络传输开销                                   │
│                                                             │
│  可扩展性                                                   │
│  ────────                                                   │
│  支持向前/向后兼容的演进                                     │
│                                                             │
│  确定性                                                     │
│  ──────                                                     │
│  相同数据产生相同编码                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 编码栈

```
┌─────────────────────────────────────────┐
│              应用数据                    │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Protobuf 序列化                  │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         长度前缀 (varint)                │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│            字节流                        │
└─────────────────────────────────────────┘
```

---

## 消息帧格式

所有 DeP2P 消息采用统一的帧格式：

```
┌──────────────────────────────────────────────────────────┐
│                      消息帧                               │
├──────────┬──────────────────────────────────────────────┤
│  长度    │                 消息体                        │
│ (varint) │            (Protobuf 编码)                   │
├──────────┼──────────────────────────────────────────────┤
│ 1-10字节 │                 N 字节                        │
└──────────┴──────────────────────────────────────────────┘
```

---

## 与上层的关系

| 上层 | 依赖的编码规范 |
|------|----------------|
| L1 身份层 | 密钥编码、NodeID 格式 |
| L2 传输层 | 消息帧、握手编码 |
| L3 网络层 | DHT 消息、地址编码 |
| L4 应用层 | 业务消息编码 |

---

## 相关文档

- [L1 身份层](../L1_identity/)
- [协议命名规范](../../../01_context/decisions/ADR-0007-protocol-naming.md)
- [消息格式需求](../../../01_context/requirements/functional/F6_protocol/REQ-PROTO-002.md)

---

**最后更新**：2026-01-11
