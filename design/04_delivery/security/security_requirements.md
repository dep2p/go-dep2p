# 安全要求

> DeP2P 安全功能规范和实现要求

---

## 元信息

| 字段 | 值 |
|------|-----|
| **状态** | approved |
| **Owner** | DeP2P Team |
| **创建日期** | 2026-01-11 |
| **更新日期** | 2026-01-11 |

---

## 1. 身份安全

### 1.1 密钥管理

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 密钥算法 | Ed25519 | ✅ |
| 密钥长度 | 256 位 | ✅ |
| 密钥生成 | 使用安全随机数生成器 | ✅ |
| 密钥存储 | 加密存储（可选） | ⏳ |

**实现要求**：

```go
// 密钥生成必须使用 crypto/rand
func GenerateKeyPair() (ed25519.PrivateKey, ed25519.PublicKey, error) {
    pub, priv, err := ed25519.GenerateKey(rand.Reader)
    if err != nil {
        return nil, nil, err
    }
    return priv, pub, nil
}
```

### 1.2 NodeID 安全

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 派生算法 | SHA-256(PublicKey) | ✅ |
| 不可伪造 | 需要对应私钥 | ✅ |
| 唯一性 | 哈希碰撞概率极低 | ✅ |

### 1.3 签名验证

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 签名算法 | Ed25519 | ✅ |
| 验证时机 | 所有身份相关操作 | ✅ |
| 失败处理 | 拒绝操作 | ✅ |

---

## 2. 传输安全

### 2.1 加密要求

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 协议版本 | TLS 1.3 | ✅ |
| 密码套件 | AEAD (AES-GCM, ChaCha20-Poly1305) | ✅ |
| 前向保密 | 必须支持 PFS | ✅ |
| 证书验证 | 自签名 + NodeID 绑定 | ✅ |

**配置要求**：

```go
// TLS 配置
tlsConfig := &tls.Config{
    MinVersion: tls.VersionTLS13,
    CipherSuites: []uint16{
        tls.TLS_AES_256_GCM_SHA384,
        tls.TLS_CHACHA20_POLY1305_SHA256,
        tls.TLS_AES_128_GCM_SHA256,
    },
    ClientAuth: tls.RequireAnyClientCert,
}
```

### 2.2 双向认证

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 客户端认证 | 必须 | ✅ |
| 服务端认证 | 必须 | ✅ |
| NodeID 验证 | 证书公钥派生 NodeID | ✅ |

### 2.3 连接安全

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 握手超时 | ≤ 10 秒 | ✅ |
| 重协商 | 禁用 | ✅ |
| 会话恢复 | TLS 1.3 0-RTT（限制使用） | ⏳ |

---

## 3. 访问控制

### 3.1 Realm 认证

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 认证方式 | PSK（预共享密钥） | ✅ |
| PSK 长度 | ≥ 256 位 | ✅ |
| PSK 派生 | HKDF | ✅ |
| 认证失败 | 拒绝加入 | ✅ |

### 3.2 ConnectionGater

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 入站过滤 | 可配置拒绝规则 | ✅ |
| 出站过滤 | 可配置拒绝规则 | ✅ |
| 黑名单 | IP/NodeID 黑名单 | ✅ |
| 白名单 | IP/NodeID 白名单 | ⏳ |

**接口要求**：

```go
type ConnectionGater interface {
    InterceptPeerDial(p NodeID) bool
    InterceptAddrDial(p NodeID, addr Multiaddr) bool
    InterceptAccept(conn Conn) bool
    InterceptSecured(dir Direction, p NodeID, conn Conn) bool
}
```

### 3.3 协议权限

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 协议白名单 | 仅允许注册协议 | ⏳ |
| 协议认证 | Realm 协议需认证 | ✅ |

---

## 4. 数据保护

### 4.1 消息安全

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 机密性 | TLS 加密 | ✅ |
| 完整性 | AEAD MAC | ✅ |
| 防重放 | Nonce/序列号 | ⏳ |

### 4.2 存储安全

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 密钥存储 | 文件权限 0600 | ✅ |
| 敏感配置 | 可加密存储 | ⏳ |
| 日志脱敏 | 不记录敏感信息 | ✅ |

### 4.3 内存安全

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 密钥清理 | 使用后清零 | ⏳ |
| 敏感数据 | 最小化内存驻留 | ⏳ |

---

## 5. 可用性保护

### 5.1 连接限制

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 总连接数限制 | 可配置上限 | ✅ |
| 每 IP 限制 | 可配置 | ⏳ |
| 每节点限制 | 可配置 | ✅ |

### 5.2 速率限制

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 连接速率 | 可配置 | ⏳ |
| 消息速率 | 可配置 | ⏳ |
| 握手速率 | 可配置 | ⏳ |

### 5.3 资源配额

| 要求 | 规范 | 状态 |
|------|------|:----:|
| 内存限制 | 每连接限制 | ✅ |
| 带宽限制 | 可配置 | ⏳ |
| 流数量限制 | 每连接限制 | ✅ |

---

## 6. 审计日志

### 6.1 必须记录事件

| 事件 | 内容 | 级别 |
|------|------|------|
| 认证失败 | NodeID, IP, 原因 | WARN |
| 连接拒绝 | IP, 原因 | INFO |
| Realm 加入失败 | NodeID, RealmID | WARN |
| 安全配置变更 | 变更内容 | INFO |

### 6.2 日志格式

```json
{
  "timestamp": "2026-01-11T00:00:00Z",
  "level": "WARN",
  "event": "auth_failed",
  "node_id": "12D3...",
  "remote_addr": "192.168.1.100:12345",
  "reason": "invalid_signature"
}
```

### 6.3 日志保护

| 要求 | 规范 |
|------|------|
| 敏感信息 | 不记录密钥、PSK |
| 访问控制 | 日志文件权限限制 |
| 保留期限 | 可配置 |

---

## 7. 安全配置

### 7.1 默认安全

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| TLS | 启用 | 不可禁用 |
| 双向认证 | 启用 | 不可禁用 |
| 连接限制 | 启用 | 可调整阈值 |

### 7.2 安全强化

| 配置项 | 默认值 | 强化值 |
|--------|--------|--------|
| max_connections | 1000 | 根据资源调整 |
| handshake_timeout | 10s | 5s |
| idle_timeout | 60s | 30s |

---

## 8. 合规要求

### 8.1 密码学合规

| 标准 | 状态 |
|------|:----:|
| NIST SP 800-57 (密钥管理) | ✅ |
| FIPS 140-2 Level 1 | ⏳ |

### 8.2 安全开发

| 实践 | 状态 |
|------|:----:|
| 安全代码审查 | ✅ |
| 依赖漏洞扫描 | ✅ |
| 静态分析 | ✅ |

---

## 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-11 | DeP2P Team | 初始版本 |
