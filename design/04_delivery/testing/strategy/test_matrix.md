# 测试矩阵

> 模块 × 测试类型 覆盖矩阵

---

## 元信息

| 字段 | 值 |
|------|-----|
| **状态** | approved |
| **Owner** | DeP2P Team |
| **创建日期** | 2026-01-11 |
| **更新日期** | 2026-01-20 |

---

## 1. 模块测试覆盖矩阵

### 1.1 核心模块

| 模块 | 单元 | 集成 | E2E | 真实网络 | 基准 | 混沌 | 覆盖率目标 |
|------|:----:|:----:|:---:|:--------:|:----:|:----:|-----------|
| **identity** | ✅ | ✅ | ✅ | - | ✅ | - | ≥ 85% |
| **transport** | ✅ | ✅ | ✅ | - | ✅ | ✅ | ≥ 80% |
| **security** | ✅ | ✅ | ✅ | - | ✅ | - | ≥ 85% |
| **muxer** | ✅ | ✅ | ✅ | - | ✅ | - | ≥ 80% |
| **connmgr** | ✅ | ✅ | - | - | ✅ | ✅ | ≥ 75% |
| **relay** | ✅ | ✅ | ✅ | ✅ S02/S04 | ✅ | ✅ | ≥ 85% |
| **discovery** | ✅ | ✅ | ✅ | ✅ S03 | - | ✅ | ≥ 80% |
| **nat** | ✅ | ✅ | ✅ | ✅ S02 | - | ✅ | ≥ 75% |
| **realm** | ✅ | ✅ | ✅ | ✅ S05 | ✅ | ✅ | ≥ 85% |
| **messaging** | ✅ | ✅ | ✅ | ✅ S01/S07 | ✅ | - | ≥ 80% |

> **真实网络验证场景说明**：S01=基础通信, S02=NAT穿透, S03=DHT路由, S04=中继, S05=成员同步, S07=消息可靠性

### 1.2 公共包

| 包 | 单元 | 集成 | E2E | 基准 | 覆盖率目标 |
|-----|:----:|:----:|:---:|:----:|-----------|
| **pkg/interfaces** | ✅ | - | - | - | ≥ 90% |
| **pkg/types** | ✅ | - | - | - | ≥ 90% |
| **pkg/proto** | ✅ | - | - | ✅ | ≥ 85% |
| **pkg/namespace** | ✅ | - | - | - | ≥ 85% |
| **pkg/protocolids** | ✅ | - | - | - | ≥ 90% |

---

## 2. 测试场景矩阵

### 2.1 Identity 模块

| 场景 | 单元 | 集成 | E2E | 优先级 |
|------|:----:|:----:|:---:|:------:|
| 密钥生成 | ✅ | - | - | P0 |
| NodeID 派生 | ✅ | - | - | P0 |
| 密钥导入/导出 | ✅ | - | - | P1 |
| 密钥持久化 | ✅ | ✅ | - | P1 |
| 签名/验证 | ✅ | - | - | P0 |
| 多密钥管理 | ✅ | ✅ | - | P2 |

### 2.2 Transport 模块

| 场景 | 单元 | 集成 | E2E | 优先级 |
|------|:----:|:----:|:---:|:------:|
| TCP 连接 | ✅ | ✅ | ✅ | P0 |
| QUIC 连接 | ✅ | ✅ | ✅ | P0 |
| WebSocket 连接 | ✅ | ✅ | - | P1 |
| 连接复用 | ✅ | ✅ | - | P1 |
| 连接超时 | ✅ | ✅ | - | P1 |
| 大数据传输 | - | ✅ | ✅ | P1 |
| 并发连接 | ✅ | ✅ | - | P1 |

### 2.3 Relay 模块

| 场景 | 单元 | 集成 | E2E | 优先级 |
|------|:----:|:----:|:---:|:------:|
| Relay 注册 | ✅ | ✅ | ✅ | P0 |
| Relay 注册（Realm 场景） | ✅ | ✅ | ✅ | P0 |
| 中继转发 | ✅ | ✅ | ✅ | P0 |
| 中继故障恢复 | - | ✅ | ✅ | P1 |
| 中继选择策略 | ✅ | ✅ | - | P1 |
| 带宽限制 | ✅ | ✅ | - | P2 |

### 2.4 Realm 模块

| 场景 | 单元 | 集成 | E2E | 优先级 |
|------|:----:|:----:|:---:|:------:|
| Realm 创建 | ✅ | ✅ | ✅ | P0 |
| PSK 认证 | ✅ | ✅ | ✅ | P0 |
| 成员加入 | ✅ | ✅ | ✅ | P0 |
| 成员离开 | ✅ | ✅ | ✅ | P0 |
| 成员发现 | ✅ | ✅ | ✅ | P1 |
| 多 Realm 隔离 | ✅ | ✅ | ✅ | P1 |

### 2.5 Discovery 模块

| 场景 | 单元 | 集成 | E2E | 优先级 |
|------|:----:|:----:|:---:|:------:|
| Bootstrap 连接 | ✅ | ✅ | ✅ | P0 |
| mDNS 发现 | ✅ | ✅ | - | P1 |
| DHT 发现 | ✅ | ✅ | ✅ | P1 |
| Rendezvous 发现 | ✅ | ✅ | ✅ | P1 |
| 节点过滤 | ✅ | - | - | P2 |

### 2.6 Messaging 模块

| 场景 | 单元 | 集成 | E2E | 优先级 |
|------|:----:|:----:|:---:|:------:|
| 点对点消息 | ✅ | ✅ | ✅ | P0 |
| 广播消息 | ✅ | ✅ | ✅ | P0 |
| GossipSub | ✅ | ✅ | ✅ | P1 |
| 消息去重 | ✅ | ✅ | - | P1 |
| 消息过滤 | ✅ | - | - | P2 |

---

## 3. 平台兼容性矩阵

### 3.1 操作系统

| OS | 单元 | 集成 | E2E | CI 覆盖 |
|-----|:----:|:----:|:---:|:-------:|
| Linux (Ubuntu 22.04) | ✅ | ✅ | ✅ | ✅ |
| Linux (Ubuntu 20.04) | ✅ | ✅ | - | ✅ |
| macOS (14.x) | ✅ | ✅ | ✅ | ✅ |
| macOS (13.x) | ✅ | ✅ | - | - |
| Windows (2022) | ✅ | ✅ | - | ✅ |

### 3.2 Go 版本

| Go 版本 | 单元 | 集成 | E2E | CI 覆盖 |
|---------|:----:|:----:|:---:|:-------:|
| 1.21 | ✅ | ✅ | ✅ | ✅ |
| 1.22 | ✅ | ✅ | ✅ | ✅ |
| 1.23 (tip) | ✅ | - | - | ✅ |

---

## 4. 性能测试矩阵

### 4.1 基准测试覆盖

| 模块 | 场景 | 指标 | 基准值 |
|------|------|------|--------|
| **identity** | NodeID 生成 | ops/s | ≥ 100,000 |
| **identity** | 签名 | ops/s | ≥ 50,000 |
| **identity** | 验签 | ops/s | ≥ 50,000 |
| **transport** | TCP 连接建立 | P99 延迟 | ≤ 50ms |
| **transport** | QUIC 连接建立 | P99 延迟 | ≤ 100ms |
| **transport** | 数据吞吐量 | MB/s | ≥ 100 |
| **relay** | 中继延迟 | P99 | ≤ 20ms |
| **realm** | PSK 验证 | ops/s | ≥ 10,000 |
| **messaging** | 消息吞吐量 | msg/s | ≥ 10,000 |
| **proto** | Protobuf 编码 | ops/s | ≥ 500,000 |
| **proto** | Protobuf 解码 | ops/s | ≥ 500,000 |

### 4.2 压力测试场景

| 场景 | 参数 | 指标 |
|------|------|------|
| 高并发连接 | 1000 并发连接 | 成功率 ≥ 99% |
| 大量节点 | 100 节点网络 | 发现成功率 ≥ 95% |
| 高消息吞吐 | 10,000 msg/s | 延迟 P99 ≤ 100ms |
| 长时间运行 | 24 小时 | 无内存泄漏 |

---

## 5. 混沌测试矩阵

### 5.1 故障注入场景

| 故障类型 | 模块 | 预期行为 | 恢复时间 |
|----------|------|----------|----------|
| 网络分区 | transport, relay | 自动重连 | ≤ 30s |
| 节点崩溃 | all | 服务降级 | ≤ 10s |
| 高延迟 | transport | 超时处理 | - |
| 丢包 | transport | 重传恢复 | - |
| Relay 故障 | relay | 切换备用 | ≤ 30s |
| 内存压力 | connmgr | 优雅降级 | - |

### 5.2 恢复测试

| 场景 | 测试内容 | 验证点 |
|------|----------|--------|
| 节点重启 | 状态恢复 | 身份保持、连接重建 |
| 网络恢复 | 连接重建 | 自动重连、状态同步 |
| Relay 恢复 | 切换回主 | 路由更新、数据一致 |

---

## 6. 安全测试矩阵

### 6.1 安全场景

| 场景 | 测试类型 | 模块 | 验证点 |
|------|----------|------|--------|
| 身份伪造 | 单元 + 集成 | identity | 拒绝无效签名 |
| 中间人攻击 | 集成 + E2E | security | TLS 验证 |
| 未授权访问 | 集成 | realm | PSK 验证 |
| DoS 攻击 | 压力测试 | connmgr | 资源限制 |
| 重放攻击 | 单元 | messaging | Nonce 验证 |

---

## 7. 测试用例编号

### 7.1 编号规则

```
TST-{模块}-{序号}

模块代码：
- IDENTITY: 身份
- TRANSPORT: 传输
- SECURITY: 安全
- RELAY: 中继
- REALM: Realm
- DISC: 发现
- MSG: 消息
- E2E: 端到端
```

### 7.2 用例索引

| 编号范围 | 模块 | 数量 |
|----------|------|------|
| TST-IDENTITY-0001 ~ 0099 | 身份 | 预留 99 |
| TST-TRANSPORT-0001 ~ 0099 | 传输 | 预留 99 |
| TST-SECURITY-0001 ~ 0099 | 安全 | 预留 99 |
| TST-RELAY-0001 ~ 0099 | 中继 | 预留 99 |
| TST-REALM-0001 ~ 0099 | Realm | 预留 99 |
| TST-DISC-0001 ~ 0099 | 发现 | 预留 99 |
| TST-MSG-0001 ~ 0099 | 消息 | 预留 99 |
| TST-E2E-0001 ~ 0099 | 端到端 | 预留 99 |

---

---

## 8. 架构层级测试覆盖现状 (2026-01-17)

> 基于 DEP2P 四层架构的实际测试覆盖分析

### 8.1 架构层次概览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          DEP2P 四层架构                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│  第 4 层 - Protocol   │ Streams, PubSub, Messaging, Liveness                    │
│  第 3 层 - Realm      │ Auth, Member, Connector, Routing, Gateway               │
│  第 2 层 - Discovery  │ mDNS, DHT, Bootstrap, Rendezvous, DNS                   │
│  第 1 层 - Core       │ Transport, Swarm, Security, Host, Peerstore, NAT, Relay │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 按层级测试覆盖矩阵

#### 第 4 层 - 应用协议

| 组件 | 单元测试 | 集成测试 | E2E 测试 | 代码位置 |
|-----|:--------:|:--------:|:--------:|----------|
| Streams | ✅ | ✅ 4 个 | ✅ chat | `tests/integration/protocol/streams_test.go` |
| PubSub | ✅ | ✅ 4 个 | ✅ chat | `tests/integration/protocol/pubsub_test.go` |
| Messaging | ✅ | ❌ 缺失 | ❌ | - |
| Liveness | ✅ | ✅ 3 个 | ❌ | `tests/integration/protocol/liveness_test.go` |

#### 第 3 层 - Realm

| 组件 | 单元测试 | 集成测试 | E2E 测试 | 代码位置 |
|-----|:--------:|:--------:|:--------:|----------|
| Auth | ✅ | ✅ 3 个 | ✅ chat | `tests/integration/core/realm_auth_test.go` |
| Member | ✅ | ✅ 3 个 | ✅ chat | `tests/integration/core/member_test.go` |
| Connector | ✅ | ❌ 缺失 | ❌ | - |
| Routing | ✅ | ❌ 缺失 | ❌ | - |
| Gateway | ✅ | ❌ 缺失 | ❌ | - |

#### 第 2 层 - 发现

| 组件 | 单元测试 | 集成测试 | E2E 测试 | 代码位置 |
|-----|:--------:|:--------:|:--------:|----------|
| mDNS | ✅ | ❌ 缺失 | ✅ discovery | `tests/e2e/scenario/discovery_test.go` |
| DHT | ✅ | ❌ 缺失 | ❌ | - |
| Bootstrap | ✅ | ❌ 缺失 | ❌ | - |
| Rendezvous | ✅ | ❌ 缺失 | ❌ | - |
| DNS | ✅ | ❌ 缺失 | ❌ | - |

#### 第 1 层 - Core

| 组件 | 单元测试 | 集成测试 | E2E 测试 | 代码位置 |
|-----|:--------:|:--------:|:--------:|----------|
| Transport | ✅ | ❌ 缺失 | ✅ 间接 | - |
| Swarm | ✅ | ✅ 4 个 | ✅ 间接 | `tests/integration/core/connection_test.go` |
| Host | ✅ | ✅ 1 个 | ✅ 间接 | `tests/integration/core/simple_stream_test.go` |
| Security | ✅ | ❌ 缺失 | ❌ | - |
| EventBus | ✅ | ✅ 4 个 | ❌ | `tests/integration/core/eventbus_test.go` |
| Peerstore | ✅ | ❌ 缺失 | ❌ | - |
| NAT | ✅ | ❌ 缺失 | ❌ | - |
| Relay | ✅ | ❌ 缺失 | ❌ | - |
| ConnMgr | ✅ | ❌ 缺失 | ❌ | - |

### 8.3 测试统计

```
┌─────────────────────────────────────────────────────────────┐
│                    当前测试通过统计                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  集成测试 (tests/integration/)                               │
│  ├── core/          15 个测试  ✅ 全部通过                   │
│  └── protocol/      11 个测试  ✅ 全部通过                   │
│                                                             │
│  E2E 测试 (tests/e2e/)                                      │
│  ├── scenario/       4 个测试  ✅ 全部通过                   │
│  └── resilience/     2 个测试  ⏳ TODO                       │
│                                                             │
│  总计: 30 个测试通过, 2 个待实现                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.4 缺失测试分析

#### 高优先级 (影响公网部署)

| 层级 | 组件 | 缺失类型 | 解决方案 |
|-----|------|---------|----------|
| Discovery | DHT | 集成测试 | ⚠️ 本地有限，需真实网络验证 (S03) |
| Discovery | Bootstrap | 集成测试 | ⚠️ 需真实网络验证 (S01) |
| Discovery | Rendezvous | 集成测试 | ⚠️ 需真实网络验证 |
| Core | NAT/HolePunch | 集成测试 | ❌ 无法本地模拟，必须真实网络验证 (S02) |
| Core | Relay | 集成测试 | ⚠️ 本地部分，真实网络验证 (S04) |
| Protocol | Messaging | 集成测试 | ⚠️ 需添加本地集成测试 |

#### 中优先级

| 层级 | 组件 | 缺失类型 | 解决方案 |
|-----|------|---------|----------|
| Realm | Gateway | 集成测试 | 添加本地集成测试 |
| Realm | Routing | 集成测试 | 添加本地集成测试 |
| Core | ConnMgr | 集成测试 | 添加本地集成测试 |
| Core | Security | 集成测试 | 添加本地集成测试 |

---

## 9. 真实网络验证场景矩阵

> **第四层测试**：无法本地模拟的 P2P 场景

### 9.1 场景覆盖

| 场景 ID | 场景名称 | 覆盖模块 | 优先级 | 状态 |
|---------|----------|----------|:------:|:----:|
| **S01** | 基础三节点通信 | transport, messaging, member | P0 | 待验证 |
| **S02** | NAT 穿透验证 | nat, relay | P0 | 待验证 |
| **S03** | DHT 路由验证 | dht, discovery | P0 | 待验证 |
| **S04** | 中继通信验证 | relay | P1 | 待验证 |
| **S05** | 成员同步验证 | realm, member | P1 | 待验证 |
| **S06** | 网络切换恢复 | transport, reconnect | P1 | 待验证 |
| **S07** | 消息可靠投递 | messaging, pubsub, streams | P2 | 待验证 |
| **S08** | 启动顺序验证 | all | P2 | 待验证 |

### 9.2 模块与场景映射

| 模块 | S01 | S02 | S03 | S04 | S05 | S06 | S07 | S08 |
|------|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| NAT/STUN | ✅ | ✅ | - | - | - | ✅ | - | - |
| DHT | - | - | ✅ | - | - | ✅ | - | ✅ |
| Relay | - | ✅ | - | ✅ | - | - | - | - |
| PubSub | ✅ | - | - | - | ✅ | ✅ | ✅ | ✅ |
| Streams | ✅ | - | - | ✅ | - | - | ✅ | - |
| Member | ✅ | - | - | - | ✅ | - | - | - |
| Transport | ✅ | ✅ | - | ✅ | - | ✅ | - | ✅ |

### 9.3 关联 BUG 跟踪

真实网络验证需验证以下已修复 BUG：

| BUG ID | 问题摘要 | 关联场景 | 验证状态 |
|--------|----------|----------|:--------:|
| BUG-1 | STUN 地址端口组合错误 | S01, S02 | ⚠️ 待验证 |
| BUG-3 | 成员同步机制缺失 | S05 | ⚠️ 待验证 |
| BUG-6 | DHT 未启动 | S03 | ⚠️ 待验证 |
| BUG-7 | DHT 不监听连接事件 | S03 | ⚠️ 待验证 |
| BUG-9 | 中继地址更新缺失 | S04 | ⚠️ 待验证 |
| BUG-11 | 仅监听 4001 不监听随机端口 | S01 | ⚠️ 待验证 |

**详细 BUG 信息**：`design/_discussions/20260119-bug-tracking-chat-example.md`

---

## 10. 测试策略总结

### 10.1 测试层级职责

```
┌────────────────────────────────────────────────────────────────┐
│ Level 4: 真实网络验证                                          │
│   - NAT 穿透、中继、跨网络通信                                  │
│   - 手动执行 + AI 日志分析                                      │
│   - 场景：S01-S08                                              │
├────────────────────────────────────────────────────────────────┤
│ Level 3: E2E 测试                                              │
│   - 完整用户场景（本地多节点）                                  │
│   - go test -tags=e2e ./tests/e2e/...                         │
│   - Chat 场景、Discovery 场景                                  │
├────────────────────────────────────────────────────────────────┤
│ Level 2: 集成测试                                              │
│   - 跨模块协作（单进程）                                        │
│   - go test -tags=integration ./tests/integration/...         │
│   - 连接、流、事件、认证                                        │
├────────────────────────────────────────────────────────────────┤
│ Level 1: 单元测试                                              │
│   - 单函数/方法                                                │
│   - go test ./...                                             │
│   - 与源码同目录                                               │
└────────────────────────────────────────────────────────────────┘
```

### 10.2 相关文档

| 文档 | 说明 |
|------|------|
| [test_pyramid.md](test_pyramid.md) | 测试金字塔四层架构 |
| [network_validation.md](network_validation.md) | 真实网络验证详细设计 |
| [test_strategy.md](test_strategy.md) | 测试策略方法论 |
| `design/_discussions/20260120-distributed-validation-framework.md` | 分布式验证框架设计 |

---

## 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-11 | DeP2P Team | 初始版本 |
| v1.1 | 2026-01-17 | DeP2P Team | 添加架构层级覆盖分析 |
| v2.0 | 2026-01-20 | DeP2P Team | **重大更新**：添加真实网络验证覆盖、场景矩阵、BUG 关联 |
