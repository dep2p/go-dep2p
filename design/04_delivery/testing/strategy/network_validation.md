# 真实网络验证策略

> P2P 系统的第四层测试：真实网络环境下的验证

---

## 元信息

| 字段 | 值 |
|------|-----|
| **状态** | approved |
| **Owner** | DeP2P Team |
| **创建日期** | 2026-01-20 |
| **更新日期** | 2026-01-20 |
| **关联文档** | `design/_discussions/20260120-distributed-validation-framework.md` |

---

## 1. 概述

### 1.1 为什么需要真实网络验证？

P2P 系统存在以下**无法在本地测试环境模拟**的场景：

| 场景 | 本地测试能力 | 原因 |
|------|:------------:|------|
| NAT 穿透 | ❌ 不可能 | 需要真实 NAT 设备和网络拓扑 |
| STUN 地址发现 | ❌ 不可能 | 需要真实公网 STUN 服务器 |
| 4G/WiFi 切换 | ❌ 不可能 | 需要真实移动网络 |
| 中继跨网络通信 | ⚠️ 部分 | 可模拟但不完整 |
| DHT 大规模路由 | ⚠️ 有限 | 本地节点数受限 |
| 公网地址可达性 | ❌ 不可能 | 需要真实公网环境 |

### 1.2 核心理念

```
用户层无感知 + 底层全方位验证 + AI 驱动分析
```

- **用户层无感知**：正常使用 Chat 示例（启节点、发消息）
- **底层全方位验证**：通过结构化日志记录所有关键事件
- **AI 驱动分析**：将日志提交给 AI 进行深度分析

---

## 2. 验证架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     P2P 真实网络验证架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 用户层（无感知）                                                      │   │
│  │                                                                      │   │
│  │  Chat UI ──► /msg /peers /status （正常交互）                        │   │
│  │                                                                      │   │
│  └──────────────────────────────┬───────────────────────────────────────┘   │
│                                 │                                           │
│  ┌──────────────────────────────▼───────────────────────────────────────┐   │
│  │ 验证层（结构化日志）                                                   │   │
│  │                                                                      │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐         │   │
│  │  │ NAT 事件   │  │ DHT 事件   │  │ Relay 事件 │  │ PubSub 事件│         │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘         │   │
│  │                                                                      │   │
│  │  ═══════════════════════════════════════════════════════════════════ │   │
│  │  JSON Lines 日志输出                                                  │   │
│  │                                                                      │   │
│  └──────────────────────────────┬───────────────────────────────────────┘   │
│                                 │                                           │
│  ┌──────────────────────────────▼───────────────────────────────────────┐   │
│  │ 分析层（AI 驱动）                                                     │   │
│  │                                                                      │   │
│  │  日志文件 ──► AI 分析 ──► 验证报告 ──► 问题修复                        │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 验证场景

### 3.1 场景矩阵

| 场景 ID | 场景名称 | 节点配置 | 验证重点 | 优先级 |
|---------|----------|----------|----------|:------:|
| **S01** | 基础三节点通信 | WiFi + 4G + 云 | 连接、消息投递 | P0 |
| **S02** | NAT 穿透验证 | 严格NAT + 对称NAT | 打洞、中继回退 | P0 |
| **S03** | DHT 路由验证 | 3+ 节点 | 路由表、节点发现 | P0 |
| **S04** | 中继通信验证 | NAT后节点 + 中继 | 预留、电路、延迟 | P1 |
| **S05** | 成员同步验证 | 动态加入/离开 | 同步协议、去重 | P1 |
| **S06** | 网络切换恢复 | WiFi↔4G 切换 | 检测、重连、恢复 | P1 |
| **S07** | 消息可靠投递 | 高延迟/丢包 | 重传、顺序 | P2 |
| **S08** | 启动顺序验证 | 依赖组件 | 时序、就绪 | P2 |

### 3.2 场景详情

#### S01: 基础三节点通信

**拓扑**：

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ WiFi 节点   │     │ 4G 节点     │     │ 云服务器    │
│ (NAT 后)    │     │ (NAT 后)    │     │ (公网可达)  │
│             │     │             │     │             │
│ 角色：Client│     │ 角色：Client│     │ 角色：Server│
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       └───────────────────┴───────────────────┘
                    同一 Realm
```

**检查点**：

| ID | 检查点 | 预期 | 验证方法 |
|----|--------|------|----------|
| CP01 | WiFi 获取公网地址 | STUN 成功 | 日志: `event=stun_query success=true` |
| CP02 | 4G 获取公网地址 | STUN 成功 | 日志: `event=stun_query success=true` |
| CP03 | WiFi 连接云服务器 | 直连成功 | 日志: `event=dial_result success=true` |
| CP04 | 4G 连接云服务器 | 直连成功 | 日志: `event=dial_result success=true` |
| CP05 | DHT 路由表更新 | 自动添加 | 日志: `event=routing_update action=add` |
| CP06 | 成员互相发现 | 3 个成员 | 日志: `event=member_add total=3` |
| CP07 | 群聊全员投递 | 3 节点收到 | 日志: `event=message_delivery` × 3 |
| CP08 | 私聊投递 | 目标收到 | 日志: `event=stream_receive` |

#### S02: NAT 穿透验证

**拓扑**：

```
WiFi (严格 NAT)  ───X───  4G (对称 NAT)
        │                      │
        └──────► Relay ◄───────┘
```

**检查点**：

| ID | 检查点 | 预期 | 验证方法 |
|----|--------|------|----------|
| CP01 | NAT 类型检测 | 正确识别 | 日志: `event=nat_type_detected` |
| CP02 | 直连尝试 | 失败 | 日志: `event=dial_result success=false` |
| CP03 | 打洞尝试 | 记录 | 日志: `event=hole_punch_result` |
| CP04 | 中继回退 | 触发 | 日志: `event=relay_fallback` |
| CP05 | 中继电路 | 建立 | 日志: `event=circuit_established` |
| CP06 | 通信延迟 | < 500ms | 日志: `latency_ms < 500` |

---

## 4. 日志规范

### 4.1 事件分类

| Component | 事件前缀 | 示例事件 |
|-----------|----------|----------|
| `nat` | `nat.*` | `stun_query`, `type_detected`, `hole_punch_result` |
| `dht` | `dht.*` | `start`, `routing_update`, `find_peer`, `advertise` |
| `relay` | `relay.*` | `discover`, `reservation`, `circuit_established` |
| `conn` | `conn.*` | `dial_start`, `dial_result`, `established`, `closed` |
| `pubsub` | `pubsub.*` | `join`, `mesh_update`, `publish`, `deliver` |
| `member` | `member.*` | `add`, `remove`, `sync_request`, `sync_receive` |
| `system` | `system.*` | `start`, `ready`, `network_change`, `recovery` |

### 4.2 日志格式

```json
{
  "ts": "2026-01-20T10:30:15.123Z",
  "level": "INFO",
  "component": "nat",
  "event": "stun_query",
  "node_id": "GUjWXgqA",
  "node_type": "wifi",
  "success": true,
  "duration_ms": 45,
  "details": {
    "server": "stun.l.google.com:19302",
    "result_ip": "101.37.245.124",
    "result_port": 4003
  }
}
```

### 4.3 关键日志搜索

| 功能 | 搜索关键字 |
|------|-----------|
| STUN 查询 | `event=stun_query` |
| NAT 类型 | `event=nat_type_detected` |
| DHT 启动 | `event=dht_start` |
| 连接建立 | `event=dial_result success=true` |
| 中继回退 | `event=relay_fallback` |
| 成员同步 | `event=member_sync` |
| 消息投递 | `event=message_delivery` |
| 错误 | `level=ERROR` |

---

## 5. AI 分析流程

### 5.1 分析 Prompt 模板

```markdown
## P2P 网络日志分析

### 场景信息
- **场景**: {场景名称}
- **节点配置**:
  - 节点 A: {类型} / {网络} / ID: {id}
  - 节点 B: {类型} / {网络} / ID: {id}
  - 节点 C: {类型} / {网络} / ID: {id}
- **测试时间**: {开始} - {结束}

### 日志内容
<logs>
{粘贴日志}
</logs>

### 请分析
1. 检查点验证（逐个列出通过/失败）
2. 连接状态分析（NAT 类型、穿透方法、成功率）
3. DHT 健康评估（路由表、查询效率）
4. 消息投递验证（投递率、延迟）
5. 异常检测（错误日志、时序问题）
6. 模块健康评分（1-10 分）
7. 建议修复项（P0/P1/P2）
```

### 5.2 分析输出

AI 分析后输出验证报告，格式参见 [验证报告模板](#7-验证报告模板)。

---

## 6. 执行指南

### 6.1 准备工作

**节点准备**：

| 节点 | 要求 | 启动命令 |
|------|------|----------|
| 云服务器 | 公网 IP | `go run ./examples/chat --serve --port 4001 --public-addr "/ip4/IP/udp/4001/quic-v1"` |
| WiFi 节点 | NAT 后 | `go run ./examples/chat --bootstrap "..."` |
| 4G 节点 | NAT 后 | `go run ./examples/chat --bootstrap "..."` |

**日志收集**：

```bash
# 日志自动保存到
examples/chat/data/logs/chat-YYYYMMDD-HHMMSS-PID.log
```

### 6.2 执行步骤

```
1. 启动云服务器节点 (--serve)
2. 记录云服务器的连接地址
3. 启动 WiFi 节点，指定 --bootstrap
4. 启动 4G 节点，指定 --bootstrap
5. 执行测试操作：
   - 发送群聊消息
   - 发送私聊消息
   - 查看成员列表 (/peers)
   - 查看状态 (/status)
6. 收集所有节点的日志文件
7. 提交给 AI 分析
```

### 6.3 日志分析

```bash
# 收集日志
scp server:~/chat/data/logs/*.log ./logs/
cp ~/chat/data/logs/*.log ./logs/

# 提交给 AI
# 使用上述 Prompt 模板
```

---

## 7. 验证报告模板

```markdown
# P2P 网络验证报告

## 基本信息

| 项目 | 值 |
|------|-----|
| 报告日期 | YYYY-MM-DD |
| 场景 ID | S01 |
| 场景名称 | 基础三节点通信 |
| 测试时间 | HH:MM - HH:MM |

## 节点配置

| 节点 ID | 类型 | 网络环境 | 角色 |
|---------|------|----------|------|
| GUjWXgqA | WiFi | NAT 后 | Client |
| A9Ruftfy | 4G | NAT 后 | Client |
| 12D3KooW | 云服务器 | 公网 | Server |

## 检查点验证

| 检查点 | 状态 | 耗时 | 备注 |
|--------|:----:|------|------|
| CP01: WiFi 获取公网地址 | ✅ | 45ms | |
| CP02: 4G 获取公网地址 | ✅ | 52ms | |
| ... | | | |

## 模块健康评分

| 模块 | 分数 | 说明 |
|------|:----:|------|
| NAT/STUN | 9 | 正常 |
| DHT | 8 | 正常 |
| Relay | N/A | 未使用 |
| PubSub | 8 | 延迟略高 |
| Streams | 9 | 正常 |
| Member Sync | 9 | 正常 |

## 发现的问题

| 优先级 | 问题 | 建议 |
|--------|------|------|
| P1 | 4G 延迟较高 | 优化中继选择 |

## 结论

**验证结果**: ✅ 通过 / ❌ 未通过 / ⚠️ 部分通过
```

---

## 8. 与 BUG 跟踪关联

真实网络验证用于验证 `20260119-bug-tracking-chat-example.md` 中记录的 BUG 修复：

| BUG ID | 问题 | 验证场景 | 验证状态 |
|--------|------|----------|----------|
| BUG-1 | STUN 地址端口组合 | S01, S02 | ⚠️ 待验证 |
| BUG-3 | 成员同步机制 | S05 | ⚠️ 待验证 |
| BUG-6 | DHT 未启动 | S03 | ⚠️ 待验证 |
| BUG-7 | DHT 不监听连接事件 | S03 | ⚠️ 待验证 |
| ... | | | |

验证通过后，更新 BUG 跟踪文档中的验证状态。

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| `design/_discussions/20260120-distributed-validation-framework.md` | 详细设计（日志格式、AI Prompt 等） |
| `design/_discussions/20260119-bug-tracking-chat-example.md` | BUG 跟踪 |
| `tests/README.md` | 测试目录说明 |
| `examples/chat/README.md` | Chat 示例使用说明 |

---

## 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-20 | DeP2P Team | 初始版本 |
