# 端到端测试用例 (E2E)

> 端到端测试用例集

---

## 概述

本目录包含 DeP2P 的端到端测试用例，验证完整的用户场景和跨模块协作。E2E 测试模拟真实的多节点环境，验证系统整体行为。

**代码位置**: `tests/e2e/`

---

## 用例清单

| 用例 ID | 标题 | 场景 | 优先级 | 状态 | 代码位置 |
|---------|------|------|:------:|:----:|----------|
| TST-E2E-0001 | 完整聊天场景 | 对标 chat-local | P0 | ✅ | `scenario/chat_test.go` |
| TST-E2E-0002 | 私聊场景 | Streams 私聊 | P0 | ✅ | `scenario/chat_test.go` |
| TST-E2E-0003 | mDNS 发现场景 | 本地节点发现 | P0 | ✅ | `scenario/discovery_test.go` |
| TST-E2E-0004 | 发现后加入场景 | 发现并加入 Realm | P0 | ✅ | `scenario/discovery_test.go` |
| TST-E2E-0005 | 网络分区场景 | 分区容错 | P1 | ⏳ | `resilience/partition_test.go` |
| TST-E2E-0006 | 故障恢复场景 | 节点故障恢复 | P1 | ⏳ | `resilience/recovery_test.go` |
| TST-E2E-0007 | NAT 穿透场景 | 穿越 NAT 连接 | P1 | ⏳ | 待添加 |
| TST-E2E-0008 | 中继回退场景 | 无法直连时回退 | P1 | ⏳ | 待添加 |
| TST-E2E-0009 | 大规模网络 | 100+ 节点 | P2 | ⏳ | 待添加 |
| TST-E2E-0010 | 长时间运行 | 24 小时稳定性 | P2 | ⏳ | 待添加 |

### 当前状态统计

- ✅ **已实现**: 4 个
- ⏳ **计划中**: 6 个

---

## 用例详情

### TST-E2E-0001: 完整聊天场景 (chat_test.go)

| 字段 | 值 |
|------|-----|
| **ID** | TST-E2E-0001 |
| **类型** | E2E |
| **优先级** | P0 |
| **预计时间** | 90 秒 |
| **代码位置** | `tests/e2e/scenario/chat_test.go` |
| **状态** | ✅ 已实现 |

**场景描述**：模拟 chat-local 完整流程，包括群聊、私聊、成员退出

**测试拓扑**：

```
┌───────────────────────────────────────────────────────────────┐
│                       Realm (PSK 认证)                        │
│                                                               │
│    ┌─────────┐          ┌─────────┐          ┌─────────┐     │
│    │  Alice  │◄────────►│   Bob   │◄────────►│ Charlie │     │
│    │  Node   │          │  Node   │          │  Node   │     │
│    └─────────┘          └─────────┘          └─────────┘     │
│                                                               │
│   Phase 3: 群聊 (PubSub)                                      │
│   Phase 4: 私聊 (Streams)                                     │
│   Phase 5: 成员退出                                           │
└───────────────────────────────────────────────────────────────┘
```

**测试步骤**：

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| Phase 1 | 启动 Alice/Bob/Charlie 节点 | 监听成功 |
| Phase 2 | 三节点加入同一 Realm | PSK 认证通过，成员数 = 3 |
| Phase 3 | Alice 发送群聊消息 | Bob/Charlie 收到 |
| Phase 4 | Alice 通过 Streams 私聊 Bob | Bob 收到私密消息 |
| Phase 5 | Charlie 退出 | Alice/Bob 成员数 = 2 |

**关键验证点**：

- 成员发现：`WaitForMembers(t, realm, 3, 30*time.Second)`
- PubSub 消息传播
- Streams 双向通信
- 断开事件触发成员列表更新

---

### TST-E2E-0002: 私聊场景 (chat_test.go)

| 字段 | 值 |
|------|-----|
| **ID** | TST-E2E-0002 |
| **类型** | E2E |
| **优先级** | P0 |
| **预计时间** | 60 秒 |
| **代码位置** | `tests/e2e/relay_test.go` |

**场景描述**：两个无法直连的节点通过 Relay 中继通信

**测试拓扑**：

```
┌──────────┐    ┌──────────┐    ┌──────────┐
│  Node A  │◄──►│  Relay   │◄──►│  Node B  │
└──────────┘    └──────────┘    └──────────┘
   (NAT后)                         (NAT后)
```

**测试步骤**：

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 启动 Relay 服务 | 监听成功 |
| 2 | 启动节点 A，注册到 Relay | 注册成功 |
| 3 | 启动节点 B，注册到 Relay | 注册成功 |
| 4 | B 通过 Relay 连接 A | 中继连接建立 |
| 5 | B 向 A 发送消息 | A 收到消息 |
| 6 | A 向 B 回复消息 | B 收到消息 |
| 7 | 验证数据完整性 | 数据一致 |

---

### TST-E2E-0003: Realm 场景

| 字段 | 值 |
|------|-----|
| **ID** | TST-E2E-0003 |
| **类型** | E2E |
| **优先级** | P0 |
| **预计时间** | 90 秒 |
| **代码位置** | `tests/e2e/realm_test.go` |

**场景描述**：多个节点加入同一 Realm 并进行隔离通信

**测试拓扑**：

```
           ┌─────────────────────────────┐
           │          Realm X            │
           │  ┌───────┐    ┌───────┐    │
           │  │Node A │◄──►│Node B │    │
           │  └───────┘    └───────┘    │
           │       ▲                     │
           │       │                     │
           │       ▼                     │
           │  ┌───────┐                  │
           │  │Node C │                  │
           │  └───────┘                  │
           └─────────────────────────────┘
                        
┌───────┐
│Node D │  (不在 Realm X，无法访问)
└───────┘
```

**测试步骤**：

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 创建 Realm X | 成功 |
| 2 | 节点 A、B、C 加入 Realm X | 加入成功 |
| 3 | 节点 D 不加入 | - |
| 4 | A 在 Realm 内发现 B、C | 发现成功 |
| 5 | A 向 Realm 广播消息 | B、C 收到 |
| 6 | D 尝试连接 A | 被拒绝 |
| 7 | D 尝试加入 Realm（错误 PSK） | 被拒绝 |

---

### TST-E2E-0007: 故障恢复场景

| 字段 | 值 |
|------|-----|
| **ID** | TST-E2E-0007 |
| **类型** | E2E |
| **优先级** | P1 |
| **预计时间** | 120 秒 |
| **代码位置** | `tests/e2e/failover_test.go` |

**场景描述**：验证节点在网络故障后的恢复能力

**测试步骤**：

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 建立 A-B 连接 | 成功 |
| 2 | 模拟网络断开 | 连接丢失 |
| 3 | 等待 30 秒 | 触发重连逻辑 |
| 4 | 恢复网络 | 自动重连成功 |
| 5 | 验证通信恢复 | 消息正常传递 |

---

## 测试环境

### 硬件要求

| 资源 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2 核 | 4 核 |
| 内存 | 4 GB | 8 GB |
| 网络 | 1 Gbps | 10 Gbps |

### 软件要求

| 软件 | 版本 |
|------|------|
| Go | ≥ 1.21 |
| Docker | ≥ 20.10 |
| Docker Compose | ≥ 2.0 |

---

## 运行方式

### 本地运行

```bash
# 运行所有 E2E 测试
go test -tags=e2e -timeout=10m ./tests/e2e/...

# 运行特定测试
go test -tags=e2e -run TestE2E_DirectConnection ./tests/e2e/...

# 详细输出
go test -tags=e2e -v -timeout=10m ./tests/e2e/...
```

### Docker 运行

```bash
# 构建测试镜像
docker build -t dep2p-e2e-test -f tests/e2e/Dockerfile .

# 运行测试
docker run --rm dep2p-e2e-test
```

### CI 运行

```yaml
e2e:
  runs-on: ubuntu-latest
  timeout-minutes: 15
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v5
    - run: go test -tags=e2e -timeout=10m ./tests/e2e/...
```

---

## 测试报告

### 成功标准

| 指标 | 标准 |
|------|------|
| 用例通过率 | 100% |
| 执行时间 | < 10 分钟 |
| 无 Flaky 测试 | 连续 5 次通过 |

### 报告格式

```markdown
## E2E 测试报告

**日期**: YYYY-MM-DD
**版本**: vX.Y.Z
**环境**: Ubuntu 22.04, Go 1.21

### 结果摘要
- 总用例数: N
- 通过: N
- 失败: 0
- 跳过: 0
- 执行时间: N 分钟

### 详细结果
| 用例 | 结果 | 耗时 |
|------|------|------|
| TST-E2E-0001 | ✅ | 5s |
| ... | ... | ... |
```

---

**最后更新**：2026-01-11
