# 混沌测试场景

> 故障场景定义和验证标准

---

## 场景索引

| 场景 ID | 名称 | 故障类型 | 优先级 | 状态 |
|---------|------|----------|:------:|:----:|
| CHAOS-001 | 网络分区 | 网络 | P0 | ⏳ |
| CHAOS-002 | 节点崩溃 | 节点 | P0 | ⏳ |
| CHAOS-003 | Relay 故障 | 依赖 | P0 | ⏳ |
| CHAOS-004 | 高延迟 | 网络 | P1 | ⏳ |
| CHAOS-005 | 丢包 | 网络 | P1 | ⏳ |
| CHAOS-006 | 资源耗尽 | 节点 | P1 | ⏳ |
| CHAOS-007 | 级联故障 | 复合 | P2 | ⏳ |
| CHAOS-008 | 脑裂 | 网络 | P2 | ⏳ |

---

## 场景详情

### CHAOS-001: 网络分区

**目标**：验证网络分区时系统的行为和恢复能力

**故障描述**：

```
┌──────────────────┐     X     ┌──────────────────┐
│   Partition A    │     X     │   Partition B    │
│  ┌────┐ ┌────┐  │     X     │  ┌────┐ ┌────┐  │
│  │ N1 │ │ N2 │  │     X     │  │ N3 │ │ N4 │  │
│  └────┘ └────┘  │     X     │  └────┘ └────┘  │
└──────────────────┘     X     └──────────────────┘
                    网络分区
```

**注入方法**：

```bash
# 使用 iptables 创建分区
iptables -A INPUT -s 192.168.1.0/24 -j DROP
iptables -A OUTPUT -d 192.168.1.0/24 -j DROP
```

**预期行为**：

| 阶段 | 预期行为 |
|------|----------|
| 分区开始 | 跨分区连接断开，分区内通信正常 |
| 分区期间 | 尝试重连，使用本地缓存路由 |
| 分区恢复 | 自动重连，状态同步 |

**验证点**：

- [ ] 分区内消息正常传递
- [ ] 分区恢复后自动重连
- [ ] 无数据丢失（已确认消息）
- [ ] 恢复时间 ≤ 30 秒

---

### CHAOS-002: 节点崩溃

**目标**：验证节点突然崩溃时其他节点的处理

**故障描述**：模拟节点进程被强制终止

**注入方法**：

```bash
# 强制终止进程
kill -9 $PID
```

**预期行为**：

| 阶段 | 预期行为 |
|------|----------|
| 崩溃发生 | 其他节点检测到连接断开 |
| 检测阶段 | 心跳超时，标记节点离线 |
| 恢复阶段 | 节点重启后重新加入网络 |

**验证点**：

- [ ] 其他节点在 10 秒内检测到故障
- [ ] 从路由表移除故障节点
- [ ] 重启后可重新加入
- [ ] 身份信息保持不变

---

### CHAOS-003: Relay 故障

**目标**：验证 Relay 服务故障时的故障转移

**故障描述**：Relay 或 Relay 服务不可用

**预期行为**：

| 阶段 | 预期行为 |
|------|----------|
| Relay 故障 | 检测到连接断开 |
| 故障转移 | 切换到备用 Relay |
| 恢复 | 主 Relay 恢复后可切回 |

**验证点**：

- [ ] 故障转移时间 ≤ 30 秒
- [ ] 切换期间消息暂存
- [ ] 无消息丢失
- [ ] 自动切换到备用 Relay

---

### CHAOS-004: 高延迟

**目标**：验证高网络延迟下的系统行为

**故障描述**：网络延迟增加到 500ms+

**注入方法**：

```bash
# 使用 tc 添加延迟
tc qdisc add dev eth0 root netem delay 500ms 100ms
```

**预期行为**：

| 阶段 | 预期行为 |
|------|----------|
| 延迟注入 | 超时配置生效 |
| 高延迟期间 | 适当降级，增加超时 |
| 恢复 | 恢复正常性能 |

**验证点**：

- [ ] 不产生级联超时
- [ ] 连接保持稳定
- [ ] 消息最终送达
- [ ] 适当的错误处理

---

### CHAOS-005: 丢包

**目标**：验证网络丢包时的重传机制

**故障描述**：模拟 10-30% 的网络丢包

**注入方法**：

```bash
# 使用 tc 模拟丢包
tc qdisc add dev eth0 root netem loss 20%
```

**预期行为**：

- TCP: 自动重传，延迟增加
- QUIC: 快速重传，性能较好
- 应用层: 消息最终送达

**验证点**：

- [ ] 消息最终送达
- [ ] 无数据损坏
- [ ] 合理的重传策略
- [ ] 性能下降在可接受范围

---

### CHAOS-006: 资源耗尽

**目标**：验证资源压力下的优雅降级

**故障描述**：CPU、内存、文件描述符耗尽

**注入方法**：

```bash
# CPU 压力
stress-ng --cpu 4 --timeout 60s

# 内存压力
stress-ng --vm 2 --vm-bytes 80% --timeout 60s

# 文件描述符
ulimit -n 100
```

**预期行为**：

| 资源 | 预期行为 |
|------|----------|
| CPU 压力 | 请求队列，延迟增加 |
| 内存压力 | 连接管理器关闭空闲连接 |
| FD 耗尽 | 拒绝新连接，保持现有连接 |

**验证点**：

- [ ] 优雅降级，不崩溃
- [ ] 适当的错误响应
- [ ] 资源恢复后正常工作
- [ ] 日志记录资源压力

---

### CHAOS-007: 级联故障

**目标**：验证故障不会级联扩散

**故障描述**：多个组件同时或连续故障

**场景**：

1. Relay 故障 + 高延迟
2. 50% 节点崩溃
3. 网络分区 + 节点故障

**验证点**：

- [ ] 故障隔离，不扩散
- [ ] 部分可用性保持
- [ ] 恢复后完全可用

---

## 测试执行

### 环境准备

```bash
# 安装工具
apt install -y iproute2 iptables stress-ng

# 准备网络命名空间
ip netns add chaos-test
```

### 执行脚本

```bash
#!/bin/bash
# scripts/chaos-test.sh

SCENARIO=$1
DURATION=${2:-60}

case $SCENARIO in
  "network-partition")
    inject_network_partition
    ;;
  "node-crash")
    inject_node_crash
    ;;
  "relay-failure")
    inject_relay_failure
    ;;
esac

# 运行测试负载
run_workload $DURATION

# 恢复
recover_fault $SCENARIO

# 验证
validate_recovery
```

---

## 报告格式

```markdown
## 混沌测试报告

**场景**: CHAOS-001 网络分区
**日期**: 2026-01-11
**环境**: 4 节点测试集群

### 测试结果

| 验证点 | 结果 | 说明 |
|--------|------|------|
| 分区内通信 | ✅ | 正常 |
| 自动重连 | ✅ | 25秒内恢复 |
| 数据完整性 | ✅ | 无丢失 |

### 问题发现

无

### 结论

测试通过
```

---

**最后更新**：2026-01-11
