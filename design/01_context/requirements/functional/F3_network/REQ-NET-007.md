# REQ-NET-007: 快速断开检测

## 1. 元数据

| 属性 | 值 |
|------|---|
| **ID** | REQ-NET-007 |
| **标题** | 快速断开检测 (Fast Disconnect Detection) |
| **类型** | generic |
| **层级** | F3 |
| **优先级** | P0 |
| **状态** | draft |
| **创建日期** | 2026-01-28 |
| **更新日期** | 2026-01-28 |
| **来源** | BUG-34 分析、生产环境测试 |

---

## 2. 需求描述

节点必须能够**快速、准确**地检测到其他节点的断开，并将断开信息传播给 Realm 内所有成员，确保成员列表与实际连接状态一致。

---

## 3. 背景与动机

### 3.1 问题陈述

当前系统存在以下关键问题：

1. **检测延迟过长**：非优雅断开需要 30s~2min 才能检测到
2. **跨节点不一致**：直连节点和非直连节点的检测延迟差异巨大
3. **状态脱节**：成员状态与连接状态独立维护，导致已断开的成员被重新添加

```
场景：4G 节点突然断网

时间线:
T+0s     4G 节点断网（无任何信号发出）
T+0s     WiFi 节点通过 RelayCircuit keepalive 检测到断开
T+30s    云服务器通过 Liveness Ping 检测到断开
T+30s    云服务器的成员列表才更新

问题：云服务器比 WiFi 节点晚了 30 秒才感知到离线
```

### 3.2 目标

| 断开类型 | 场景 | 目标检测延迟 | 当前延迟 |
|---------|------|-------------|---------|
| 优雅断开 | 所有场景 | < 100ms | 瞬时 ✓ |
| 非优雅断开 | 直连节点 | < 10s | 30s ~ 2min |
| 非优雅断开 | Relay 连接 | < 15s | 30s ~ 2min |
| 非优雅断开 | 非直连（需见证） | < 20s | 30s ~ 2min |

### 3.3 约束条件

1. **CAP 定理限制**：在分区场景下，无法同时保证一致性和可用性
2. **物理定律限制**：非优雅断开无法发送信号，只能通过超时推断
3. **误判风险**：检测越快，误判概率越高（网络抖动、临时分区）

---

## 4. 需求详情

### 4.1 功能要求

#### 4.1.1 多层次检测架构

```
检测层次：

  Layer 1: 传输层检测（QUIC Keep-Alive）
  ─────────────────────────────────────────
  • QUIC CLOSE 帧检测（优雅断开）
  • QUIC Keep-Alive 超时（非优雅断开）
  • 延迟: 瞬时 ~ 10s

  Layer 2: 应用层主动通知（MemberLeave）
  ─────────────────────────────────────────
  • 优雅断开时广播离开消息
  • 延迟: 瞬时
  • 限制: 仅优雅断开有效

  Layer 3: 见证人网络（Witness）
  ─────────────────────────────────────────
  • 最先检测到断开的节点广播 WitnessReport
  • 多数确认机制防止误判
  • 延迟: 1-5s

  Layer 4: 应用层心跳（Liveness Ping）
  ─────────────────────────────────────────
  • 定期 Ping 检测
  • 兜底机制
  • 延迟: 30s
```

#### 4.1.2 成员状态同步

| 原则 | 说明 |
|------|------|
| **连接即成员** | 有活跃连接才能是在线成员 |
| **断开即离开** | 连接断开时立即更新成员状态 |
| **保护期例外** | 短暂断开可等待重连，不立即移除 |

#### 4.1.3 误判防护

| 机制 | 作用 |
|------|------|
| **重连宽限期** | 断开后等待 15s，允许重连恢复 |
| **震荡抑制** | 60s 内 3 次断开/重连判定为震荡，暂停状态变更 |
| **多数确认** | 见证人报告需要多数节点确认 |
| **高/低可信区分** | QUIC_CLOSE 高可信，TIMEOUT 低可信 |

### 4.2 接口定义

```go
// 断开检测配置
type DisconnectDetectionConfig struct {
    // QUIC 配置
    KeepAlivePeriod time.Duration  // 默认 3s
    MaxIdleTimeout  time.Duration  // 默认 6s
    
    // 重连宽限期
    ReconnectGracePeriod time.Duration  // 默认 15s
    
    // 震荡检测
    FlapWindowDuration   time.Duration  // 默认 60s
    FlapThreshold        int            // 默认 3
    
    // 见证人
    WitnessEnabled          bool          // 默认 true
    WitnessMaxBroadcastDelay time.Duration // 默认 500ms
    WitnessConfirmTimeout   time.Duration  // 默认 2s
    
    // 断开保护期
    DisconnectProtection time.Duration  // 默认 30s
}
```

### 4.3 性能指标

| 指标 | 要求 |
|------|------|
| 优雅断开检测延迟 | < 100ms |
| 非优雅断开检测延迟（直连） | < 10s |
| 非优雅断开检测延迟（Relay） | < 15s |
| 跨节点传播延迟 | < 5s |
| 误判率（正常网络） | < 1% |
| 误判率（弱网络） | < 5% |

### 4.4 错误处理

| 场景 | 处理 |
|------|------|
| 见证报告签名无效 | 丢弃，记录日志 |
| 见证报告过期（>10s） | 丢弃 |
| 投票不足 | 等待超时，启用兜底检测 |
| 网络分区 | 进入分区模式，提高确认阈值 |

---

## 5. 验收标准

- [ ] 优雅断开检测延迟 < 100ms
- [ ] 非优雅断开检测延迟（直连）< 10s
- [ ] 非优雅断开检测延迟（Relay）< 15s
- [ ] 成员状态与连接状态保持一致
- [ ] 断开保护期防止竞态重新添加
- [ ] 震荡抑制防止频繁状态变更
- [ ] 见证人机制实现多数确认
- [ ] 单元测试覆盖所有检测场景

---

## 6. 非功能要求

| 维度 | 要求 |
|------|------|
| **性能** | QUIC Keep-Alive 网络开销 < 10 kbps / 100 连接 |
| **可靠性** | 检测准确率 > 95%（非分区场景） |
| **可配置** | 所有延迟阈值可配置 |

---

## 7. 关联文档

| 类型 | 链接 |
|------|------|
| **行为设计** | [断开检测流程](../../../../03_architecture/L3_behavioral/disconnect_detection.md) |
| **协议规范** | [存活检测协议](../../../../02_constraints/protocol/L4_application/liveness.md) |
| **协议规范** | [QUIC 传输协议](../../../../02_constraints/protocol/L2_transport/quic.md) |
| **架构决策** | [ADR-0012 断开检测架构](../../decisions/ADR-0012-disconnect-detection.md) |
| **相关需求** | [REQ-NET-005 网络弹性](REQ-NET-005.md) |

---

## 8. 实现追踪

### 8.1 代码引用

| 文件 | 符号 | 状态 |
|------|------|------|
| `internal/realm/witness/` | `Service` | ⏳ 待实现 |
| `internal/realm/member/` | `Manager` | ✓ 已更新 |
| `internal/core/transport/quic/` | `Config` | ✓ 已更新 |

### 8.2 测试证据

| 测试文件 | 测试函数 | 状态 |
|----------|----------|------|
| `witness/service_test.go` | `TestWitnessReport` | ⏳ 待实现 |
| `member/manager_test.go` | `TestDisconnectProtection` | ⏳ 待实现 |

---

## 9. 变更历史

| 日期 | 版本 | 变更说明 |
|------|------|----------|
| 2026-01-28 | 1.0 | 初始版本，基于 BUG-34 分析和快速断开检测设计创建 |
