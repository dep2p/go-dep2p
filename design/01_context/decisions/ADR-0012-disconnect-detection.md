# ADR-0012: 多层次断开检测架构

**状态**: 已采纳  
**日期**: 2026-01-28  
**决策者**: DeP2P 架构团队

---

## 上下文

### 问题背景

在 P2P 网络中，节点断开检测存在以下挑战：

1. **检测延迟与误判的权衡**：检测越快，误判概率越高
2. **跨节点一致性**：直连节点和非直连节点的检测延迟差异大
3. **多种断开场景**：优雅断开、网络中断、进程崩溃等场景特征不同
4. **移动网络复杂性**：4G/WiFi 切换、网络震荡等场景需要特殊处理

### 决策驱动因素

| 因素 | 权重 | 说明 |
|------|------|------|
| 检测延迟 | 高 | 生产环境要求非优雅断开 <15s 检测 |
| 误判率 | 高 | 分区场景下误判会导致成员被错误移除 |
| 网络开销 | 中 | Keep-Alive 频率影响带宽和电池 |
| 实现复杂度 | 中 | 见证人机制增加系统复杂度 |

---

## 决策

**采用多层次断开检测架构**，结合传输层、应用层、见证人网络三种机制互补：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          多层次检测架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Layer 1: 传输层检测（QUIC Keep-Alive）                                     │
│  ─────────────────────────────────────                                      │
│  延迟: 瞬时 ~ 10s                                                           │
│  可靠性: 高（协议层保证）                                                   │
│  局限: 仅检测直连节点                                                       │
│                                                                             │
│  Layer 2: 应用层主动通知（MemberLeave）                                     │
│  ─────────────────────────────────────                                      │
│  延迟: 瞬时                                                                 │
│  可靠性: 中（仅优雅断开有效）                                               │
│  局限: 非优雅断开无法使用                                                   │
│                                                                             │
│  Layer 3: 见证人网络（WitnessReport）                                       │
│  ─────────────────────────────────────                                      │
│  延迟: 1-5s（广播传播）                                                     │
│  可靠性: 中（需多数确认）                                                   │
│  作用: 解决非直连节点的快速检测                                             │
│                                                                             │
│  Layer 4: 应用层心跳（Liveness Ping）                                       │
│  ─────────────────────────────────────                                      │
│  延迟: 30s                                                                  │
│  可靠性: 高                                                                 │
│  作用: 兜底机制                                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 关键设计决策

#### 1. QUIC Keep-Alive 配置

**决策**: 采用 3s 心跳 + 6s 超时的"平衡配置"

| 配置 | 值 | 理由 |
|------|-----|------|
| KeepAlivePeriod | 3s | 满足 <10s 检测目标 |
| MaxIdleTimeout | 6s | 2 倍心跳间隔，容忍偶发丢包 |

**被拒绝的方案**:
- 更激进的 1s/2s 配置：网络开销增加，误判风险提高
- 更保守的 15s/30s 配置：检测延迟无法满足需求

#### 2. 见证人多数确认机制

**决策**: 采用自适应 Quorum，区分高可信和低可信检测方式

```
高可信检测（可走快速路径）:
  • QUIC_CLOSE（对端主动关闭）
  • TCP_RST/FIN
  • GRACEFUL_SHUTDOWN

低可信检测（需多数确认）:
  • QUIC_TIMEOUT（可能是网络问题）
  • PING_FAILED
  • RELAY_TIMEOUT
```

**被拒绝的方案**:
- 单票即信任：恶意节点可以伪造离线报告
- 全票确认：延迟过高，部分节点可能无响应

#### 3. 重连宽限期

**决策**: 断开后等待 15s 再移除成员

**理由**:
- 4G/WiFi 切换通常 2-10s
- 短暂网络抖动不应导致成员被移除
- 15s 是实际场景下的合理上限

**被拒绝的方案**:
- 无宽限期：移动网络场景下误移除严重
- 更长宽限期（>30s）：真正离线时检测延迟过长

#### 4. 成员状态与连接状态绑定

**决策**: 采用"连接即成员"原则，断开保护期例外

```
不变量: 成员在线状态 = 有活跃连接 ∧ 通过认证

例外: 断开保护期内（30s），已断开的成员不会被 PubSub/DHT 消息重新添加
```

**被拒绝的方案**:
- 状态独立维护：导致成员状态与连接状态脱节（BUG-34）
- 无保护期：竞态条件导致刚断开的成员被重新添加

---

## 后果

### 正面

1. **检测延迟大幅降低**：直连 <10s，非直连 <20s
2. **误判率可控**：多数确认 + 宽限期 + 震荡抑制
3. **跨节点一致性**：见证人机制消除检测延迟差异
4. **可配置性**：所有参数可根据场景调整

### 负面

1. **实现复杂度增加**：见证人协议、投票机制、状态机
2. **网络开销增加**：见证报告广播、确认消息
3. **潜在攻击面**：需要防护伪造报告、见证人风暴等攻击

### 风险与缓解

| 风险 | 缓解措施 |
|------|---------|
| 见证人风暴 | 随机延迟广播 + 收到他人报告后取消 |
| 伪造报告 | 签名验证 + 多数确认 + 限速 |
| 分区误判 | 分区模式检测 + 提高确认阈值 |

---

## 关联文档

| 类型 | 文档 |
|------|------|
| 需求 | [REQ-NET-007 快速断开检测](../requirements/functional/F3_network/REQ-NET-007.md) |
| 行为设计 | [断开检测流程](../../03_architecture/L3_behavioral/disconnect_detection.md) |
| 协议规范 | [存活检测协议](../../02_constraints/protocol/L4_application/liveness.md) |
| 不变量 | [INV-003 连接即成员](invariants/INV-003-connection-membership.md) |
