# ADR-0005: Relay 部署模型分级

## 元数据

| 属性 | 值 |
|------|-----|
| **ID** | ADR-0005 |
| **标题** | Relay 部署模型分级 (Relay Deployment Model Tiers) |
| **状态** | accepted |
| **决策日期** | 2025-12-28 |
| **更新日期** | 2026-01-11 |
| **决策者** | DeP2P 核心团队 |
| **关联 ADR** | [ADR-0003](ADR-0003-relay-first-connect.md), [ADR-0010](ADR-0010-relay-explicit-config.md) |
| **关联需求** | [REQ-NET-003](../requirements/functional/F3_network/REQ-NET-003.md) |

---

## 上下文

DeP2P 的中继服务（Relay）是帮助 NAT 后节点互连的关键基础设施。当前实现提供了功能完整的单实例 Relay Server，但文档没有明确说明部署模型的能力边界，可能导致用户误解：

1. **误以为多实例自动协调**：用户可能部署多个 Relay 实例后，期望它们自动共享 reservation 状态、全局限流等，但实际上每个实例是独立运行的。

2. **分布式系统问题被忽视**：跨地域多实例部署涉及状态同步、一致性、failover 等分布式系统问题，这些超出了 DeP2P 作为"库"的边界。

3. **运维踩坑**：缺乏明确的部署模型指导，用户在生产环境中可能遇到意外行为。

### 决策驱动因素

- **库 vs 产品定位**：DeP2P 定位为 P2P 网络库，而非分布式中继集群产品
- **用户期望管理**：避免用户因文档不明确而产生错误预期
- **为进阶用户留路径**：不阻止用户在 DeP2P 之上构建分布式协调层
- **统一 Relay 架构**：明确统一 Relay 的部署边界

---

## 考虑的选项

### 选项 1: 保持现状，不做分级说明

**描述**：继续让用户自行理解 Relay 的能力边界。

**优点**：
- 无需额外文档工作

**缺点**：
- 用户可能误用
- 生产环境踩坑后才发现问题
- 增加技术支持负担

### 选项 2: 明确分级，声明边界

**描述**：定义三种部署模型，明确各自的能力和限制。

**优点**：
- 用户知道"什么可以、什么不可以"
- 减少误用和踩坑
- 为进阶用户提供扩展指引

**缺点**：
- 需要编写和维护文档

### 选项 3: 实现分布式协调能力

**描述**：在 DeP2P 中实现多实例 Relay 协调。

**优点**：
- 开箱即用的分布式能力

**缺点**：
- 大幅增加复杂度
- 偏离"库"的定位
- 维护成本高
- 用户可能并不需要

---

## 决策结果

选择 **选项 2: 明确分级，声明边界**。

DeP2P 作为库，提供单实例 Relay 能力，并通过清晰的文档说明部署模型的能力边界。

---

## 部署模型定义

### Tier 1: 单点自托管 (Single Instance)

```
适用场景：
- 小型 Realm (<100 节点)
- 开发测试环境
- 私有网络部署

架构：
┌─────────────────┐
│   Relay Server  │
│    (单实例)     │
└────────┬────────┘
         │
┌────────┴────────┐
▼                 ▼
Node A           Node B

特点：
- 所有状态在内存中（reservation、限流、统计）
- 单点故障 = 服务中断（客户端需重连其他 Relay 或直连）
- 无需外部依赖（无数据库、无消息队列）

支持状态：✅ 当前完全支持
```

| 能力 | 支持 | 说明 |
|------|------|------|
| Reservation 管理 | ✅ | 内存存储，重启后丢失 |
| 连接限流 | ✅ | 单实例内有效 |
| 带宽限制 | ✅ | 单实例内有效 |
| PSK 成员验证 | ✅ | 每次请求验证 |
| 统计指标 | ✅ | 单实例内有效 |
| 高可用 | ❌ | 单点故障 |
| 水平扩展 | ❌ | 不支持 |

### Tier 2: 同 Realm 多中继 (Multiple Independent Relays)

```
适用场景：
- 中型 Realm (100-1000 节点)
- 需要基本高可用
- 地理分布式客户端（就近接入）

架构：
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Relay A (CN) │  │ Relay B (US) │  │ Relay C (EU) │
│   (独立)     │  │   (独立)     │  │   (独立)     │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
客户端通过 DHT/Bootstrap 发现，自行选择最近的 Relay

特点：
- 每个 Relay 独立运行，无状态共享
- 客户端可连接任意可用 Relay
- 单个 Relay 故障不影响其他（降级而非中断）
- Reservation 仅在单实例内有效

支持状态：✅ 当前支持（但无协调）
```

| 能力 | 支持 | 说明 |
|------|------|------|
| 多实例部署 | ✅ | 每个实例独立运行 |
| 客户端发现 | ✅ | 通过 DHT/Bootstrap/手动配置 |
| 就近接入 | ✅ | 客户端自行选择 |
| 故障转移 | ⚠️ | 客户端需重连其他 Relay |
| 跨实例 Reservation | ❌ | 每个实例独立 |
| 全局限流 | ❌ | 每个实例独立限流 |
| 统计聚合 | ❌ | 需自行收集 |

**重要约束**：

```
⚠️ 警告：以下能力在 Tier 2 中不可用

1. 跨实例 Reservation 同步
   - 在 Relay A 建立的 reservation 在 Relay B 上不存在
   - 客户端切换 Relay 后需要重新建立 reservation

2. 全局限流/配额
   - 每个 Relay 独立计数
   - 恶意用户可连接多个 Relay 绕过单实例限流

3. 成员验证缓存一致性
   - 每个 Relay 独立维护 PSK 验证缓存
   - Realm Key 变更需要等待各实例缓存过期
```

### Tier 3: 跨地域分布式集群 (Distributed Cluster)

```
适用场景：
- 大型 Realm (>1000 节点)
- 企业级 SLA 要求
- 全局限流/计费需求

架构（需自行实现）：
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   Relay A    │──│   Relay B    │──│   Relay C    │
│              │  │              │  │              │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       └─────────────────┼─────────────────┘
                         ▼
                ┌────────────────┐
                │  协调层 (自建)  │
                │ Gossip / etcd  │
                │ / Redis 等     │
                └────────────────┘

支持状态：❌ 超出 DeP2P 边界，需自行实现
```

**需要自行解决的分布式系统问题**：

| 问题 | 说明 | 可能的解决方案 |
|------|------|---------------|
| Reservation 同步 | 跨实例共享预留状态 | 分布式 KV (etcd/Redis) |
| 全局限流 | 跨实例计数器 | Redis + Lua / 令牌桶 |
| 成员验证缓存 | 一致性失效 | 发布订阅 / TTL 策略 |
| 故障检测 | 实例健康检查 | Gossip / Consul |
| 负载均衡 | 智能路由 | Anycast / DNS-based |
| 统计聚合 | 全局指标 | Prometheus + 远程写入 |

---

## 决策边界声明

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DeP2P 能力边界                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   DeP2P 作为库：                                                             │
│   ✅ 提供单实例 Relay Server 实现                                            │
│   ✅ 提供 Relay Client 实现                                                  │
│   ✅ 提供 AutoRelay 发现机制                                                 │
│   ✅ 统一 Relay 服务（v2.1 废弃 System/Realm 分层）                         │
│                                                                              │
│   DeP2P 不提供：                                                             │
│   ❌ 多实例 Relay 状态同步                                                   │
│   ❌ 分布式限流/计费                                                         │
│   ❌ 跨实例 Reservation 协调                                                 │
│   ❌ 全局故障转移编排                                                        │
│                                                                              │
│   如需以上能力，请在 DeP2P 之上构建产品级协调层。                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 后果

### 正面后果

- 用户明确知道 DeP2P 的能力边界
- 减少生产环境踩坑
- 为进阶用户提供扩展指引
- 保持 DeP2P 作为"库"的简洁定位

### 负面后果

- 需要编写和维护额外文档
- 部分用户可能期望"开箱即用"的分布式能力

### 中性后果

- 明确划分"库能力"和"产品能力"的边界

---

## 相关文档

| 类型 | 链接 |
|------|------|
| **需求** | [REQ-NET-003](../requirements/functional/F3_network/REQ-NET-003.md): Relay 中继 |
| **ADR** | [ADR-0010](ADR-0010-relay-explicit-config.md): Relay 明确配置 |
| **竞品** | [Relay 设计对比](../references/comparison/transport/03-relay.md) |

---

## 备注

此决策参考了 tunnelto 项目的做法。tunnelto 在其 README 中明确指出：简单自托管版本不支持多实例协调；分布式版本需要 gossip/私网能力。这种"诚实声明边界"的做法有效地避免了用户误解。

---

## 变更历史

| 日期 | 版本 | 变更说明 |
|------|------|----------|
| 2025-12-28 | 1.0 | 初始版本 |
| 2026-01-11 | 1.1 | 迁移到新文档结构，更新关联链接 |
