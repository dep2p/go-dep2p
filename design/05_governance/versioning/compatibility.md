# 兼容性策略

> API 稳定性承诺和兼容性规则

---

## 元信息

| 字段 | 值 |
|------|-----|
| **状态** | approved |
| **Owner** | DeP2P Team |
| **创建日期** | 2026-01-11 |
| **更新日期** | 2026-01-11 |

---

## 1. 兼容性承诺

### 1.1 稳定版本 (v1.0.0+)

| 方面 | 承诺 |
|------|------|
| **公共 API** | 次版本内向后兼容 |
| **配置格式** | 次版本内向后兼容 |
| **协议版本** | 同主版本内兼容 |
| **持久化数据** | 提供迁移工具 |

### 1.2 开发版本 (v0.x.x)

| 方面 | 承诺 |
|------|------|
| **公共 API** | 可能在任何版本变更 |
| **配置格式** | 可能在任何版本变更 |
| **协议版本** | 可能在任何版本变更 |

---

## 2. 兼容性定义

### 2.1 向后兼容

升级到新版本后，现有代码无需修改即可编译运行。

**向后兼容的变更**：
- 新增函数/方法
- 新增可选参数（有默认值）
- 新增配置项（有默认值）
- 性能优化
- Bug 修复

**不向后兼容的变更**：
- 删除或重命名函数/方法
- 修改函数签名
- 修改返回值类型
- 修改行为语义
- 移除配置项

### 2.2 向前兼容

旧版本可以处理新版本产生的数据。

**通常不保证向前兼容**，除非明确声明。

---

## 3. 公共 API 定义

### 3.1 公共 API 范围

| 包 | 稳定性 |
|-----|--------|
| `github.com/dep2p/dep2p` | 稳定 |
| `github.com/dep2p/dep2p/pkg/...` | 稳定 |
| `github.com/dep2p/dep2p/internal/...` | 内部，不保证 |

### 3.2 API 稳定性标记

```go
// Stable: 稳定 API，遵循兼容性承诺
func (n *Node) Connect(ctx context.Context, addr string) error

// Experimental: 实验性 API，可能变更
// Deprecated: 已废弃，将在 vX.Y.0 移除
```

---

## 4. 配置兼容性

### 4.1 配置格式

```yaml
# 配置版本标记
version: "1"

# 配置内容
node:
  listen_addrs:
    - "/ip4/0.0.0.0/tcp/0"
```

### 4.2 配置迁移

当配置格式变更时，提供迁移工具：

```bash
# 迁移配置文件
dep2p config migrate --from v1 --to v2 config.yaml
```

---

## 5. 协议兼容性

### 5.1 协议版本号

```
/dep2p/{protocol}/{major}.{minor}.{patch}

示例：
/dep2p/relay/1.0.0
/dep2p/realm/1.1.0
```

### 5.2 协议协商

节点连接时协商协议版本：

1. 请求方发送支持的版本列表
2. 响应方选择兼容的最高版本
3. 双方使用该版本通信

### 5.3 协议兼容规则

| 版本变更 | 兼容性 |
|----------|--------|
| Patch (1.0.x) | 完全兼容 |
| Minor (1.x.0) | 向后兼容 |
| Major (x.0.0) | 可能不兼容 |

---

## 6. 破坏性变更流程

### 6.1 必须遵循的流程

1. **提前公告**：至少 2 个次版本前公告
2. **提供过渡期**：新旧 API 共存
3. **提供迁移指南**：文档说明迁移方法
4. **提供工具**：如可能，提供自动迁移工具

### 6.2 示例时间线

```
v1.2.0 - 引入新 API，旧 API 标记 Deprecated
v1.3.0 - 继续支持旧 API，发布迁移指南
v2.0.0 - 移除旧 API
```

---

## 7. 兼容性测试

### 7.1 API 兼容性检测

```bash
# 使用 apidiff 检测 API 变更
go install golang.org/x/exp/cmd/apidiff@latest
apidiff old.module new.module
```

### 7.2 CI 集成

```yaml
- name: Check API compatibility
  run: |
    git fetch origin main
    apidiff origin/main HEAD
```

---

## 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-11 | DeP2P Team | 初始版本 |
