# 废弃策略

> 功能废弃流程和迁移指南

---

## 元信息

| 字段 | 值 |
|------|-----|
| **状态** | approved |
| **Owner** | DeP2P Team |
| **创建日期** | 2026-01-11 |
| **更新日期** | 2026-01-11 |

---

## 1. 废弃原则

| 原则 | 说明 |
|------|------|
| **提前通知** | 废弃前至少 2 个次版本通知 |
| **过渡期** | 提供足够的迁移时间 |
| **替代方案** | 必须提供替代方案 |
| **文档支持** | 提供迁移指南 |

---

## 2. 废弃流程

### 2.1 时间线

```mermaid
flowchart LR
    A[标记废弃] -->|v1.2.0| B[发布迁移指南]
    B -->|v1.3.0| C[运行时警告]
    C -->|v2.0.0| D[移除]
```

| 阶段 | 版本 | 动作 |
|------|------|------|
| 标记废弃 | vN.M.0 | 添加 Deprecated 注释 |
| 运行时警告 | vN.M+1.0 | 使用时输出警告日志 |
| 最终移除 | vN+1.0.0 | 删除代码 |

### 2.2 最小保留期

| 变更类型 | 最小保留期 |
|----------|-----------|
| 公共函数/方法 | 2 个次版本 |
| 配置项 | 2 个次版本 |
| CLI 参数 | 2 个次版本 |
| 协议特性 | 1 个主版本 |

---

## 3. 废弃标记

### 3.1 代码标记

```go
// Deprecated: Use NewMethod instead. Will be removed in v2.0.0.
func OldMethod() {
    log.Warn("OldMethod is deprecated, use NewMethod instead")
    // 实现
}

// NewMethod is the replacement for OldMethod.
func NewMethod() {
    // 新实现
}
```

### 3.2 配置标记

```yaml
# 废弃配置项示例
node:
  # DEPRECATED: use listen_addrs instead. Will be removed in v2.0.0.
  # listen_address: "/ip4/0.0.0.0/tcp/0"
  
  # 新配置项
  listen_addrs:
    - "/ip4/0.0.0.0/tcp/0"
```

### 3.3 CLI 标记

```
DEPRECATED FLAGS:
  --old-flag    Use --new-flag instead (will be removed in v2.0.0)
```

---

## 4. 迁移指南

### 4.1 指南模板

```markdown
## 从 OldMethod 迁移到 NewMethod

### 变更说明

`OldMethod` 已废弃，请使用 `NewMethod` 替代。

### 迁移步骤

1. 替换调用：
   ```go
   // 旧代码
   result := OldMethod()
   
   // 新代码
   result := NewMethod()
   ```

2. 更新依赖（如需要）

3. 测试验证

### 行为差异

| 方面 | OldMethod | NewMethod |
|------|-----------|-----------|
| 返回值 | string | Result |
| 错误处理 | panic | 返回 error |
```

### 4.2 自动迁移工具

如可能，提供自动迁移工具：

```bash
# 自动迁移代码
dep2p migrate --from v1 --to v2

# 检查迁移结果
dep2p migrate --check
```

---

## 5. 废弃记录

### 5.1 当前废弃项

| 废弃项 | 废弃版本 | 移除版本 | 替代方案 |
|--------|----------|----------|----------|
| - | - | - | - |

（目前无废弃项）

### 5.2 已移除项

| 已移除项 | 废弃版本 | 移除版本 | 替代方案 |
|----------|----------|----------|----------|
| - | - | - | - |

（目前无已移除项）

---

## 6. 异常情况

### 6.1 紧急移除

在以下情况下，可以缩短废弃周期：

- **安全漏洞**：存在安全风险的功能
- **严重 Bug**：无法修复的设计缺陷
- **法律要求**：合规性要求

### 6.2 延长保留

在以下情况下，可以延长废弃周期：

- 大量用户依赖
- 迁移复杂度高
- 社区反馈强烈

---

## 7. 用户通知

### 7.1 通知渠道

| 渠道 | 时机 |
|------|------|
| CHANGELOG | 每次发布 |
| 发布说明 | 每次发布 |
| 运行时日志 | 使用废弃功能时 |
| 迁移指南 | 发布后 |

### 7.2 通知内容

- 废弃原因
- 替代方案
- 迁移步骤
- 移除时间表
- 获取帮助的方式

---

## 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-11 | DeP2P Team | 初始版本 |
