# Chat ç¤ºä¾‹ - å±€åŸŸç½‘è‡ªåŠ¨å‘ç°èŠå¤©

è¿™æ˜¯ä¸€ä¸ªäº¤äº’å¼èŠå¤©ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ mDNS åœ¨å±€åŸŸç½‘å†…è‡ªåŠ¨å‘ç°å…¶ä»–èŠ‚ç‚¹å¹¶å»ºç«‹ P2P è¿æ¥ã€‚

## æ¦‚è¿°

åœ¨å±€åŸŸç½‘ä¸­ï¼ŒèŠ‚ç‚¹æ— éœ€çŸ¥é“å½¼æ­¤çš„åœ°å€ï¼Œåªéœ€å¯åŠ¨ç¨‹åºï¼ŒmDNS ä¼šè‡ªåŠ¨å¤„ç†å‘ç°å’Œè¿æ¥ã€‚å°±åƒè“ç‰™è®¾å¤‡è‡ªåŠ¨é…å¯¹ä¸€æ ·ç®€å•ï¼

```
å±€åŸŸç½‘ (WiFi/ä»¥å¤ªç½‘)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚   Alice çš„ç”µè„‘         Bob çš„ç”µè„‘       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Chat   â”‚â—„â”€ mDNS â”€â–ºâ”‚  Chat   â”‚     â”‚
â”‚   â”‚  App    â”‚    â†“    â”‚  App    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  è‡ªåŠ¨å‘ç°  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â†‘                    â†‘            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€P2P è¿æ¥â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä½ å°†å­¦åˆ°ä»€ä¹ˆ

- âœ… ä»€ä¹ˆæ˜¯ mDNSï¼ˆå¤šæ’­ DNSï¼‰
- âœ… å¦‚ä½•åœ¨å±€åŸŸç½‘å†…è‡ªåŠ¨å‘ç°èŠ‚ç‚¹
- âœ… å¦‚ä½•ç®¡ç†å¤šä¸ªå¯¹ç­‰æ–¹è¿æ¥
- âœ… å¦‚ä½•æ„å»ºäº¤äº’å¼å‘½ä»¤è¡Œç¨‹åº
- âœ… å¤šèŠ‚ç‚¹å¹¿æ’­æ¶ˆæ¯

## ä»€ä¹ˆæ˜¯ mDNSï¼Ÿ

### é€šä¿—è§£é‡Š

æƒ³è±¡ä½ åœ¨ä¸€ä¸ªæˆ¿é—´é‡Œå–Š"æœ‰äººåœ¨å—ï¼Ÿ"ï¼Œæˆ¿é—´é‡Œçš„äººå¬åˆ°åä¼šå›åº”"æˆ‘åœ¨è¿™å„¿ï¼"ã€‚mDNS å°±æ˜¯è¿™æ ·å·¥ä½œçš„ï¼š

1. **ä½ çš„èŠ‚ç‚¹å¹¿æ’­**: "æˆ‘æ˜¯ Aliceï¼Œæ­£åœ¨å¯»æ‰¾èŠå¤©ä¼™ä¼´"
2. **å…¶ä»–èŠ‚ç‚¹å›åº”**: "æˆ‘æ˜¯ Bobï¼Œæˆ‘ä¹Ÿåœ¨èŠå¤©"
3. **è‡ªåŠ¨è¿æ¥**: åŒæ–¹äº¤æ¢ä¿¡æ¯å¹¶å»ºç«‹è¿æ¥

### æŠ€æœ¯è§£é‡Š

**mDNS** (Multicast DNS) æ˜¯ä¸€ç§åœ¨å±€åŸŸç½‘å†…è¿›è¡ŒæœåŠ¡å‘ç°çš„åè®®ï¼š

- **å¤šæ’­**: ä¸€å¯¹å¤šé€šä¿¡ï¼Œä¸€ä¸ªèŠ‚ç‚¹å‘é€ï¼Œå¤šä¸ªèŠ‚ç‚¹æ¥æ”¶
- **æ— éœ€ä¸­å¿ƒæœåŠ¡å™¨**: èŠ‚ç‚¹ä¹‹é—´ç›´æ¥é€šä¿¡
- **é›¶é…ç½®**: æ— éœ€æ‰‹åŠ¨é…ç½® IP åœ°å€
- **ç«¯å£**: ä½¿ç”¨ UDP 5353 ç«¯å£

### ä½¿ç”¨åœºæ™¯

mDNS é€‚åˆï¼š
- âœ… å±€åŸŸç½‘ç¯å¢ƒï¼ˆå®¶åº­ã€åŠå…¬å®¤ã€ä¼šè®®å®¤ï¼‰
- âœ… ä¸´æ—¶ç»„ç½‘ï¼ˆæ¸¸æˆã€åä½œã€æ–‡ä»¶å…±äº«ï¼‰
- âœ… IoT è®¾å¤‡å‘ç°

mDNS ä¸é€‚åˆï¼š
- âŒ è·¨äº’è”ç½‘é€šä¿¡ï¼ˆéœ€è¦ä½¿ç”¨ DHT æˆ– Bootstrapï¼‰
- âŒ é«˜å®‰å…¨æ€§è¦æ±‚ï¼ˆéœ€è¦é¢å¤–çš„èº«ä»½éªŒè¯ï¼‰
- âŒ å¤§è§„æ¨¡ç½‘ç»œï¼ˆä¼šäº§ç”Ÿè¾ƒå¤šå¹¿æ’­æµé‡ï¼‰

## å‰ç½®è¦æ±‚

- **ç½‘ç»œ**: å¿…é¡»åœ¨åŒä¸€å±€åŸŸç½‘ï¼ˆåŒä¸€ WiFi æˆ–ä»¥å¤ªç½‘ï¼‰
- **é˜²ç«å¢™**: å…è®¸ UDP 5353 ç«¯å£ï¼ˆmDNSï¼‰
- **å¤šæ’­**: ç½‘ç»œéœ€è¦æ”¯æŒå¤šæ’­ï¼ˆå¤§å¤šæ•°å®¶åº­ç½‘ç»œæ”¯æŒï¼‰

### æ£€æŸ¥ç½‘ç»œ

```bash
# æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ç½‘ç»œ
# æ–¹æ³• 1: æŸ¥çœ‹ IP åœ°å€ï¼Œç¡®ä¿å‰ä¸‰æ®µç›¸åŒ
# macOS/Linux
ifconfig | grep "inet "
# Windows
ipconfig

# æ–¹æ³• 2: äº’ç›¸ ping æµ‹è¯•
ping 192.168.1.100  # æ›¿æ¢ä¸ºå¯¹æ–¹çš„ IP
```

## å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆAliceï¼‰

åœ¨ç”µè„‘ A ä¸Šï¼š

```bash
cd examples/chat/
go run main.go -nick Alice
```

è¾“å‡ºï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     DeP2P Chat - mDNS è‡ªåŠ¨å‘ç°èŠå¤©     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš€ èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼
   èŠ‚ç‚¹ ID: 5Q2STWvBAliceNodeID...
   æ˜µç§°: Alice

ğŸ“¡ mDNS å‘ç°å·²å¯åŠ¨ï¼Œæ­£åœ¨å¹¿æ’­...

ğŸ’¬ å¼€å§‹èŠå¤©ï¼ç›´æ¥è¾“å…¥æ¶ˆæ¯æˆ–ä½¿ç”¨å‘½ä»¤ï¼š
   /peers  - æŸ¥çœ‹è¿æ¥çš„èŠ‚ç‚¹
   /info   - æŸ¥çœ‹æœ¬èŠ‚ç‚¹ä¿¡æ¯
   /help   - æ˜¾ç¤ºå¸®åŠ©
   /quit   - é€€å‡ºç¨‹åº

>
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼ˆBobï¼‰

åœ¨ç”µè„‘ B ä¸Šï¼ˆæˆ–åŒä¸€ç”µè„‘çš„å¦ä¸€ä¸ªç»ˆç«¯ï¼‰ï¼š

```bash
cd examples/chat/
go run main.go -nick Bob
```

### ç¬¬ä¸‰æ­¥ï¼šè§‚å¯Ÿè‡ªåŠ¨å‘ç°

å‡ ç§’é’Ÿåï¼ŒAlice çš„ç»ˆç«¯ä¼šæ˜¾ç¤ºï¼š

```
ğŸ” å‘ç°æ–°èŠ‚ç‚¹: Bob (5Q2STWvBBobNodeID...)
ğŸ¤ å·²è¿æ¥åˆ°: Bob
```

Bob çš„ç»ˆç«¯ä¹Ÿä¼šæ˜¾ç¤ºï¼š

```
ğŸ” å‘ç°æ–°èŠ‚ç‚¹: Alice (5Q2STWvBAliceNodeID...)
ğŸ¤ å·²è¿æ¥åˆ°: Alice
```

âœ¨ **å¤ªæ£’äº†ï¼** ä¸¤ä¸ªèŠ‚ç‚¹è‡ªåŠ¨å‘ç°å¹¶è¿æ¥ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥ä»»ä½•åœ°å€ï¼

### ç¬¬å››æ­¥ï¼šå¼€å§‹èŠå¤©

åœ¨ Alice çš„ç»ˆç«¯è¾“å…¥ï¼š

```
> Hello Bob!
```

Bob çš„ç»ˆç«¯ä¼šç«‹å³æ˜¾ç¤ºï¼š

```
[Alice] Hello Bob!
```

åœ¨ Bob çš„ç»ˆç«¯è¾“å…¥ï¼š

```
> Hi Alice! How are you?
```

Alice çš„ç»ˆç«¯ä¼šæ˜¾ç¤ºï¼š

```
[Bob] Hi Alice! How are you?
```

### ç¬¬äº”æ­¥ï¼šä½¿ç”¨å‘½ä»¤

æŸ¥çœ‹å·²è¿æ¥çš„èŠ‚ç‚¹ï¼š

```
> /peers

å·²è¿æ¥çš„èŠ‚ç‚¹ (1):
  [1] Bob (5Q2STWvBBobNodeID...)
```

æŸ¥çœ‹æœ¬èŠ‚ç‚¹ä¿¡æ¯ï¼š

```
> /info

èŠ‚ç‚¹ä¿¡æ¯:
  ID: 5Q2STWvBAliceNodeID...
  æ˜µç§°: Alice
  ç›‘å¬åœ°å€: /ip4/192.168.1.100/udp/54321/quic-v1
```

## å‘½ä»¤å‚è€ƒ

### èŠå¤©å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| ç›´æ¥è¾“å…¥ | å‘é€æ¶ˆæ¯ç»™æ‰€æœ‰è¿æ¥çš„èŠ‚ç‚¹ | `Hello everyone!` |
| `/peers` | åˆ—å‡ºå½“å‰è¿æ¥çš„æ‰€æœ‰èŠ‚ç‚¹ | `/peers` |
| `/info` | æ˜¾ç¤ºæœ¬èŠ‚ç‚¹çš„ä¿¡æ¯ | `/info` |
| `/connect` | æ‰‹åŠ¨è¿æ¥åˆ°æŒ‡å®šèŠ‚ç‚¹ | `/connect <ID> <ADDR>` |
| `/help` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ | `/help` |
| `/quit` | é€€å‡ºç¨‹åº | `/quit` |

### å‘½ä»¤è¯¦è§£

#### /peers - æŸ¥çœ‹è¿æ¥

```
> /peers

å·²è¿æ¥çš„èŠ‚ç‚¹ (2):
  [1] Alice (5Q2STWvBAlice...) 
  [2] Bob (5Q2STWvBBob...)
```

æ˜¾ç¤ºæ‰€æœ‰æ´»è·ƒè¿æ¥çš„èŠ‚ç‚¹åŠå…¶ IDã€‚

#### /info - èŠ‚ç‚¹ä¿¡æ¯

```
> /info

èŠ‚ç‚¹ä¿¡æ¯:
  ID: 5Q2STWvBCharlie...
  æ˜µç§°: Charlie
  ç›‘å¬åœ°å€:
    [1] /ip4/192.168.1.102/udp/56789/quic-v1
    [2] /ip4/127.0.0.1/udp/56789/quic-v1
  å·²è¿æ¥: 2 ä¸ªèŠ‚ç‚¹
```

æ˜¾ç¤ºæœ¬èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯ã€‚

#### /connect - æ‰‹åŠ¨è¿æ¥

å¦‚æœ mDNS æ— æ³•å·¥ä½œï¼Œå¯ä»¥æ‰‹åŠ¨è¿æ¥ï¼š

```
> /connect 5Q2STWvBBob... /ip4/192.168.1.101/udp/54321/quic-v1

æ­£åœ¨è¿æ¥...
âœ… è¿æ¥æˆåŠŸï¼
```

#### /help - å¸®åŠ©

æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤åŠå…¶è¯´æ˜ã€‚

#### /quit - é€€å‡º

ä¼˜é›…åœ°å…³é—­æ‰€æœ‰è¿æ¥å¹¶é€€å‡ºç¨‹åºã€‚

## å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|------|------|--------|------|
| `-nick` | è®¾ç½®æ˜µç§° | èŠ‚ç‚¹ ID å‰ 8 ä½ | `-nick Alice` |
| `-port` | ç›‘å¬ç«¯å£ | `0` (éšæœº) | `-port 4001` |
| `-realm` | Realm IDï¼ˆèŠå¤©å®¤éš”ç¦»ï¼‰ | `lan-chat` | `-realm my-room` |
| `-log-file` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆå°†ç»“æ„åŒ–æ—¥å¿—å†™å…¥æ–‡ä»¶ï¼‰ | ç©ºï¼ˆè¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰ | `-log-file chat.log` |

### ç¤ºä¾‹

```bash
# ä½¿ç”¨è‡ªå®šä¹‰æ˜µç§°
go run main.go -nick "Alice"

# ä½¿ç”¨å›ºå®šç«¯å£
go run main.go -nick "Bob" -port 5000

# å°†æ—¥å¿—å†™å…¥æ–‡ä»¶ï¼ˆæ¨èï¼Œé¿å…æ—¥å¿—å¹²æ‰°èŠå¤©ç•Œé¢ï¼‰
go run main.go -nick "Alice" -log-file chat.log

# ä½¿ç”¨è‡ªå®šä¹‰ Realmï¼ˆä¸åŒ Realm çš„èŠ‚ç‚¹ä»å¯èƒ½è¢«ç³»ç»Ÿå‘ç°ï¼Œä½†ä¸šåŠ¡è¿æ¥/ä¸šåŠ¡åè®®ä¼šè¢«éš”ç¦»ï¼‰
go run main.go -nick "Alice" -realm "room-1"
go run main.go -nick "Bob" -realm "room-1"  # åŒä¸€ Realmï¼Œå¯ä»¥äº’ç›¸å‘ç°

# é»˜è®¤ï¼ˆéšæœºç«¯å£ï¼Œè‡ªåŠ¨æ˜µç§°ï¼‰
go run main.go
```

## mDNS å·¥ä½œåŸç†

### å‘ç°æµç¨‹

```mermaid
sequenceDiagram
    participant A as Alice
    participant M as Multicast (224.0.0.251:5353)
    participant B as Bob
    
    Note over A: å¯åŠ¨èŠ‚ç‚¹
    A->>M: 1. å¹¿æ’­æœåŠ¡é€šå‘Š<br/>"_dep2p-chat._udp"
    
    Note over B: å¯åŠ¨èŠ‚ç‚¹  
    B->>M: 2. å¹¿æ’­æœåŠ¡é€šå‘Š<br/>"_dep2p-chat._udp"
    
    M->>A: 3. æ”¶åˆ° Bob çš„é€šå‘Š
    M->>B: 4. æ”¶åˆ° Alice çš„é€šå‘Š
    
    A->>B: 5. å»ºç«‹ P2P è¿æ¥
    Note over A,B: âœ… è¿æ¥å»ºç«‹
    
    A->>B: 6. å‘é€æ¶ˆæ¯
    B->>A: 7. å‘é€æ¶ˆæ¯
```

### æŠ€æœ¯ç»†èŠ‚

1. **æœåŠ¡æ³¨å†Œ**: èŠ‚ç‚¹å¯åŠ¨æ—¶æ³¨å†Œ mDNS æœåŠ¡
   ```
   æœåŠ¡å: _dep2p-chat._udp
   ç«¯å£: èŠ‚ç‚¹ç›‘å¬ç«¯å£
   TXT è®°å½•: èŠ‚ç‚¹ IDã€æ˜µç§°ç­‰
   ```

2. **å®šæœŸå¹¿æ’­**: æ¯éš”ä¸€æ®µæ—¶é—´é‡æ–°å¹¿æ’­ï¼ˆä¿æŒæ´»è·ƒï¼‰

3. **ç›‘å¬å“åº”**: æ¥æ”¶å…¶ä»–èŠ‚ç‚¹çš„å¹¿æ’­å¹¶è®°å½•

4. **å»ºç«‹è¿æ¥**: è·å–å¯¹æ–¹åœ°å€åå»ºç«‹ P2P è¿æ¥

5. **è¿æ¥ç»´æŠ¤**: å®šæœŸå¿ƒè·³ï¼Œæ–­çº¿é‡è¿

## ä»£ç è§£æ

### å…³é”®ä»£ç  1: mDNSï¼ˆåº•å±‚å¿…å¤‡èƒ½åŠ›ï¼Œæ— éœ€ç”¨æˆ·å¯ç”¨ï¼‰

```go
// v1.1+ï¼šmDNS æ˜¯åº•å±‚å¿…å¤‡èƒ½åŠ›ï¼Œé»˜è®¤å¼€å¯ã€‚
// ç”¨æˆ·åªéœ€è¦é€‰æ‹©é¢„è®¾ï¼Œä½¿ç”¨ StartNode ä¸€æ­¥å¯åŠ¨ï¼ˆQUIC ä¼ è¾“ï¼‰
node, err := dep2p.StartNode(ctx,
    dep2p.WithPreset(dep2p.PresetDesktop),
)
```

**è§£æ**:
- mDNS é»˜è®¤å¯ç”¨ï¼šæ— éœ€ `WithMDNS(true)` ä¹‹ç±»çš„å¼€å…³
- `PresetDesktop`: ä»…å†³å®šèµ„æº/å‚æ•°å€¾å‘ï¼Œä¸å½±å“â€œæ˜¯å¦å¯ç”¨â€åº•å±‚èƒ½åŠ›

### å…³é”®ä»£ç  2: æ³¨å†ŒèŠå¤©åè®®

```go
// è®¾ç½®åè®®å¤„ç†å™¨
node.SetProtocolHandler(chatProtocol, func(stream dep2p.Stream) {
    // æ¯ä¸ªè¿æ¥ä¼šè°ƒç”¨ä¸€æ¬¡
    handleChatStream(stream, nickname)
})
```

**è§£æ**:
- å½“å…¶ä»–èŠ‚ç‚¹è¿æ¥æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨
- æ¯ä¸ªå¯¹ç­‰æ–¹ä¸€ä¸ªç‹¬ç«‹çš„ goroutine
- æµä¿æŒæ‰“å¼€ï¼ŒæŒç»­æ¥æ”¶æ¶ˆæ¯

### å…³é”®ä»£ç  3: å¤„ç†å‘ç°äº‹ä»¶

```go
// mDNS ä¼šè‡ªåŠ¨è°ƒç”¨æ­¤å›è°ƒ
func onPeerDiscovered(peerInfo dep2p.PeerInfo) {
    fmt.Printf("ğŸ” å‘ç°æ–°èŠ‚ç‚¹: %s\n", peerInfo.ID)
    
    // è‡ªåŠ¨è¿æ¥ï¼ˆDialByNodeIDï¼‰
    conn, err := node.Connect(ctx, peerInfo.ID)
    if err == nil {
        fmt.Printf("ğŸ¤ å·²è¿æ¥åˆ°: %s\n", getNickname(peerInfo.ID))
    }
}
```

**è§£æ**:
- mDNS å‘ç°æ–°èŠ‚ç‚¹æ—¶è‡ªåŠ¨è°ƒç”¨
- ç«‹å³å°è¯•å»ºç«‹è¿æ¥
- å­˜å‚¨è¿æ¥ä»¥ä¾¿åç»­é€šä¿¡

### å…³é”®ä»£ç  4: å¹¿æ’­æ¶ˆæ¯

```go
func broadcastMessage(msg string) {
    peersLock.RLock()
    defer peersLock.RUnlock()
    
    // å‘æ‰€æœ‰å¯¹ç­‰æ–¹å‘é€
    for peerID, stream := range peers {
        stream.Write([]byte(msg))
    }
}
```

**è§£æ**:
- éå†æ‰€æœ‰æ´»è·ƒè¿æ¥
- å¹¶å‘å‘é€æ¶ˆæ¯
- ä½¿ç”¨é”ä¿è¯çº¿ç¨‹å®‰å…¨

## æ•…éšœæ’é™¤

### é—®é¢˜ 1: èŠ‚ç‚¹æ— æ³•äº’ç›¸å‘ç°

**ç—‡çŠ¶**: å¯åŠ¨ä¸¤ä¸ªèŠ‚ç‚¹åï¼Œæ²¡æœ‰çœ‹åˆ°"å‘ç°æ–°èŠ‚ç‚¹"çš„æ¶ˆæ¯ã€‚

**å¯èƒ½åŸå› å’Œè§£å†³æ–¹æ¡ˆ**:

#### åŸå›  1: ä¸åœ¨åŒä¸€ç½‘ç»œ

```bash
# æ£€æŸ¥ IP åœ°å€
# ç”µè„‘ A
ifconfig | grep "inet "
# è¾“å‡º: inet 192.168.1.100

# ç”µè„‘ B  
ifconfig | grep "inet "
# è¾“å‡º: inet 192.168.1.101

# âœ… å‰ä¸‰æ®µç›¸åŒ (192.168.1) = åŒä¸€ç½‘ç»œ
# âŒ ä¸åŒ = ä¸åœ¨åŒä¸€ç½‘ç»œ
```

**è§£å†³**: è¿æ¥åˆ°åŒä¸€ WiFi æˆ–è·¯ç”±å™¨ã€‚

#### åŸå›  2: é˜²ç«å¢™é˜»æ­¢

```bash
# macOS: ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > é˜²ç«å¢™
# å…è®¸ Go ç¨‹åºæ¥æ”¶è¿æ¥

# Linux: æ£€æŸ¥ iptables
sudo iptables -L | grep 5353

# ä¸´æ—¶å…³é—­é˜²ç«å¢™æµ‹è¯•ï¼ˆä»…ç”¨äºæ’æŸ¥ï¼‰
# æ³¨æ„ï¼šæµ‹è¯•å®Œè®°å¾—é‡æ–°å¼€å¯
```

#### åŸå›  3: ç½‘ç»œä¸æ”¯æŒå¤šæ’­

æŸäº›ä¼ä¸šç½‘ç»œæˆ–å…¬å…± WiFi ç¦ç”¨å¤šæ’­ã€‚

**æ£€æµ‹æ–¹æ³•**:

```bash
# æµ‹è¯•å¤šæ’­æ˜¯å¦å·¥ä½œ
# åœ¨ç”µè„‘ A è¿è¡Œ:
python3 -m http.server 8000

# åœ¨ç”µè„‘ B è®¿é—®:
curl http://192.168.1.100:8000

# å¦‚æœèƒ½è®¿é—®ï¼Œè¯´æ˜ç½‘ç»œå¯è¾¾ï¼Œé—®é¢˜åœ¨å¤šæ’­
```

**è§£å†³**: 
- ä½¿ç”¨æ”¯æŒå¤šæ’­çš„ç½‘ç»œ
- æˆ–ä½¿ç”¨ `/connect` å‘½ä»¤æ‰‹åŠ¨è¿æ¥

### é—®é¢˜ 2: è¿æ¥å»ºç«‹ä½†æ¶ˆæ¯ä¸æ˜¾ç¤º

**ç—‡çŠ¶**: çœ‹åˆ°"å·²è¿æ¥åˆ°..."ï¼Œä½†å‘é€æ¶ˆæ¯æ²¡æœ‰ååº”ã€‚

**å¯èƒ½åŸå› **:

1. **æµè¢«æ„å¤–å…³é—­**: æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
2. **ç¼–ç é—®é¢˜**: ç¡®ä¿ä½¿ç”¨ UTF-8
3. **ç¼“å†²åŒºé—®é¢˜**: æ¶ˆæ¯å¯èƒ½è¿˜åœ¨ç¼“å†²åŒº

**è§£å†³æ–¹æ¡ˆ**:

```go
// å‘é€ååˆ·æ–°ç¼“å†²åŒº
stream.Write([]byte(msg))
stream.Flush()  // å¦‚æœæœ‰æ­¤æ–¹æ³•
```

### é—®é¢˜ 3: Docker/è™šæ‹Ÿæœºç¯å¢ƒ

**ç—‡çŠ¶**: åœ¨ Docker å®¹å™¨æˆ–è™šæ‹Ÿæœºä¸­è¿è¡Œæ—¶ï¼ŒmDNS ä¸å·¥ä½œã€‚

**åŸå› **: è™šæ‹Ÿç½‘ç»œéš”ç¦»

**è§£å†³æ–¹æ¡ˆ**:

#### Docker
```bash
# ä½¿ç”¨ host ç½‘ç»œæ¨¡å¼
docker run --network host ...

# æˆ–æš´éœ² 5353 ç«¯å£ï¼ˆUDPï¼‰
docker run -p 5353:5353/udp ...
```

#### è™šæ‹Ÿæœº
- ä½¿ç”¨æ¡¥æ¥æ¨¡å¼ï¼ˆBridgedï¼‰ï¼Œä¸è¦ç”¨ NAT
- ç¡®ä¿è™šæ‹Ÿæœºåœ¨ä¸»æœºåŒä¸€ç½‘æ®µ

### é—®é¢˜ 4: å‘ç°å»¶è¿Ÿ

**ç—‡çŠ¶**: èŠ‚ç‚¹å¯åŠ¨åå¾ˆä¹…æ‰å‘ç°å¯¹æ–¹ã€‚

**è¿™æ˜¯æ­£å¸¸ç°è±¡**:
- mDNS é€šå‘Šé—´éš”é€šå¸¸æ˜¯ 5-10 ç§’
- é¦–æ¬¡å‘ç°å¯èƒ½éœ€è¦ 10-30 ç§’

**åŠ å¿«å‘ç°**:
- æ— éœ€æ“ä½œï¼Œè€å¿ƒç­‰å¾…
- æˆ–ä½¿ç”¨ `/connect` æ‰‹åŠ¨è¿æ¥

### é—®é¢˜ 5: æ˜µç§°åŒ…å«ç‰¹æ®Šå­—ç¬¦

**ç—‡çŠ¶**: æ˜µç§°ä¸­çš„ä¸­æ–‡æˆ–è¡¨æƒ…ç¬¦å·æ˜¾ç¤ºå¼‚å¸¸ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```bash
# ç¡®ä¿ç»ˆç«¯æ”¯æŒ UTF-8
# macOS/Linux é»˜è®¤æ”¯æŒ

# Windows éœ€è¦è®¾ç½®
chcp 65001  # åˆ‡æ¢åˆ° UTF-8
```

## è¿›é˜¶ç»ƒä¹ 

### ç»ƒä¹  1: æ·»åŠ ç§èŠåŠŸèƒ½

ä¿®æ”¹ä»£ç ï¼Œæ”¯æŒå‘é€æ¶ˆæ¯ç»™ç‰¹å®šç”¨æˆ·ï¼š

```go
// å‘½ä»¤æ ¼å¼: @Bob Hello!
if strings.HasPrefix(msg, "@") {
    parts := strings.SplitN(msg, " ", 2)
    targetNick := parts[0][1:]  // å»æ‰ @
    message := parts[1]
    
    // æŸ¥æ‰¾ç›®æ ‡èŠ‚ç‚¹å¹¶å‘é€
    sendToNick(targetNick, message)
}
```

### ç»ƒä¹  2: æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€

å®šæœŸå¹¿æ’­åœ¨çº¿çŠ¶æ€ï¼š

```go
// æ¯ 30 ç§’å‘é€å¿ƒè·³
ticker := time.NewTicker(30 * time.Second)
for range ticker.C {
    broadcastMessage("â¤ï¸ HEARTBEAT")
}
```

### ç»ƒä¹  3: æ¶ˆæ¯å†å²

ä¿å­˜èŠå¤©è®°å½•ï¼š

```go
var messageHistory []string

func saveMessage(msg string) {
    messageHistory = append(messageHistory, 
        fmt.Sprintf("[%s] %s", time.Now().Format("15:04:05"), msg))
}

// å‘½ä»¤: /history æŸ¥çœ‹å†å²
```

### ç»ƒä¹  4: æ–‡ä»¶å…±äº«

å®ç°ç®€å•çš„æ–‡ä»¶å‘é€ï¼š

```go
// å‘½ä»¤: /send file.txt
func sendFile(filename string) {
    data, _ := os.ReadFile(filename)
    // å‘é€æ–‡ä»¶å¤´
    stream.Write([]byte("FILE:" + filename + "\n"))
    // å‘é€æ–‡ä»¶å†…å®¹
    stream.Write(data)
}
```

### ç»ƒä¹  5: ç¾¤ç»„åŠŸèƒ½

æ”¯æŒåˆ›å»ºå¤šä¸ªèŠå¤©ç¾¤ç»„ï¼š

```go
// å‘½ä»¤: /join #general
// åªå‘åŒä¸€ç¾¤ç»„çš„èŠ‚ç‚¹å‘é€æ¶ˆæ¯
groups := map[string][]dep2p.PeerID{
    "#general": {...},
    "#tech": {...},
}
```

## ä¸ Echo ç¤ºä¾‹çš„å¯¹æ¯”

| ç‰¹æ€§ | Echo ç¤ºä¾‹ | Chat ç¤ºä¾‹ |
|------|----------|----------|
| **å‘ç°æ–¹å¼** | æ‰‹åŠ¨æŒ‡å®šåœ°å€ | mDNS è‡ªåŠ¨å‘ç° |
| **è¿æ¥æ¨¡å¼** | å•æ¬¡è¯·æ±‚-å“åº” | æŒä¹…è¿æ¥ |
| **é€šä¿¡æ–¹å‘** | å•å‘ï¼ˆæœ‰è¯·æ±‚æ‰æœ‰å“åº”ï¼‰ | åŒå‘ï¼ˆéšæ—¶å‘é€ï¼‰ |
| **èŠ‚ç‚¹æ•°é‡** | 2 ä¸ªï¼ˆ1 listener + 1 dialerï¼‰ | å¤šä¸ªï¼ˆè‡ªåŠ¨ç»„ç½‘ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å­¦ä¹ åŸºç¡€ã€ç®€å•æµ‹è¯• | å®é™…åº”ç”¨ã€å¤šæ–¹åä½œ |

## ä¸‹ä¸€æ­¥

å®Œæˆ Chat ç¤ºä¾‹åï¼Œç»§ç»­å­¦ä¹ ï¼š

1. **[Relay ç¤ºä¾‹](../relay/)** - å­¦ä¹ è·¨äº’è”ç½‘é€šä¿¡
2. **æ„å»ºè‡ªå·±çš„åº”ç”¨** - å‚è€ƒæ­¤ç¤ºä¾‹æ„å»ºå®ç”¨ç¨‹åº

## ç›¸å…³èµ„æº

- **mDNS å®ç°**: [internal/core/discovery/mdns/](../../internal/core/discovery/mdns/)
- **æœåŠ¡å‘ç°**: [docs/01-design/protocols/network/01-discovery.md](../../docs/01-design/protocols/network/01-discovery.md)
- **å¤šå¯¹ç­‰æ–¹é€šä¿¡**: [design/architecture/components.md](../../design/architecture/components.md)

## å‚è€ƒé¡¹ç›®

- [go-libp2p examples/chat-with-mdns](https://github.com/libp2p/go-libp2p)
- [mdns protocol spec](https://datatracker.ietf.org/doc/html/rfc6762)

---

ğŸ‰ **å¤ªæ£’äº†ï¼** ä½ å·²ç»æŒæ¡äº† mDNS è‡ªåŠ¨å‘ç°å’Œå¤šèŠ‚ç‚¹é€šä¿¡ï¼
