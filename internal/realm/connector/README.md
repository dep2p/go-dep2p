# Realm Connector - 仅 ID 连接

> **版本**: v1.0.0  
> **状态**: ✅ 已完成  
> **架构层**: Realm Layer

---

## 概述

`connector` 实现 Realm 内"仅 ID 连接"能力，用户只需提供 NodeID 即可连接 Realm 成员，系统自动完成地址解析和连接建立。

**核心功能**:
- 🔍 地址解析 - 多源自动解析目标地址
- 🔗 智能连接 - 直连 → 打洞 → Relay 保底
- ⚡ 零配置 - 仅需 NodeID 即可连接

---

## 快速开始

```go
import "github.com/dep2p/go-dep2p/internal/realm/connector"

// 通过 Realm 接口使用
conn, err := realm.Connect(ctx, targetNodeID)
if err != nil {
    log.Fatal(err)
}
defer conn.Close()

// 使用连接
stream, err := conn.NewStream(ctx)
```

---

## 核心组件

### AddressResolver（地址解析器）

多源地址解析器，按优先级解析目标地址。

**解析优先级**：
1. Peerstore 本地缓存（最快）
2. Relay 地址簿查询（网络请求）
3. 返回空（后续走 Relay 保底）

### Connector（连接器）

协调直连、打洞和 Relay 三级连接策略。

**连接优先级**：
1. **直连** - 有地址时直接连接
2. **打洞** - 直连失败时尝试 NAT 穿透
3. **Relay** - 保底方案，确保总是可达

---

## 连接流程

```
┌─────────────────────────────────────────────────┐
│  1. AddressResolver 解析目标地址                 │
│     - Peerstore 缓存查询                         │
│     - Relay 地址簿查询                          │
└─────────────────────┬───────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────┐
│  2. 尝试直连（如果有地址）                       │
└─────────────────────┬───────────────────────────┘
                      ▼ (失败)
┌─────────────────────────────────────────────────┐
│  3. 尝试 NAT 打洞                               │
└─────────────────────┬───────────────────────────┘
                      ▼ (失败)
┌─────────────────────────────────────────────────┐
│  4. Relay 保底中继                              │
└─────────────────────────────────────────────────┘
```

---

## 测试

```bash
go test -v ./internal/realm/connector/...
go test -cover ./internal/realm/connector/...
```

---

## 相关文档

- [doc.go](doc.go) - 包文档

---

**最后更新**: 2026-01-20
