# Liveness æ¨¡å—

> èŠ‚ç‚¹å­˜æ´»æ£€æµ‹æ¨¡å—ï¼Œå®ç°èŠ‚ç‚¹çŠ¶æ€æ£€æµ‹å’Œç½‘ç»œå¥åº·ç»´æŠ¤ã€‚

---

## æ¦‚è¿°

Liveness æ¨¡å—è´Ÿè´£æ£€æµ‹èŠ‚ç‚¹çŠ¶æ€ã€ç»´æŒå¿ƒè·³å’Œå¤„ç†ä¼˜é›…ä¸‹çº¿ï¼Œè§£å†³ P2P ç½‘ç»œä¸­"èŠ‚ç‚¹çŠ¶æ€ä¸ç¡®å®š"çš„æ ¸å¿ƒç—›ç‚¹ã€‚

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° | çŠ¶æ€ |
|------|------|------|
| çŠ¶æ€æ£€æµ‹ | Online/Degraded/Offline/Unknown | âœ… å·²å®ç° |
| å¿ƒè·³æœºåˆ¶ | å®šæœŸ Ping æ£€æµ‹ | âœ… å·²å®ç° |
| Goodbye åè®® | ä¼˜é›…ä¸‹çº¿é€šçŸ¥ | âœ… å·²å®ç° |
| å¥åº·è¯„åˆ† | èŠ‚ç‚¹å¥åº·åº¦é‡åŒ– | âœ… å·²å®ç° |
| çŠ¶æ€å˜æ›´é€šçŸ¥ | å›è°ƒæœºåˆ¶ | âœ… å·²å®ç° |

---

## æ¶æ„ä½ç½®

```
Layer 3: Serviceï¼ˆæœåŠ¡å±‚ï¼‰
â”œâ”€â”€ Livenessï¼ˆæœ¬æ¨¡å—ï¼‰
â”œâ”€â”€ Discoveryï¼ˆèŠ‚ç‚¹å‘ç°ï¼‰
â”œâ”€â”€ NATï¼ˆNAT ç©¿é€ï¼‰
â””â”€â”€ Relayï¼ˆä¸­ç»§æœåŠ¡ï¼‰
```

---

## æ–‡ä»¶ç»“æ„

```
internal/core/liveness/
â”œâ”€â”€ module.go      # fx æ¨¡å—å®šä¹‰
â”œâ”€â”€ service.go     # LivenessService å®ç°
â””â”€â”€ README.md      # æœ¬æ–‡æ¡£
```

---

## fx æ¨¡å—

### æä¾›

| æ¥å£ | å®ç° | æ ‡ç­¾ |
|------|------|------|
| `livenessif.LivenessService` | `*Service` | `name:"liveness"` |

### ä¾èµ–

| ä¾èµ– | è¯´æ˜ |
|------|------|
| `*config.Config` | é…ç½® |

---

## èŠ‚ç‚¹çŠ¶æ€æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       èŠ‚ç‚¹çŠ¶æ€æ¨¡å‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   ğŸŸ¢ ONLINEï¼ˆåœ¨çº¿ï¼‰                                                  â”‚
â”‚   â”œâ”€â”€ å¯è¿æ¥                                                        â”‚
â”‚   â”œâ”€â”€ å“åº”æ­£å¸¸ï¼ˆRTT < é˜ˆå€¼ï¼‰                                         â”‚
â”‚   â””â”€â”€ å¿ƒè·³æ­£å¸¸                                                       â”‚
â”‚                                                                      â”‚
â”‚   ğŸŸ¡ DEGRADEDï¼ˆé™çº§ï¼‰                                               â”‚
â”‚   â”œâ”€â”€ å¯è¿æ¥ä½†ä¸ç¨³å®š                                                 â”‚
â”‚   â”œâ”€â”€ å“åº”æ…¢ï¼ˆRTT > é˜ˆå€¼ï¼‰                                           â”‚
â”‚   â””â”€â”€ å¿ƒè·³å¶å°”ä¸¢å¤±                                                   â”‚
â”‚                                                                      â”‚
â”‚   ğŸ”´ OFFLINEï¼ˆç¦»çº¿ï¼‰                                                 â”‚
â”‚   â”œâ”€â”€ ä¸»åŠ¨ç¦»çº¿ï¼šæ”¶åˆ° Goodbye                                         â”‚
â”‚   â””â”€â”€ è¢«åŠ¨ç¦»çº¿ï¼šå¿ƒè·³è¶…æ—¶                                              â”‚
â”‚                                                                      â”‚
â”‚   âš« UNKNOWNï¼ˆæœªçŸ¥ï¼‰                                                 â”‚
â”‚   â””â”€â”€ ä»æœªè¿æ¥è¿‡                                                     â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é…ç½®

```go
type LivenessConfig struct {
    Enable               bool          // å¯ç”¨å­˜æ´»æ£€æµ‹
    HeartbeatInterval    time.Duration // å¿ƒè·³é—´éš”ï¼ˆé»˜è®¤ 15sï¼‰
    HeartbeatTimeout     time.Duration // å¿ƒè·³è¶…æ—¶ï¼ˆé»˜è®¤ 45sï¼‰
    DegradedRTTThreshold time.Duration // é™çº§ RTT é˜ˆå€¼ï¼ˆé»˜è®¤ 500msï¼‰
    StatusExpiry         time.Duration // çŠ¶æ€è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 5minï¼‰
    EnableGoodbye        bool          // å¯ç”¨ Goodbye åè®®
    MaxConcurrentPings   int           // æœ€å¤§å¹¶å‘ Ping æ•°
}
```

---

## åè®® ID

| åè®® | ID | è¯´æ˜ |
|------|-----|------|
| Ping | `/dep2p/ping/1.0` | å¿ƒè·³æ£€æµ‹ |
| Goodbye | `/dep2p/goodbye/1.0` | ä¼˜é›…ä¸‹çº¿ |
| Heartbeat | `/dep2p/heartbeat/1.0` | å¿ƒè·³ç»´æŒ |

---

## è®¾è®¡æ–‡æ¡£

- [èŠ‚ç‚¹å­˜æ´»åè®®è§„èŒƒ](../../../docs/01-design/protocols/application/01-node-liveness.md)
- [æ¶æ„å±‚æ¬¡](../../../docs/01-design/architecture/layers.md)

---

## å®ç°çŠ¶æ€

**å·²å®Œæ•´å®ç°**ï¼ˆ765 è¡Œä»£ç ï¼‰ï¼š

1. âœ… **Ping ç½‘ç»œé€šä¿¡**ï¼šé€šè¿‡ Endpoint å‘é€/æ¥æ”¶ Ping æ¶ˆæ¯
2. âœ… **Goodbye åè®®**ï¼šSendGoodbye/SendGoodbyeTo å‘èŠ‚ç‚¹å‘é€ä¸‹çº¿é€šçŸ¥
3. âœ… **å¿ƒè·³æœºåˆ¶**ï¼šStartHeartbeat/StopHeartbeat å®šæœŸæ£€æµ‹èŠ‚ç‚¹çŠ¶æ€
4. âœ… **å¥åº·è¯„åˆ†**ï¼šåŸºäº RTT å’ŒæˆåŠŸç‡çš„è¯„åˆ†ã€è¡°å‡ã€æ¢å¤é€»è¾‘
5. âœ… **çŠ¶æ€å˜æ›´é€šçŸ¥**ï¼šå›è°ƒæœºåˆ¶é€šçŸ¥è®¢é˜…è€…çŠ¶æ€å˜åŒ–

### ä¸»è¦å‡½æ•°

| å‡½æ•° | è¡Œå· | åŠŸèƒ½ |
|------|-----|------|
| `Ping()` | 165-225 | å‘é€ Ping å¹¶æµ‹é‡ RTT |
| `handlePingStream()` | 228-240 | å¤„ç†å…¥ç«™ Ping è¯·æ±‚ |
| `updatePingSuccess()` | 242-288 | æ›´æ–°æˆåŠŸ Ping åçš„çŠ¶æ€ |
| `handlePingFailure()` | 290-328 | å¤„ç† Ping å¤±è´¥ |
| `SendGoodbye()` | 330-350 | å‘æ‰€æœ‰è¿æ¥èŠ‚ç‚¹å‘é€ Goodbye |
| `SendGoodbyeTo()` | 353-430 | å‘æŒ‡å®šèŠ‚ç‚¹å‘é€ Goodbye |
| `handleGoodbyeStream()` | 432-447 | å¤„ç†å…¥ç«™ Goodbye |
| `StartHeartbeat()` | 449-520 | å¯åŠ¨å¿ƒè·³å¾ªç¯ |
| `StopHeartbeat()` | 522-540 | åœæ­¢å¿ƒè·³å¾ªç¯ |
| `heartbeatLoop()` | 542-575 | å¿ƒè·³ä¸»å¾ªç¯ |

