# internal - 内部实现

> DeP2P 核心实现代码，采用五层架构组织

---

## 五层架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DeP2P 五层架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ╔═══════════════════════════════════════════════════════════════════════╗  │
│  ║  API Layer (根目录)                                                   ║  │
│  ║  面向应用开发者的入口                                                  ║  │
│  ║  ┌────────┐ ┌─────────┐ ┌────────┐                                   ║  │
│  ║  │  Node  │ │ Options │ │ Config │                                   ║  │
│  ║  └────────┘ └─────────┘ └────────┘                                   ║  │
│  ╚═══════════════════════════════════════════════════════════════════════╝  │
│                                        ↓                                    │
│  ╔═══════════════════════════════════════════════════════════════════════╗  │
│  ║  Protocol Layer (internal/protocol/)                                  ║  │
│  ║  面向应用的通信服务                                                    ║  │
│  ║  ┌─────────┐ ┌────────┐ ┌─────────┐ ┌────────┐                       ║  │
│  ║  │Messaging│ │ PubSub │ │ Streams │ │Liveness│                       ║  │
│  ║  └─────────┘ └────────┘ └─────────┘ └────────┘                       ║  │
│  ╚═══════════════════════════════════════════════════════════════════════╝  │
│                                        ↓                                    │
│  ╔═══════════════════════════════════════════════════════════════════════╗  │
│  ║  Realm Layer (internal/realm/)                                        ║  │
│  ║  业务隔离与成员管理                                                    ║  │
│  ║  ┌──────┐ ┌────────┐ ┌─────────┐ ┌─────────┐                         ║  │
│  ║  │ Auth │ │ Member │ │ Routing │ │ Gateway │                         ║  │
│  ║  └──────┘ └────────┘ └─────────┘ └─────────┘                         ║  │
│  ╚═══════════════════════════════════════════════════════════════════════╝  │
│                                        ↓                                    │
│  ╔═══════════════════════════════════════════════════════════════════════╗  │
│  ║  Core Layer (internal/core/)                                          ║  │
│  ║  P2P 网络核心能力                                                      ║  │
│  ║  ┌──────┐ ┌──────────┐ ┌───────────┐ ┌──────────┐ ┌───────┐          ║  │
│  ║  │ Host │ │ Identity │ │ Transport │ │ Security │ │ Muxer │          ║  │
│  ║  └──────┘ └──────────┘ └───────────┘ └──────────┘ └───────┘          ║  │
│  ║  ┌─────────┐ ┌───────┐ ┌─────┐ ┌───────────┐ ┌──────────┐            ║  │
│  ║  │ ConnMgr │ │ Relay │ │ NAT │ │ Peerstore │ │ EventBus │            ║  │
│  ║  └─────────┘ └───────┘ └─────┘ └───────────┘ └──────────┘            ║  │
│  ╚═══════════════════════════════════════════════════════════════════════╝  │
│                                        ↕                                    │
│  ╔═══════════════════════════════════════════════════════════════════════╗  │
│  ║  Discovery Layer (internal/discovery/)                                ║  │
│  ║  节点发现与广播                                                        ║  │
│  ║  ┌────────────┐ ┌───────────┐ ┌────────┐ ┌────────────┐ ┌─────┐      ║  │
│  ║  │Coordinator │ │ Bootstrap │ │  mDNS  │ │ Rendezvous │ │ DHT │      ║  │
│  ║  └────────────┘ └───────────┘ └────────┘ └────────────┘ └─────┘      ║  │
│  ╚═══════════════════════════════════════════════════════════════════════╝  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 目录结构

```
internal/
│
├── protocol/              # Protocol Layer - 协议层
│   ├── messaging/        # 点对点消息服务
│   ├── pubsub/           # 发布订阅（GossipSub）
│   ├── streams/          # 流管理服务
│   └── liveness/         # 存活检测（Ping）
│
├── realm/                 # Realm Layer - 业务隔离层
│   ├── auth/             # 成员认证（PSK/Cert）
│   ├── member/           # 成员管理
│   ├── routing/          # 域内路由
│   ├── gateway/          # 域网关（Realm 内部中继）
│   ├── services/         # 服务门面
│   └── protocol/         # 内部协议
│
├── core/                  # Core Layer - 核心层
│   ├── host/             # 网络主机（门面）
│   ├── identity/         # 身份管理（Ed25519）
│   ├── transport/        # 传输层（QUIC/TCP）
│   ├── security/         # 安全层（TLS/Noise）
│   ├── muxer/            # 多路复用（Yamux）
│   ├── swarm/            # 连接群管理
│   ├── connmgr/          # 连接管理
│   ├── relay/            # 中继服务（统一 Relay）
│   ├── nat/              # NAT 穿透
│   ├── peerstore/        # 节点信息存储
│   ├── eventbus/         # 事件总线
│   ├── metrics/          # 监控指标
│   ├── resourcemgr/      # 资源管理
│   ├── upgrader/         # 连接升级
│   └── protocol/         # 协议路由
│
├── discovery/             # Discovery Layer - 发现层
│   ├── coordinator/      # 发现协调器
│   ├── bootstrap/        # 引导节点发现
│   ├── dht/              # DHT 分布式哈希表
│   ├── mdns/             # 局域网发现
│   ├── dns/              # DNS 发现
│   └── rendezvous/       # 命名空间发现
│
└── util/                  # 内部工具
```

---

## 层职责

| 层 | 职责 | 主要组件 |
|----|------|----------|
| **API** | 用户入口（在根目录） | Node, Options, Config |
| **Protocol** | 面向应用的通信服务 | Messaging, PubSub, Streams, Liveness |
| **Realm** | 业务隔离、成员认证 | Auth, Member, Routing, Gateway |
| **Core** | P2P 网络核心能力 | Host, Identity, Transport, Security, Muxer, ConnMgr, Relay, NAT |
| **Discovery** | 节点发现与路由 | Coordinator, Bootstrap, DHT, mDNS, Rendezvous |

---

## 依赖方向

```
API → Protocol → Realm → Core ↔ Discovery
```

- **API** 依赖 Protocol、Realm、Core
- **Protocol** 依赖 Realm、Core
- **Realm** 依赖 Core
- **Core** 与 **Discovery** 双向协作
- 禁止反向依赖

---

## 横切关注点

横切关注点**不在 internal/ 中**，而是：

| 关注点 | 位置 | 说明 |
|--------|------|------|
| **配置** | `config/` (根目录) | 独立于层架构 |
| **日志** | 直接使用 `log/slog` | 不抽象接口 |
| **指标** | `internal/core/metrics/` | 带宽统计 |

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [五层架构](../design/03_architecture/L1_overview/domain_map.md) | 架构设计 |
| [目标结构](../design/03_architecture/L2_structural/target_structure.md) | 目标目录结构 |
| [依赖规则](../design/03_architecture/L2_structural/dependency_rules.md) | 依赖规则 |
| [pkg/interfaces/](../pkg/interfaces/) | 公共接口定义 |
| [pkg/types/](../pkg/types/) | 公共类型定义 |

---

**最后更新**: 2026-01-15
